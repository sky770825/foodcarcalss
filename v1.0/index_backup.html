<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>æ¥Šæ¢…é¤è»Šæ’ç­å ±åç³»çµ± v3.2</title>


<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Microsoft JhengHei",sans-serif;line-height:1.6;color:#333;background:linear-gradient(135deg,#f8f9fa,#e9ecef);}
a{text-decoration:none;color:inherit;}

/* Hero å€å¡Š */
.hero{
  background:linear-gradient(135deg,#FF8A00,#FF4B2B);
  color:white;text-align:center;padding:50px 20px;
  position:relative;overflow:hidden;min-height:30vh;
}
.hero::before{
  content:'';position:absolute;top:0;left:0;right:0;bottom:0;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  opacity:0.3;animation:float 20s ease-in-out infinite;
}
@keyframes float{
  0%,100%{transform:translateY(0px) rotate(0deg);}
  50%{transform:translateY(-10px) rotate(1deg);}
}
.hero-content{position:relative;z-index:1;}
.hero h1{font-size:2rem;margin-bottom:12px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
.hero p{font-size:1rem;margin-bottom:20px;opacity:0.95;}
.hero button{
  background:white;color:#FF4B2B;padding:12px 28px;
  border:none;border-radius:30px;font-size:1rem;font-weight:bold;
  cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(0,0,0,0.2);
}
.hero button:hover{background:#ffe1d1;transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3);}

/* å¿«é€Ÿé€£çµç¶²æ ¼ */
.quick-links-grid{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:10px;
  margin-top:20px;
  max-width:750px;
  margin-left:auto;
  margin-right:auto;
}

.quick-link-btn{
  background:rgba(255, 255, 255, 0.98);
  color:#2c3e50;
  padding:10px 8px;
  border:2px solid rgba(255, 255, 255, 0.8);
  border-radius:10px;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  transition:all .3s;
  box-shadow:0 3px 12px rgba(0,0,0,0.15);
  text-decoration:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  text-align:center;
}

.quick-link-btn i{
  font-size:1.5rem;
  margin-bottom:3px;
  color:#3498db;
}

.quick-link-btn span{
  font-size:0.75rem;
  line-height:1.2;
  color:#2c3e50;
}

.quick-link-btn:hover{
  background:white;
  transform:translateY(-3px);
  box-shadow:0 8px 25px rgba(0,0,0,0.3);
  border-color:white;
}

.quick-link-btn:hover i{
  color:#2980b9;
}

.quick-link-btn:hover span{
  color:#34495e;
}

.quick-link-btn:active{
  transform:translateY(-1px);
}

/* ä¸»å…§å®¹ */
.container{max-width:1200px;margin:30px auto;padding:0 20px;}
.card{
  background:white;padding:20px;border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,.08);margin-bottom:25px;
  border:1px solid rgba(255,139,0,0.1);
}
h2.section-title{
  margin-bottom:18px;text-align:center;color:#FF4B2B;
  font-size:1.5rem;position:relative;
}
h2.section-title::after{
  content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
  width:60px;height:3px;background:linear-gradient(90deg,#FF8A00,#FF4B2B);
  border-radius:2px;
}

/* å ´åœ°åˆ†é  */
.location-tabs{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;margin-bottom:18px;
}
.location-tab{
  background:white;border:2px solid #e9ecef;border-radius:8px;
  padding:10px;text-align:center;cursor:pointer;transition:all .3s;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  position:relative;overflow:hidden;
}
.location-tab::before{
  content:'';position:absolute;top:0;left:-100%;
  width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
  transition:left 0.5s;
}
.location-tab:hover::before{left:100%;}
.location-tab:hover{
  border-color:#FF8A00;transform:translateY(-2px);
  box-shadow:0 4px 15px rgba(255,139,0,0.2);
}
.location-tab.active{
  background:linear-gradient(135deg,#FF8A00,#FF4B2B);
  color:white;border-color:#FF4B2B;
  box-shadow:0 4px 15px rgba(255,75,43,0.4);
  transform:scale(1.02);
}
.location-tab i{font-size:1.3rem;margin-bottom:4px;}
.location-tab span{font-weight:bold;font-size:0.9rem;}
.location-tab small{font-size:0.75rem;opacity:0.8;}

/* å ´åœ°è³‡è¨Šå¡ç‰‡ */
.location-info{
  background:linear-gradient(135deg,#fff5f0,#ffe8e0);
  border-left:4px solid #FF8A00;padding:15px;margin-bottom:18px;
  border-radius:8px;transition:all .3s;
}
.location-info h3{color:#FF4B2B;margin-bottom:12px;font-size:1.1rem;}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;}
.info-item{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:0.9rem;
}
.info-item i{
  color:#FF8A00;
  width:18px;
  font-size:0.95rem;
}

/* è¡¨å–®æ¨£å¼ */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;}
label{display:block;margin-top:15px;font-weight:bold;color:#555;font-size:0.95rem;}
input,select,textarea{
  width:100%;padding:10px;margin-top:6px;
  border:2px solid #e9ecef;border-radius:6px;font-size:0.95rem;
  transition:border-color .3s,box-shadow .3s;
}
input:focus,select:focus,textarea:focus{
  outline:none;border-color:#FF8A00;box-shadow:0 0 0 3px rgba(255,139,0,0.1);
}

/* æ—¥æœŸé¸æ“‡æ¨£å¼ */
.date-selection{
  display:flex;gap:10px;align-items:center;
}
.date-info{
  background:#e3f2fd;border:1px solid #2196f3;border-radius:6px;
  padding:8px 12px;margin-top:5px;
}
.date-info small{color:#1976d2;font-size:0.85rem;}

/* å ´åœ°è²»å›ºå®šæ¬„ä½æ¨£å¼ */
.fee-input-group {
  position: relative;
}

.fee-input-group input {
  background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
  color: #2e7d32;
  font-weight: bold;
  cursor: not-allowed;
  border: 2px solid #4caf50;
}

.fee-input-group i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #2e7d32;
  font-size: 1rem;
}

.fee-input-group input {
  padding-left: 35px;
}

/* ç‰¹æ®Šæç¤ºæ¨£å¼ */
.special-notice{
  background:#fff3cd;border:1px solid #ffeaa7;border-radius:6px;
  padding:10px 12px;margin:10px 0;display:flex;align-items:center;
  gap:8px;
}
.special-notice i{
  color:#856404;font-size:1.1rem;
}
.special-notice span{
  color:#856404;font-weight:600;font-size:0.9rem;
}

button.submit{
  background:linear-gradient(135deg,#FF4B2B,#FF8A00);color:white;border:none;
  margin-top:20px;padding:12px 25px;font-size:1rem;font-weight:bold;
  border-radius:8px;cursor:pointer;transition:all .3s;
  box-shadow:0 4px 15px rgba(255,75,43,0.3);
}
button.submit:hover{
  transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,75,43,0.4);
}

/* æ³¨æ„äº‹é … */
.notice-box{
  background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;
  padding:12px 15px;margin-top:18px;
}
.notice-box h4{
  color:#856404;
  margin-bottom:8px;
  font-size:1rem;
}
.notice-box ul{
  color:#856404;
  padding-left:20px;
  font-size:0.9rem;
  line-height:1.5;
}
.notice-box li{
  margin-bottom:4px;
}

/* æ—¥æ›†æ§åˆ¶å™¨ */
.calendar-controls{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:20px;padding:15px;background:#f8f9fa;
  border-radius:10px;flex-wrap:wrap;gap:15px;
}
.month-navigation{
  display:flex;align-items:center;gap:10px;
}
.nav-btn{
  padding:8px 12px;border:2px solid #e9ecef;background:white;
  border-radius:6px;cursor:pointer;transition:all .3s;
  display:flex;align-items:center;justify-content:center;
  min-width:40px;height:40px;
}
.nav-btn:hover{
  border-color:#FF8A00;background:#fff5f0;
}
.today-btn{
  padding:8px 15px;min-width:auto;
  background:#FF8A00;color:white;border-color:#FF8A00;
}
.today-btn:hover{
  background:#FF4B2B;border-color:#FF4B2B;
}
.month-display{
  padding:8px 15px;background:white;border:2px solid #e9ecef;
  border-radius:6px;font-weight:bold;color:#555;
  min-width:120px;text-align:center;
}
.filter-section{
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.filter-section label{font-weight:bold;color:#555;margin:0;}
.location-filters{
  display:flex;gap:5px;flex-wrap:wrap;
}
.filter-btn{
  padding:6px 12px;border:2px solid #e9ecef;background:white;
  border-radius:20px;cursor:pointer;transition:all .3s;
  display:flex;align-items:center;gap:5px;font-size:0.9rem;
  white-space:nowrap;
}
.filter-btn:hover{
  border-color:#FF8A00;background:#fff5f0;
}
.filter-btn.active{
  background:#FF8A00;color:white;border-color:#FF8A00;
}
.view-toggle{
  display:flex;gap:5px;
}
.view-btn{
  padding:8px 15px;border:2px solid #e9ecef;background:white;
  border-radius:6px;cursor:pointer;transition:all .3s;
  display:flex;align-items:center;gap:5px;
}
.view-btn:hover{border-color:#FF8A00;}
.view-btn.active{
  background:#FF8A00;color:white;border-color:#FF8A00;
}

/* æ–°è¡Œäº‹æ›†æ¨£å¼ */
.calendar-container {
  background: white;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 12px;
}

.calendar-nav {
  display: flex;
  align-items: center;
  gap: 10px;
}

.nav-btn, .today-btn {
  background: #FF8A00;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.85rem;
}

.nav-btn:hover, .today-btn:hover {
  background: #e67e00;
  transform: translateY(-1px);
}

.today-btn {
  background: #28a745;
}

.today-btn:hover {
  background: #218838;
}

.month-display {
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  min-width: 100px;
  text-align: center;
}

.location-filter {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.location-filter label {
  font-weight: bold;
  color: #333;
  white-space: nowrap;
}

.location-filter-buttons {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
}

.location-filter .filter-btn {
  padding: 8px 10px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  white-space: normal;
  min-width: 0;
  min-height: 36px;
  line-height: 1.3;
  text-align: center;
  word-break: keep-all;
}

.location-filter .filter-btn i {
  font-size: 0.85rem;
  flex-shrink: 0;
}

.location-filter .filter-btn:hover {
  border-color: #FF8A00;
  background: #fff5f0;
  transform: translateY(-1px);
}

.location-filter .filter-btn.active {
  background: #FF8A00;
  border-color: #FF8A00;
  color: white;
}

.location-filter .filter-btn.active:hover {
  background: #e67a00;
  border-color: #e67a00;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #e0e0e0;
  border-radius: 8px;
  overflow: hidden;
}

.calendar-day-header {
  background: #f8f9fa;
  padding: 8px 6px;
  text-align: center;
  font-weight: bold;
  color: #333;
  font-size: 0.8rem;
}

.calendar-day {
  background: white;
  min-height: 85px;
  padding: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.calendar-day:hover {
  background: #f8f9fa;
}

.calendar-day.today {
  background: #fff3cd;
  border: 2px solid #ffc107;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #999;
}

.calendar-day.booked {
  background: #f5f5f5;
  color: #999;
  cursor: not-allowed;
}

.calendar-day.booked::after {
  content: 'ğŸš«';
  position: absolute;
  bottom: 2px;
  right: 2px;
  font-size: 0.8rem;
  opacity: 0.8;
}

.calendar-day.non-operating {
  background: #ffe6e6;
  color: #cc0000;
  cursor: not-allowed;
  position: relative;
}

.calendar-day.non-operating::after {
  content: 'âŒ';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.2rem;
  opacity: 0.8;
}

.calendar-day.past-date {
  background: #f8f9fa;
  color: #6c757d;
  opacity: 0.7;
}

.calendar-day.past-date .event-item {
  background: #6c757d;
  opacity: 0.8;
}

.day-number {
  font-weight: bold;
  margin-bottom: 2px;
  font-size: clamp(0.75rem, 1.2vw, 0.9rem);
  padding-top: 2px;
}

.day-events {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.event-item {
  background: #FF8A00;
  color: white;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: clamp(0.6rem, 1vw, 0.75rem);
  cursor: pointer;
  transition: all 0.3s;
}

.event-item:hover {
  background: #e67e00;
  transform: scale(1.05);
}

/* äº‹ä»¶å®¹å™¨å’Œå–æ¶ˆæŒ‰éˆ• */
.event-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 4px;
  margin-bottom: 2px;
  position: relative;
}

.cancel-btn {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  font-size: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: absolute;
  top: -2px;
  right: -2px;
  transition: all 0.3s;
  flex-shrink: 0;
  z-index: 10;
}

.cancel-btn:hover {
  background: #c82333;
  transform: scale(1.1);
}



/* å ´åœ°ç¸®åœ– */
.location-thumbnail{
  width:100%;height:90px;object-fit:cover;
  border-radius:6px;cursor:pointer;transition:transform .3s;
  margin-top:6px;
}
.location-thumbnail:hover{transform:scale(1.05);}

/* Toast æç¤ºç³»çµ± */
.toast-container{
  position:fixed;top:20px;right:20px;z-index:9999;
}
.toast{
  background:white;border-left:4px solid #28a745;
  border-radius:8px;padding:15px 20px;margin-bottom:10px;
  box-shadow:0 4px 15px rgba(0,0,0,0.2);
  transform:translateX(100%);opacity:0;
  transition:all .3s ease;
  min-width:300px;
}
.toast.show{
  transform:translateX(0);opacity:1;
}
.toast.error{border-left-color:#dc3545;}
.toast.warning{border-left-color:#ffc107;}
.toast.info{border-left-color:#17a2b8;}
.toast-header{
  display:flex;align-items:center;margin-bottom:5px;
}
.toast-icon{
  font-size:1.2rem;margin-right:8px;
}
.toast.success .toast-icon{color:#28a745;}
.toast.error .toast-icon{color:#dc3545;}
.toast.warning .toast-icon{color:#ffc107;}
.toast.info .toast-icon{color:#17a2b8;}
.toast-title{
  font-weight:bold;font-size:1rem;
}
.toast-message{
  font-size:0.9rem;color:#666;white-space:pre-line;
}

/* åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† */
.image-modal{
  display:none;position:fixed;z-index:1000;left:0;top:0;
  width:100%;height:100%;background:rgba(0,0,0,0.8);
  justify-content:center;align-items:center;
}
.image-modal.active{display:flex;}
.modal-content{
  max-width:90%;max-height:90%;object-fit:contain;
  border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.5);
}
.modal-close{
  position:absolute;top:20px;right:30px;color:white;
  font-size:40px;font-weight:bold;cursor:pointer;
  z-index:1001;
}
.modal-close:hover{color:#FF8A00;}

/* ç¹³è²»å½ˆçª—æ¨£å¼ */
.payment-modal{
  display:none;position:fixed;z-index:2000;left:0;top:0;
  width:100%;height:100%;background:rgba(0,0,0,0.8);
  justify-content:center;align-items:center;
}
.payment-modal.active{display:flex;}
.payment-modal-content{
  background:white;border-radius:15px;padding:0;
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  max-width:500px;width:90%;max-height:80vh;overflow-y:auto;
  position:relative;
}
.payment-header{
  background:linear-gradient(135deg,#FF8A00,#FF4B2B);
  color:white;padding:20px;border-radius:15px 15px 0 0;
  display:flex;justify-content:space-between;align-items:center;
}
.payment-header h3{
  margin:0;font-size:1.3rem;display:flex;align-items:center;gap:10px;
}
.payment-header .modal-close{
  position:static;color:white;font-size:24px;cursor:pointer;
  padding:5px;border-radius:50%;transition:background .3s;
}
.payment-header .modal-close:hover{
  background:rgba(255,255,255,0.2);
}
.payment-body{
  padding:30px;
}
.payment-info{
  text-align:center;margin-bottom:25px;
}
.payment-info p{
  margin:5px 0;font-size:1.1rem;
}
.payment-buttons{
  display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:25px;
}
.payment-btn{
  display:flex;align-items:center;gap:15px;
  padding:15px 20px;border:none;border-radius:10px;
  font-size:1.1rem;font-weight:bold;cursor:pointer;
  transition:all .3s;text-align:left;
}
.jkopay-btn{
  background:linear-gradient(135deg,#00D4AA,#00B894);
  color:white;
}
.jkopay-btn:hover{
  background:linear-gradient(135deg,#00B894,#00A085);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(0,212,170,0.3);
}
.linepay-btn{
  background:linear-gradient(135deg,#00C300,#00A000);
  color:white;
}
.linepay-btn:hover{
  background:linear-gradient(135deg,#00A000,#008000);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(0,195,0,0.3);
}
.bank-btn{
  background:linear-gradient(135deg,#6C5CE7,#5A4FCF);
  color:white;
}
.bank-btn:hover{
  background:linear-gradient(135deg,#5A4FCF,#4A3FB8);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(108,92,231,0.3);
}
.payment-btn i{
  font-size:1.5rem;
}
.payment-notice{
  background:#e3f2fd;border:1px solid #2196f3;
  border-radius:8px;padding:15px;text-align:center;
}
.payment-notice p{
  margin:0;color:#1976d2;font-size:0.9rem;
  display:flex;align-items:center;justify-content:center;gap:8px;
}

/* éŠ€è¡Œè½‰å¸³å½ˆçª—æ¨£å¼ */
.bank-modal{
  display:none;position:fixed;z-index:3000;left:0;top:0;
  width:100%;height:100%;background:rgba(0,0,0,0.8);
  justify-content:center;align-items:center;
}
.bank-modal.active{display:flex;}
.bank-modal-content{
  background:white;border-radius:15px;padding:0;
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  max-width:450px;width:90%;max-height:80vh;overflow-y:auto;
  position:relative;
}
.bank-header{
  background:linear-gradient(135deg,#6C5CE7,#5A4FCF);
  color:white;padding:20px;border-radius:15px 15px 0 0;
  display:flex;justify-content:space-between;align-items:center;
}
.bank-header h3{
  margin:0;font-size:1.3rem;display:flex;align-items:center;gap:10px;
}
.bank-header .modal-close{
  position:static;color:white;font-size:24px;cursor:pointer;
  padding:5px;border-radius:50%;transition:background .3s;
}
.bank-header .modal-close:hover{
  background:rgba(255,255,255,0.2);
}
.bank-body{
  padding:30px;
}
.bank-info{
  margin-bottom:25px;
}
.bank-item{
  display:flex;align-items:center;margin-bottom:15px;
  padding:10px;background:#f8f9fa;border-radius:8px;
}
.bank-item label{
  font-weight:bold;color:#555;min-width:80px;margin:0;
}
.bank-item span{
  color:#333;font-size:1rem;
}
.account-number{
  display:flex;align-items:center;gap:10px;flex:1;
}
.account-number span{
  background:white;padding:8px 12px;border:2px solid #e9ecef;
  border-radius:6px;font-family:monospace;font-size:1.1rem;
  color:#333;flex:1;
}
.copy-btn{
  background:#28a745;color:white;border:none;
  padding:8px 12px;border-radius:6px;cursor:pointer;
  font-size:0.9rem;transition:all .3s;
  display:flex;align-items:center;gap:5px;
}
.copy-btn:hover{
  background:#218838;transform:translateY(-1px);
}
.bank-amount{
  display:flex;align-items:center;margin-bottom:15px;
  padding:15px;background:linear-gradient(135deg,#fff3cd,#ffeaa7);
  border:1px solid #ffc107;border-radius:8px;
}
.bank-amount label{
  font-weight:bold;color:#856404;min-width:80px;margin:0;
}
.bank-amount .amount{
  color:#856404;font-size:1.2rem;font-weight:bold;
}
.bank-notice{
  background:#e3f2fd;border:1px solid #2196f3;
  border-radius:8px;padding:15px;text-align:center;
}
.bank-notice p{
  margin:0 0 15px 0;color:#1976d2;font-size:0.9rem;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.official-account-btn{
  background:linear-gradient(135deg,#00C300,#00A000);
  color:white;border:none;padding:12px 20px;
  border-radius:8px;cursor:pointer;font-size:1rem;
  font-weight:bold;transition:all .3s;
  display:flex;align-items:center;gap:8px;margin:0 auto;
}
.official-account-btn:hover{
  background:linear-gradient(135deg,#00A000,#008000);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(0,195,0,0.3);
}

/* å–æ¶ˆé ç´„å½ˆçª—æ¨£å¼ */
.cancel-modal{
  display:none;position:fixed;z-index:4000;left:0;top:0;
  width:100%;height:100%;background:rgba(0,0,0,0.8);
  justify-content:center;align-items:center;
}
.cancel-modal.active{display:flex;}
.cancel-modal-content{
  background:white;border-radius:15px;padding:0;
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  max-width:500px;width:90%;max-height:80vh;overflow-y:auto;
  position:relative;
}
.cancel-header{
  background:linear-gradient(135deg,#dc3545,#c82333);
  color:white;padding:20px;border-radius:15px 15px 0 0;
  display:flex;justify-content:space-between;align-items:center;
}
.cancel-header h3{
  margin:0;font-size:1.3rem;display:flex;align-items:center;gap:10px;
}
.cancel-header .modal-close{
  position:static;color:white;font-size:24px;cursor:pointer;
  padding:5px;border-radius:50%;transition:background .3s;
}
.cancel-header .modal-close:hover{
  background:rgba(255,255,255,0.2);
}
.cancel-body{
  padding:30px;
}
.booking-details{
  background:#f8f9fa;border:1px solid #e9ecef;
  border-radius:10px;padding:20px;margin-bottom:25px;
}
.booking-details h4{
  color:#dc3545;margin:0 0 15px 0;font-size:1.1rem;
  display:flex;align-items:center;gap:8px;
}
.detail-item{
  display:flex;align-items:center;margin-bottom:10px;
  padding:8px 0;border-bottom:1px solid #e9ecef;
}
.detail-item:last-child{
  border-bottom:none;margin-bottom:0;
}
.detail-item label{
  font-weight:bold;color:#555;min-width:80px;margin:0;
}
.detail-item span{
  color:#333;font-size:1rem;flex:1;
}
.cancel-options{
  text-align:center;
}
.cancel-notice{
  background:#fff3cd;border:1px solid #ffeaa7;
  border-radius:8px;padding:15px;margin-bottom:20px;
}
.cancel-notice p{
  margin:0;color:#856404;font-size:0.9rem;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.cancel-buttons{
  display:grid;grid-template-columns:1fr;gap:15px;
}
.contact-support-btn{
  background:linear-gradient(135deg,#00C300,#00A000);
  color:white;border:none;padding:15px 20px;
  border-radius:10px;cursor:pointer;font-size:1.1rem;
  font-weight:bold;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.contact-support-btn:hover{
  background:linear-gradient(135deg,#00A000,#008000);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(0,195,0,0.3);
}
.password-cancel-btn{
  background:linear-gradient(135deg,#6c757d,#5a6268);
  color:white;border:none;padding:15px 20px;
  border-radius:10px;cursor:pointer;font-size:1.1rem;
  font-weight:bold;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.password-cancel-btn:hover{
  background:linear-gradient(135deg,#5a6268,#495057);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(108,117,125,0.3);
}

/* å¯†ç¢¼è¼¸å…¥å½ˆçª—æ¨£å¼ */
.password-modal{
  display:none;position:fixed;z-index:5000;left:0;top:0;
  width:100%;height:100%;background:rgba(0,0,0,0.8);
  justify-content:center;align-items:center;
  backdrop-filter:blur(5px);
}
.password-modal.active{display:flex;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}
.password-modal-content{
  background:white;border-radius:15px;padding:0;
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  max-width:400px;width:90%;max-height:80vh;overflow-y:auto;
  position:relative;
}
.password-header{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;padding:20px;border-radius:15px 15px 0 0;
  display:flex;justify-content:space-between;align-items:center;
}
.password-header h3{
  margin:0;font-size:1.3rem;display:flex;align-items:center;gap:10px;
}
.password-header .modal-close{
  position:static;color:white;font-size:28px;cursor:pointer;
  padding:5px;border-radius:50%;transition:all .3s;
  width:35px;height:35px;display:flex;align-items:center;justify-content:center;
}
.password-header .modal-close:hover{
  background:rgba(255,255,255,0.25);
  transform:rotate(90deg);
}
.password-body{
  padding:30px;
}
.password-info{
  text-align:center;
}
.password-info p{
  margin:0 0 20px 0;color:#555;font-size:1rem;
}
.password-input-group{
  display:flex;gap:10px;align-items:center;
}
.password-input-group input{
  flex:1;padding:12px;border:2px solid #e9ecef;
  border-radius:8px;font-size:1rem;transition:all .3s;
}
.password-input-group input:focus{
  outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,0.15);
}
.password-submit-btn{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;border:none;padding:12px 20px;
  border-radius:8px;cursor:pointer;font-size:1rem;
  font-weight:bold;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.password-submit-btn:hover{
  background:linear-gradient(135deg,#764ba2,#667eea);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(102,126,234,0.4);
}

/* è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9998;
  backdrop-filter: blur(5px);
}

.loading-overlay.active {
  display: flex;
  animation: fadeIn 0.3s ease;
}

.loading-spinner {
  background: white;
  border-radius: 20px;
  padding: 35px 45px;
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
  text-align: center;
  animation: slideUp 0.4s ease;
  min-width: 300px;
  max-width: 400px;
}

.loading-spinner .spinner {
  width: 60px;
  height: 60px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #FF8A00;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

.loading-spinner p {
  color: #333;
  font-size: 1.1rem;
  margin: 0;
  font-weight: 600;
  letter-spacing: 0.5px;
  line-height: 1.5;
  text-align: center;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ - å·²éš±è— */
.sync-status{
  position:fixed;bottom:20px;right:20px;z-index:1000;
  background:rgba(0,0,0,0.9);color:white;padding:12px 18px;
  border-radius:25px;font-size:0.9rem;display:none !important;
  align-items:center;gap:10px;backdrop-filter:blur(10px);
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
  cursor:pointer;transition:all 0.3s ease;
  border:2px solid transparent;
}
.sync-status.show{display:none !important;}
.sync-status:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 25px rgba(0,0,0,0.4);
}
.sync-status i{
  animation:spin 1s linear infinite;
  font-size:1rem;
}
.sync-status.success{
  background:rgba(40,167,69,0.95);
  border-color:rgba(40,167,69,0.5);
}
.sync-status.success i{
  animation:none;
}
.sync-status.error{
  background:rgba(220,53,69,0.95);
  border-color:rgba(220,53,69,0.5);
}
.sync-status.error i{
  animation:none;
}


/* Footer é€£çµ hover æ•ˆæœ */
footer a:hover {
  opacity: 0.8;
  transform: translateY(-2px);
}

/* LINEç€è¦½å™¨å…¼å®¹æ¨¡å¼ - å¼·åˆ¶æ°´å¹³é¡¯ç¤º */
body.line-browser .event-item {
  writing-mode: horizontal-tb !important;
  -webkit-writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
  -webkit-text-orientation: mixed !important;
  max-width: 100% !important;
  min-width: 40px !important;
  white-space: normal !important;
  word-break: break-all !important;
  line-height: 1.2 !important;
  padding: 3px 5px !important;
  text-align: center !important;
  /* å›ºå®šå­—é«”å¤§å°ï¼ˆä¸ä½¿ç”¨clampï¼‰ */
  font-size: 0.6rem !important;
}

body.line-browser .payment-status {
  font-size: 0.55rem !important;
}

body.line-browser .payment-status span {
  font-size: 0.5rem !important;
}

body.line-browser .day-number {
  font-size: 0.85rem !important;
}

body.line-browser .day-events {
  flex-direction: column !important;
  gap: 2px !important;
}

body.line-browser .event-container {
  width: 100% !important;
}

/* ä¸­ç­‰è¢å¹•å„ªåŒ–ï¼ˆå¹³æ¿ï¼‰- é¤è»Šåç¨±å‚ç›´é¡¯ç¤º */
@media(max-width:1024px){
  .event-item{
    /* å‚ç›´é¡¯ç¤ºå„ªå…ˆ */
    writing-mode:vertical-rl;
    -webkit-writing-mode:vertical-rl;
    -ms-writing-mode:tb-rl;
    text-orientation:upright;
    -webkit-text-orientation:upright;
    letter-spacing:0.05em;
    min-height:30px;
    padding:3px 5px;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto;
    /* é™ç´šæ–¹æ¡ˆï¼šå¦‚æœä¸æ”¯æ´å‚ç›´é¡¯ç¤ºï¼Œå‰‡æ›è¡Œé¡¯ç¤º */
    word-break:break-all;
    white-space:normal;
    line-height:1.2;
    max-width:60px;
    text-align:center;
  }
  
  .event-container{
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    min-height:35px;
    position:relative;
    padding-top:8px;
  }
  
  .calendar-day{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .day-events{
    display:flex;
    flex-direction:row;
    justify-content:center;
    gap:4px;
    width:100%;
    margin-top:18px;
  }
  
  /* å‚ç›´é¡¯ç¤ºæ¨¡å¼ä¸‹çš„å–æ¶ˆæŒ‰éˆ•èª¿æ•´ */
  .cancel-btn{
    top:-4px;
    right:-4px;
  }
}

/* æ‰‹æ©Ÿå‹å–„ */
@media(max-width:768px){
  /* ğŸ”’ é˜²æ­¢è¼¸å…¥æ¡†èšç„¦æ™‚é é¢/å½ˆçª—è‡ªå‹•ç¸®æ”¾ */
  body {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  
  input, select, textarea {
    font-size: 16px !important; /* é˜²æ­¢ iOS Safari è‡ªå‹•ç¸®æ”¾ */
    transform: none !important;
  }
  
  input:focus, select:focus, textarea:focus {
    font-size: 16px !important;
    transform: none !important;
  }
  
  /* å½ˆçª—å…§çš„è¼¸å…¥æ¡†ä¹Ÿå›ºå®šå­—é«”å¤§å° */
  .modal input, .modal select, .modal textarea {
    font-size: 16px !important;
  }
  
  .hero h1{font-size:1.6rem;}
  .hero p{font-size:0.9rem;}
  .hero{padding:35px 15px;min-height:25vh;}
  .hero button{padding:10px 20px;font-size:0.95rem;}
  
  /* å¿«é€Ÿé€£çµæ‰‹æ©Ÿç‰ˆ */
  .quick-links-grid{
    grid-template-columns:repeat(2, 1fr);
    gap:8px;
    margin-top:15px;
    max-width:100%;
  }
  
  .quick-link-btn{
    padding:10px 6px;
    font-size:0.75rem;
  }
  
  .quick-link-btn i{
    font-size:1.3rem;
    margin-bottom:2px;
  }
  
  .quick-link-btn span{
    font-size:0.7rem;
  }
  
  .container{padding:0 10px;margin:20px auto;}
  .card{padding:15px;margin-bottom:20px;border-radius:10px;}
  
  .form-grid{grid-template-columns:1fr;gap:15px;}
  .info-grid{grid-template-columns:1fr;}
  
  /* æ¨™é¡Œå„ªåŒ– */
  h2.section-title{font-size:1.3rem;margin-bottom:15px;}
  h2.section-title::after{width:50px;height:2px;}
  
  /* å ´åœ°åˆ†é æ‰‹æ©Ÿå„ªåŒ– - æ”¹ç‚º2åˆ—ç¶²æ ¼ */
  .location-tabs{
    grid-template-columns:repeat(2,1fr);
    gap:6px;
  }
  .location-tab{
    padding:6px;
    min-height:auto;
  }
  .location-tab i{font-size:1.1rem;margin-bottom:2px;}
  .location-tab span{font-size:0.8rem;}
  .location-tab small{display:none;} /* æ‰‹æ©Ÿç‰ˆéš±è—åœ°å€ */
  .location-thumbnail{height:50px;margin-top:2px;border-radius:4px;}
  
  /* å ´åœ°è³‡è¨Šæ‰‹æ©Ÿå„ªåŒ– */
  .location-info{padding:12px;}
  .location-info h3{font-size:1rem;margin-bottom:8px;}
  .info-item{font-size:0.85rem;gap:8px;}
  .info-item i{font-size:0.9rem;}
  .special-notice{padding:8px;font-size:0.8rem;}
  
  /* æ–°æ—¥æ›†ç³»çµ±æ‰‹æ©Ÿå„ªåŒ– */
  .calendar-container{padding:12px;border-radius:8px;}
  
  .calendar-header{
    flex-direction:column;
    align-items:stretch;
    gap:10px;
  }
  
  .calendar-nav{
    justify-content:center;
    gap:6px;
  }
  
  .nav-btn,.today-btn{
    padding:6px 8px;
    font-size:0.8rem;
    min-width:32px;
    height:32px;
  }
  
  .month-display{
    font-size:1rem;
    min-width:90px;
  }
  
  /* å ´åœ°ç¯©é¸æŒ‰éˆ• - 2è¡Œ3æ¬„ç¶²æ ¼ä½ˆå±€ */
  .location-filter{
    flex-direction:column;
    align-items:stretch;
  }
  
  .location-filter label{
    font-size:0.85rem;
    text-align:center;
    margin:0 0 8px 0;
  }
  
  .location-filter-buttons{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    grid-template-rows:repeat(2, 1fr);
    gap:6px;
  }
  
  .location-filter .filter-btn{
    font-size:0.68rem;
    padding:6px 4px;
    white-space:normal;
    border-radius:8px;
    min-height:42px;
    display:flex;
    flex-direction:row;
    align-items:center;
    justify-content:center;
    gap:3px;
    line-height:1.2;
    text-align:center;
  }
  
  .location-filter .filter-btn i{
    font-size:0.75rem;
    flex-shrink:0;
  }
  
  /* æ—¥æ›†ç¶²æ ¼æ‰‹æ©Ÿå„ªåŒ– - ç·Šæ¹Šä½†æ¸…æ™° */
  .calendar-grid{
    gap:1px;
    font-size:0.8rem;
    border-radius:6px;
  }
  
  .calendar-day-header{
    padding:6px 2px;
    font-size:0.7rem;
  }
  
  .calendar-day{
    min-height:70px;
    padding:3px 2px;
  }
  
  .day-number{
    font-size:clamp(0.7rem, 4vw, 0.85rem);
    padding-top:0;
    margin-bottom:1px;
  }
  
  .event-item{
    font-size:clamp(0.5rem, 3vw, 0.65rem);
    padding:3px 4px;
    min-height:20px;
    line-height:1.2;
    border-radius:2px;
    /* å‚ç›´é¡¯ç¤ºå„ªå…ˆï¼ˆå«WebKitå‰ç¶´æ”¯æ´ï¼‰ */
    writing-mode:vertical-rl;
    -webkit-writing-mode:vertical-rl;
    -ms-writing-mode:tb-rl;
    text-orientation:upright;
    -webkit-text-orientation:upright;
    letter-spacing:0.05em;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto;
    max-width:25px;
    /* é™ç´šæ–¹æ¡ˆï¼šä¸æ”¯æ´æ™‚è‡ªå‹•æ›è¡Œ */
    word-break:break-all;
    white-space:normal;
    text-align:center;
  }
  
  .day-events{
    display:flex;
    flex-direction:row;
    justify-content:center;
    gap:3px;
  }
  
  /* ä»˜æ¬¾ç‹€æ…‹æ‰‹æ©Ÿå„ªåŒ– - æ›´å°æ›´ç²¾ç°¡ + è‡ªå‹•æ›è¡Œ + æ–‡å­—è‡ªå‹•ç¸®æ”¾ */
  .payment-status{
    top:4px;
    font-size:clamp(0.45rem, 3.5vw, 0.55rem);
    max-width:calc(100% - 8px);
    left:4px;
    right:4px;
    transform:none;
    white-space:normal;
    line-height:1.1;
  }
  
  .payment-status span{
    font-size:clamp(0.4rem, 3vw, 0.5rem);
    padding:1px 3px;
    display:inline-block;
    white-space:normal;
    word-break:keep-all;
    line-height:1.2;
  }
  
  /* æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– - ç¢ºä¿44x44è§¸æ§å€åŸŸ */
  .cancel-btn{
    width:20px;
    height:20px;
    font-size:10px;
    top:-3px;
    right:-3px;
  }
  
  .takeover-btn,.calendar-payment-btn{
    width:18px;
    height:18px;
    font-size:9px;
    top:-3px;
    left:-3px;
  }
  
  /* ç‰¹æ®Šæ¨™è¨˜æ‰‹æ©Ÿå„ªåŒ– */
  .holiday-badge{
    font-size:0.55rem;
    padding:1px 3px;
    margin-top:1px;
  }
  
  /* è¡¨å–®æ‰‹æ©Ÿå„ªåŒ– */
  label{
    font-size:0.9rem;
    margin-top:12px;
  }
  label i{
    font-size:0.85rem;
  }
  
  input,select,textarea{
    padding:9px;
    font-size:0.9rem;
    border-radius:6px;
  }
  
  button.submit{
    padding:12px 20px;
    font-size:1rem;
    margin-top:20px;
    width:100%;
  }
  
  /* æç¤ºè¨Šæ¯æ‰‹æ©Ÿå„ªåŒ– */
  .notice-box{
    padding:10px;
    font-size:0.85rem;
    border-radius:6px;
    margin-top:15px;
  }
  .notice-box h4{
    font-size:0.95rem;
    margin-bottom:8px;
  }
  .notice-box ul{
    font-size:0.8rem;
    line-height:1.4;
    padding-left:18px;
  }
  .notice-box li{
    margin-bottom:5px;
  }
  
  .special-notice{
    padding:6px 8px;
    font-size:0.8rem;
  }
  .special-notice i{
    font-size:0.9rem;
  }
  .special-notice span{
    font-size:0.8rem;
  }
  
  /* æ‰€æœ‰å½ˆçª—çµ±ä¸€å„ªåŒ– - ç·Šæ¹ŠåŒ– */
  .payment-modal-content,
  .bank-modal-content,
  .cancel-modal-content,
  .password-modal-content{
    width:92%;
    max-width:none;
    max-height:88vh;
    border-radius:12px;
  }
  
  /* å½ˆçª—æ¨™é¡Œ - ç·Šæ¹ŠåŒ– */
  .payment-header,
  .bank-header,
  .cancel-header,
  .password-header{
    padding:12px 15px !important;
  }
  
  .payment-header h3,
  .bank-header h3,
  .cancel-header h3,
  .password-header h3{
    font-size:clamp(0.95rem, 4.5vw, 1.05rem) !important;
    gap:6px !important;
  }
  
  .payment-header h3 i,
  .bank-header h3 i,
  .cancel-header h3 i,
  .password-header h3 i{
    font-size:clamp(0.9rem, 4vw, 1rem);
  }
  
  /* å½ˆçª—å…§å®¹ - ç·Šæ¹ŠåŒ– */
  .payment-body,
  .bank-body,
  .cancel-body,
  .password-body{
    padding:15px !important;
  }
  
  /* ç¹³è²»æŒ‰éˆ• - ç·Šæ¹ŠåŒ– */
  .payment-btn{
    padding:10px 12px;
    font-size:clamp(0.85rem, 4vw, 0.95rem);
    gap:8px;
  }
  .payment-btn i{
    font-size:clamp(1rem, 4.5vw, 1.2rem);
  }
  
  /* ç¹³è²»å½ˆçª—è³‡è¨Šå€ */
  .payment-info p{
    font-size:clamp(0.9rem, 4vw, 1rem);
    margin:3px 0;
  }
  
  .payment-notice p{
    font-size:clamp(0.8rem, 3.5vw, 0.85rem);
    line-height:1.4;
  }
  
  .payment-buttons{
    gap:10px;
    margin-bottom:15px;
  }
  
  /* éŠ€è¡Œè³‡è¨Š - ç·Šæ¹ŠåŒ– */
  .bank-item{
    flex-direction:row;
    align-items:center;
    gap:8px;
    padding:6px 8px;
    margin-bottom:8px;
  }
  .bank-item label{
    min-width:auto;
    margin:0;
    font-size:clamp(0.8rem, 3.5vw, 0.85rem);
    white-space:nowrap;
  }
  .bank-item span{
    font-size:clamp(0.85rem, 3.8vw, 0.9rem);
  }
  .account-number{
    width:100%;
    flex-direction:column;
    gap:6px;
  }
  .account-number span{
    font-size:clamp(0.9rem, 4vw, 1rem);
    padding:6px 8px;
  }
  .copy-btn{
    padding:7px 10px;
    font-size:clamp(0.75rem, 3.5vw, 0.8rem);
    width:100%;
  }
  
  .bank-amount{
    padding:10px;
    margin-bottom:10px;
  }
  
  .bank-amount label,
  .bank-amount .amount{
    font-size:clamp(0.9rem, 4vw, 1rem);
  }
  
  .bank-notice{
    padding:10px;
  }
  
  .bank-notice p{
    font-size:clamp(0.75rem, 3.5vw, 0.8rem);
    line-height:1.4;
  }
  
  .official-account-btn{
    padding:10px 15px;
    font-size:clamp(0.85rem, 4vw, 0.95rem);
    gap:6px;
  }
  
  /* é ç´„è©³æƒ… - ç·Šæ¹ŠåŒ– */
  .booking-details{
    padding:10px;
    border-radius:8px;
    margin-bottom:12px;
  }
  .booking-details h4{
    font-size:clamp(0.85rem, 4vw, 0.95rem);
    margin-bottom:8px;
    gap:6px;
  }
  .detail-item{
    flex-direction:row;
    align-items:center;
    gap:6px;
    padding:5px 0;
  }
  .detail-item label{
    min-width:55px;
    margin:0;
    font-size:clamp(0.75rem, 3.5vw, 0.82rem);
    white-space:nowrap;
  }
  .detail-item span{
    font-size:clamp(0.8rem, 3.8vw, 0.88rem);
    line-height:1.3;
  }
  
  /* æ“ä½œæŒ‰éˆ• - ç·Šæ¹ŠåŒ– */
  .contact-support-btn,
  .password-cancel-btn{
    padding:10px 12px;
    font-size:clamp(0.85rem, 4vw, 0.92rem);
    gap:6px;
  }
  
  .cancel-notice p{
    font-size:clamp(0.75rem, 3.5vw, 0.82rem);
    line-height:1.4;
  }
  
  .cancel-buttons{
    gap:10px;
  }
  
  /* å¯†ç¢¼è¼¸å…¥ - ç·Šæ¹ŠåŒ– */
  #passwordModal .password-body{
    padding:20px 15px !important;
  }
  
  #passwordModal .password-info > div:first-child{
    margin-bottom:15px !important;
  }
  
  #passwordModal .password-info > div:first-child > div{
    width:50px !important;
    height:50px !important;
    margin-bottom:10px !important;
  }
  
  #passwordModal .password-info > div:first-child > div i{
    font-size:1.3rem !important;
  }
  
  #passwordModal .password-info p:first-of-type{
    font-size:clamp(0.95rem, 4.5vw, 1.05rem) !important;
  }
  
  #passwordModal .password-info p:last-of-type{
    font-size:clamp(0.78rem, 3.5vw, 0.85rem) !important;
  }
  
  .password-input-group{
    flex-direction:column;
    gap:10px;
  }
  .password-input-group input{
    padding:9px;
    padding-left:36px;
    font-size:clamp(0.88rem, 4vw, 0.95rem);
    height:40px;
    letter-spacing:1.5px;
  }
  .password-input-group i{
    font-size:clamp(0.85rem, 4vw, 0.95rem);
    left:11px;
  }
  .password-submit-btn{
    width:100%;
    justify-content:center;
    padding:9px 12px;
    font-size:clamp(0.88rem, 4vw, 0.95rem);
    height:40px;
    gap:5px;
  }
  
  #passwordModal .password-info > div:last-child{
    padding:8px 10px !important;
    margin-top:12px !important;
  }
  
  #passwordModal .password-info > div:last-child p{
    font-size:clamp(0.72rem, 3.2vw, 0.78rem) !important;
  }
  
  /* é€¾æœŸæ¥æ‰‹/æ’ç­é‡‹å‡ºå½ˆçª— - ç·Šæ¹ŠåŒ– */
  #takeoverModal .payment-body,
  #transferModal .password-body{
    padding:12px !important;
  }
  #takeoverModal label,
  #transferModal label{
    margin-top:8px;
    font-size:clamp(0.78rem, 3.5vw, 0.85rem);
  }
  #takeoverModal input,
  #takeoverModal select,
  #transferModal input,
  #transferModal select{
    font-size:clamp(0.85rem, 3.8vw, 0.9rem);
    padding:8px;
    height:38px;
  }
  
  #takeoverModal .alert-warning p,
  #takeoverModal .takeover-notice p,
  #transferModal .special-notice span{
    font-size:clamp(0.75rem, 3.5vw, 0.82rem);
  }
  
  #takeoverModal .original-booking-info h4,
  #transferModal .original-booking-info h4{
    font-size:clamp(0.85rem, 4vw, 0.92rem);
    margin-bottom:8px;
  }
  
  #takeoverModal button,
  #transferModal button{
    font-size:clamp(0.85rem, 4vw, 0.92rem);
    padding:10px 12px;
    gap:5px;
  }
  
  /* Toast æç¤ºæ‰‹æ©Ÿå„ªåŒ– - ç·Šæ¹ŠåŒ– */
  .toast-container{
    top:10px;
    right:10px;
    left:10px;
  }
  .toast{
    min-width:auto;
    max-width:100%;
    padding:10px 12px;
    border-radius:8px;
  }
  .toast-header{
    margin-bottom:3px;
  }
  .toast-icon{
    font-size:clamp(0.9rem, 4vw, 1rem);
  }
  .toast-title{
    font-size:clamp(0.82rem, 4vw, 0.9rem);
  }
  .toast-message{
    font-size:clamp(0.75rem, 3.5vw, 0.82rem);
    line-height:1.4;
  }
  
  /* Footer æ‰‹æ©Ÿå„ªåŒ– */
  footer{
    padding:20px 12px;
    margin-top:30px;
  }
  footer p{
    font-size:0.8rem !important;
    line-height:1.5;
    margin-bottom:6px;
  }
  footer a{
    display:inline-block;
    margin:3px 0;
  }
  
  /* è²»ç”¨æ¬„ä½æ‰‹æ©Ÿå„ªåŒ– */
  .fee-input-group input{
    font-size:0.85rem;
    padding:8px;
    padding-left:35px;
  }
  .fee-input-group i{
    font-size:0.9rem;
    left:10px;
  }
  
  /* æ—¥æœŸè³‡è¨Šæ‰‹æ©Ÿå„ªåŒ– */
  .date-info{
    padding:6px 8px;
    font-size:0.8rem;
  }
  .date-info small{
    font-size:0.75rem;
  }
  
  /* è¼‰å…¥å‹•ç•«æ‰‹æ©Ÿå„ªåŒ– */
  .loading-spinner{
    padding:25px 30px;
    min-width:260px;
    max-width:90%;
    border-radius:15px;
  }
  .loading-spinner .spinner{
    width:50px;
    height:50px;
    margin-bottom:15px;
    border-width:4px;
  }
  .loading-spinner p{
    font-size:1rem;
    letter-spacing:0.3px;
    line-height:1.4;
  }
  
  .loading-spinner p div:first-child{
    font-size:clamp(1.1rem, 5vw, 1.3rem);
  }
  
  .loading-spinner p div:last-child{
    font-size:clamp(0.8rem, 3.5vw, 0.9rem);
  }
  
  /* é¿å…æ‰‹æ©Ÿæ©«å‘æ»¾å‹• */
  body{
    overflow-x:hidden;
  }
  .container{
    max-width:100%;
  }
  
  /* ç¢ºä¿æ‰€æœ‰æ–‡å­—å¯é¸æ“‡ï¼ˆæ”¹å–„ç”¨æˆ¶é«”é©—ï¼‰ */
  *{
    -webkit-tap-highlight-color:rgba(255,139,0,0.1);
  }
}

/* æ¥µå°è¢å¹•å„ªåŒ–ï¼ˆ320px-480pxï¼‰*/
@media(max-width:480px){
  .hero h1{font-size:1.4rem;}
  .hero p{font-size:0.85rem;}
  .hero{padding:30px 12px;min-height:22vh;}
  
  .container{padding:0 8px;margin:15px auto;}
  .card{padding:12px;margin-bottom:15px;}
  
  h2.section-title{font-size:1.2rem;margin-bottom:12px;}
  
  .location-tab i{font-size:1rem;}
  .location-tab span{font-size:0.75rem;}
  .location-thumbnail{height:45px;}
  
  /* å½ˆçª—æ¥µå°è¢å¹•å„ªåŒ– - æ›´ç·Šæ¹Š */
  .payment-modal-content,
  .bank-modal-content,
  .cancel-modal-content,
  .password-modal-content{
    width:94%;
    border-radius:10px;
  }
  
  .payment-header,
  .bank-header,
  .cancel-header,
  .password-header{
    padding:10px 12px !important;
  }
  
  .payment-body,
  .bank-body,
  .cancel-body,
  .password-body{
    padding:12px !important;
  }
  
  .payment-btn,
  .contact-support-btn,
  .password-cancel-btn{
    padding:9px 10px;
  }
  
  .booking-details,
  .original-booking-info{
    padding:8px;
    margin-bottom:10px;
  }
  
  #passwordModal .password-body{
    padding:15px 12px !important;
  }
  
  #passwordModal .password-info > div:first-child > div{
    width:45px !important;
    height:45px !important;
  }
  
  #passwordModal .password-info > div:first-child > div i{
    font-size:1.1rem !important;
  }
  
  .password-input-group input{
    height:38px;
    font-size:0.85rem;
  }
  
  .password-submit-btn{
    height:38px;
    font-size:0.85rem;
    padding:8px 10px;
  }
  
  #takeoverModal button,
  #transferModal button{
    padding:9px 8px;
    font-size:0.82rem;
  }
  
  /* ä½¿ç”¨æ•™å­¸å½ˆçª—æ‰‹æ©Ÿå„ªåŒ– */
  #helpModal .password-modal-content{
    max-width:95%;
  }
  
  #helpModal .password-body{
    padding:18px 15px !important;
    max-height:75vh;
  }
  
  .help-section h4{
    font-size:clamp(0.95rem, 4.5vw, 1.05rem) !important;
    margin-bottom:10px !important;
  }
  
  .help-section ul{
    font-size:clamp(0.8rem, 3.5vw, 0.85rem) !important;
    line-height:1.6 !important;
    padding-left:18px !important;
  }
  
  .help-section li{
    margin-bottom:8px !important;
  }
  
  #helpModal button{
    padding:10px 15px !important;
    font-size:clamp(0.88rem, 4vw, 0.95rem) !important;
  }
  
  /* å¹«åŠ©æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– */
  .help-btn{
    width:28px;
    height:28px;
    right:5px;
  }
  
  .help-btn i{
    font-size:0.9rem;
  }
  
  /* å ´åœ°ç¯©é¸æŒ‰éˆ• - 2è¡Œ3æ¬„ä¿æŒä¸€è‡´ */
  .location-filter-buttons{
    grid-template-columns:repeat(3, 1fr);
    gap:5px;
  }
  
  .location-filter .filter-btn{
    font-size:0.65rem;
    padding:5px 3px;
    min-height:38px;
    gap:2px;
  }
  
  .location-filter .filter-btn i{
    font-size:0.7rem;
  }
  
  .calendar-day{min-height:65px;}
  .day-number{font-size:clamp(0.65rem, 4.5vw, 0.8rem);}
  .event-item{
    font-size:clamp(0.45rem, 3.5vw, 0.6rem);
    padding:3px 3px;
    /* å‚ç›´é¡¯ç¤ºï¼ˆå«å‰ç¶´ï¼‰ */
    writing-mode:vertical-rl;
    -webkit-writing-mode:vertical-rl;
    -ms-writing-mode:tb-rl;
    text-orientation:upright;
    -webkit-text-orientation:upright;
    letter-spacing:0.05em;
    min-height:18px;
    max-width:22px;
    margin:0 auto;
    /* é™ç´šæ–¹æ¡ˆ */
    word-break:break-all;
    white-space:normal;
    text-align:center;
    line-height:1.2;
  }
  
  .payment-status{
    max-width:calc(100% - 6px);
    left:3px;
    right:3px;
    font-size:clamp(0.38rem, 4vw, 0.5rem);
  }
  
  .payment-status span{
    font-size:clamp(0.35rem, 3.5vw, 0.45rem);
    padding:1px 2px;
  }
  
  input,select,textarea{
    padding:8px;
    font-size:0.85rem;
  }
  
  button.submit{
    padding:11px 18px;
    font-size:0.95rem;
  }
  
  /* è¼‰å…¥å‹•ç•«æ¥µå°è¢å¹•å„ªåŒ– */
  .loading-spinner{
    padding:20px 25px;
    min-width:240px;
    max-width:92%;
  }
  .loading-spinner .spinner{
    width:45px;
    height:45px;
    margin-bottom:12px;
  }
  .loading-spinner p{
    font-size:0.9rem;
    line-height:1.3;
  }
  
  .loading-spinner p div:first-child{
    font-size:clamp(1rem, 6vw, 1.2rem);
    margin-bottom:6px;
  }
  
  .loading-spinner p div:last-child{
    font-size:clamp(0.75rem, 4vw, 0.85rem);
  }
  
  /* ä½¿ç”¨æ•™å­¸å½ˆçª—æ¥µå°è¢å¹•å„ªåŒ– */
  #helpModal .password-body{
    padding:15px 12px !important;
  }
  
  .help-section h4{
    font-size:0.95rem !important;
  }
  
  .help-section ul{
    font-size:0.78rem !important;
    line-height:1.5 !important;
  }
  
  .help-btn{
    width:26px;
    height:26px;
  }
  
  .help-btn i{
    font-size:0.85rem;
  }
}
</style>
</head>
<body>

<!-- Hero Banner -->
<section class="hero">
  <div class="hero-content">
    <h1>ğŸšš æ¥Šæ¢…é¤è»Šæ’ç­å ±å</h1>
    <p>ç«‹å³é ç´„æ‚¨çš„é¤è»Šå‡ºæ”¤æª”æœŸï¼Œéš¨æ™‚æŸ¥çœ‹æœ€æ–°æ’ç­æ—¥æ›†</p>
    
    <!-- å¿«é€ŸåŠŸèƒ½é€£çµ -->
    <div class="quick-links-grid">
      <a href="https://siwei.pages.dev/" target="_blank" class="quick-link-btn">
        <i class="fas fa-route"></i>
        <span>æ¯æ—¥è¡Œç¨‹ç¸½è¦½</span>
      </a>
      
      <button onclick="showRulesModal()" class="quick-link-btn">
        <i class="fas fa-book"></i>
        <span>ç¾¤çµ„ç‰ˆè¦</span>
      </button>
      
      <button onclick="showDownloadModal()" class="quick-link-btn">
        <i class="fas fa-download"></i>
        <span>ä¸‹è¼‰ç´ æ</span>
      </button>
      
      <a href="https://reurl.cc/G4KbgD" target="_blank" class="quick-link-btn">
        <i class="fas fa-users"></i>
        <span>åŠ å…¥é è¨‚ç¤¾ç¾¤</span>
      </a>
      
      <a href="https://line.me/ti/g2/2-7-YZOXN4PysTdBsO7Kr4_q4UMlNxAGviawjg?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank" class="quick-link-btn">
        <i class="fas fa-store"></i>
        <span>é¤è»Šé—†é—†ç¤¾ç¾¤</span>
      </a>
    </div>
  </div>
</section>

<div class="container" id="mainContent" style="opacity: 0; transition: opacity 0.5s ease;">

  <!-- æ’ç­è¡Œäº‹æ›† -->
  <div class="card">
    <div style="display: flex; justify-content: center; align-items: center; position: relative;">
      <h2 class="section-title">ğŸ“… æ’ç­è¡Œäº‹æ›†</h2>
      <button onclick="showHelpModal()" class="help-btn" title="ä½¿ç”¨èªªæ˜">
        <i class="fas fa-question"></i>
      </button>
    </div>
    
    <!-- æ–°çš„è¡Œäº‹æ›†å®¹å™¨ -->
    <div class="calendar-container">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button id="prevMonth" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
          <span id="currentMonth" class="month-display">2025å¹´10æœˆ</span>
          <button id="nextMonth" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
          <button id="todayBtn" class="today-btn">ä»Šå¤©</button>
        </div>
        <div class="location-filter">
          <label><i class="fas fa-filter"></i> ç¯©é¸å ´åœ°ï¼š</label>
          <div class="location-filter-buttons">
            <button class="filter-btn active" data-location="å››ç¶­è·¯59è™Ÿ">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯59è™Ÿ
            </button>
            <button class="filter-btn" data-location="å››ç¶­è·¯60è™Ÿ">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯60è™Ÿ
            </button>
            <button class="filter-btn" data-location="æ¼¢å ¡å¤§äº¨">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯70è™Ÿ
            </button>
            <button class="filter-btn" data-location="è‡ªç”±é¢¨">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯190è™Ÿ
            </button>
            <button class="filter-btn" data-location="è”¬è’”">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯216è™Ÿ
            </button>
            <button class="filter-btn" data-location="é‡‘æ­£å¥½åƒ">
              <i class="fas fa-map-marker-alt"></i> å››ç¶­è·¯218è™Ÿ
            </button>
          </div>
        </div>
      </div>
      
      <div class="calendar-grid" id="calendarGrid">
        <!-- è¡Œäº‹æ›†å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- å ´åœ°é¸æ“‡ -->
  <div class="card">
    <h2 class="section-title">ğŸ“ é¸æ“‡å ´åœ°</h2>
    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 15px; margin-bottom: 15px; border-radius: 6px;">
      <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
        <i class="fas fa-lightbulb"></i> ğŸ’¡ <strong>å°æç¤ºï¼š</strong>æ‚¨å¯ä»¥ç›´æ¥é»æ“Šä¸Šæ–¹æ—¥æ›†çš„ç©ºç™½æ—¥æœŸå¿«é€Ÿé ç´„ï¼Œæˆ–åœ¨æ­¤é¸æ“‡å ´åœ°æŸ¥çœ‹è©³ç´°è³‡è¨Š
      </p>
    </div>
    <div class="location-tabs">
      <button class="location-tab active" data-location="å››ç¶­è·¯59è™Ÿ">
        <i class="fas fa-map-marker-alt"></i>
        <span>å››ç¶­è·¯59è™Ÿ</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯59è™Ÿ</small>
        <img src="https://i.postimg.cc/wTB3mKM7/59.jpg" alt="å››ç¶­è·¯59è™Ÿ" class="location-thumbnail" data-full-image="https://i.postimg.cc/wTB3mKM7/59.jpg">
      </button>
      <button class="location-tab" data-location="å››ç¶­è·¯60è™Ÿ">
        <i class="fas fa-map-marker-alt"></i>
        <span>å››ç¶­è·¯60è™Ÿ</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯60è™Ÿ</small>
        <img src="https://i.postimg.cc/Vsgdvsfr/60.jpg" alt="å››ç¶­è·¯60è™Ÿ" class="location-thumbnail" data-full-image="https://i.postimg.cc/Vsgdvsfr/60.jpg">
      </button>
      <button class="location-tab" data-location="æ¼¢å ¡å¤§äº¨">
        <i class="fas fa-store"></i>
        <span>æ¼¢å ¡å¤§äº¨</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯70è™Ÿ</small>
        <img src="https://i.postimg.cc/zD7VvDzH/70.jpg" alt="æ¼¢å ¡å¤§äº¨" class="location-thumbnail" data-full-image="https://i.postimg.cc/zD7VvDzH/70.jpg">
      </button>
      <button class="location-tab" data-location="è‡ªç”±é¢¨">
        <i class="fas fa-store"></i>
        <span>è‡ªç”±é¢¨</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯190è™Ÿ</small>
        <img src="https://i.postimg.cc/nV2CrVFX/190.jpg" alt="è‡ªç”±é¢¨" class="location-thumbnail" data-full-image="https://i.postimg.cc/nV2CrVFX/190.jpg">
      </button>
      <button class="location-tab" data-location="è”¬è’”">
        <i class="fas fa-leaf"></i>
        <span>è”¬è’”</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯216è™Ÿ</small>
        <img src="https://i.postimg.cc/MZ5vHZ6j/216.jpg" alt="è”¬è’”" class="location-thumbnail" data-full-image="https://i.postimg.cc/MZ5vHZ6j/216.jpg">
      </button>
      <button class="location-tab" data-location="é‡‘æ­£å¥½åƒ">
        <i class="fas fa-utensils"></i>
        <span>é‡‘æ­£å¥½åƒ</span>
        <small>æ¥Šæ¢…å€å››ç¶­è·¯218è™Ÿ</small>
        <img src="https://i.postimg.cc/bYgsrYyd/218.jpg" alt="é‡‘æ­£å¥½åƒ" class="location-thumbnail" data-full-image="https://i.postimg.cc/bYgsrYyd/218.jpg">
      </button>
    </div>
    
    <!-- å‹•æ…‹å ´åœ°è³‡è¨Š -->
    <div id="locationInfo" class="location-info">
      <h3><i class="fas fa-map-marker-alt"></i> æ¥Šæ¢…å€å››ç¶­è·¯59è™Ÿ</h3>
      <div class="special-notice">
        <i class="fas fa-exclamation-triangle"></i>
        <span>æ•´æœˆéƒ½å¯æ’ç­</span>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <i class="fas fa-clock"></i>
          <span><strong>ç‡Ÿæ¥­æ™‚é–“ï¼š</strong>14:00-20:00</span>
        </div>
        <div class="info-item">
          <i class="fas fa-dollar-sign"></i>
          <span><strong>è²»ç”¨ï¼š</strong>600å…ƒ/å¤©</span>
        </div>
        <div class="info-item">
          <i class="fas fa-truck"></i>
          <span><strong>é™åˆ¶ï¼š</strong>åƒ…é™1è»Šï¼Œé¤è»Šé«˜åº¦é™åˆ¶</span>
        </div>
        <div class="info-item">
          <i class="fas fa-ban"></i>
          <span><strong>ç¦æ­¢ï¼š</strong>æ²¹ç‚¸è½åœ°æ”¤ã€ç…™éœ§å¤ªå¤§ã€é£²æ–™è»Š</span>
        </div>
      </div>
    </div>
  </div>

  <!-- å ±åè¡¨å–® -->
  <div class="card" id="form">
    <h2 class="section-title">ğŸ“ ç·šä¸Šå ±åè¡¨</h2>
    <div class="form-grid">
      <div>
        <label><i class="fas fa-store"></i> é¤è»Šåç¨±</label>
        <input type="text" id="vendorName" placeholder="ä¾‹å¦‚ï¼šå‘é™½å¡åˆˆåŒ…">
      </div>
      <div>
        <label><i class="fas fa-map-marker-alt"></i> é¸æ“‡å ´åœ°</label>
      <select id="location">
          <option value="">è«‹é¸æ“‡å ´åœ°</option>
        <option value="å››ç¶­è·¯59è™Ÿ">å››ç¶­è·¯59è™Ÿ</option>
          <option value="å››ç¶­è·¯60è™Ÿ">å››ç¶­è·¯60è™Ÿ</option>
          <option value="æ¼¢å ¡å¤§äº¨">æ¼¢å ¡å¤§äº¨ - å››ç¶­è·¯70è™Ÿ</option>
          <option value="è‡ªç”±é¢¨">è‡ªç”±é¢¨ - å››ç¶­è·¯190è™Ÿ</option>
          <option value="è”¬è’”">è”¬è’” - å››ç¶­è·¯216è™Ÿ</option>
          <option value="é‡‘æ­£å¥½åƒ">é‡‘æ­£å¥½åƒ - å››ç¶­è·¯218è™Ÿ</option>
      </select>
      </div>
      <div>
        <label><i class="fas fa-calendar"></i> é¸æ“‡æ—¥æœŸ</label>
        <div class="date-selection">
          <input type="date" id="date" style="display:none;">
          <select id="availableDates">
            <option value="">è«‹å…ˆé¸æ“‡å ´åœ°</option>
      </select>
        </div>
        <div id="dateInfo" class="date-info">
          <small><i class="fas fa-info-circle"></i> è«‹å…ˆé¸æ“‡å ´åœ°</small>
        </div>
      </div>
      <div>
        <label><i class="fas fa-utensils"></i> é¤è»Šé¡å‹</label>
        <select id="foodType">
          <option value="">è«‹é¸æ“‡</option>
          <option value="ä¸»é£Ÿé¡">ä¸»é£Ÿé¡</option>
          <option value="ç”œé»é¡">ç”œé»é¡</option>
          <option value="å°é»é¡">å°é»é¡</option>
          <option value="ä¸­å¼é¤é»">ä¸­å¼é¤é»</option>
          <option value="çƒ¤è…¿å¥—é¤">çƒ¤è…¿å¥—é¤</option>
          <option value="ç”œå“é¡">ç”œå“é¡</option>
          <option value="å°åƒé¡å‹">å°åƒé¡å‹</option>
      </select>
      </div>
      <div class="fee-info">
        <label><i class="fas fa-dollar-sign"></i> å ´åœ°è²»</label>
        <div class="fee-input-group">
          <i class="fas fa-coins"></i>
          <input type="text" value="600å…ƒ/å¤© (14:00-20:00)" disabled readonly>
        </div>
      </div>
  </div>
    
    <div class="notice-box" id="noticeBox">
      <h4><i class="fas fa-exclamation-triangle"></i> é‡è¦æ³¨æ„äº‹é …</h4>
      <ul>
        <li>ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†</li>
        <li>ç¦æ­¢æ²¹ç‚¸è½åœ°æ”¤ï¼Œå…¶ä»–å¯ä»¥ä¸é™ï¼Œç¦ç…™éœ§å¤ªå¤§</li>
        <li>ç¦æ­¢é£²æ–™åŠé£²æ–™è»Š</li>
        <li>é¤è»Šé«˜åº¦é™åˆ¶ï¼Œè«‹ç‰¹åˆ¥æ³¨æ„</li>
        <li>æˆ¿æ±å¾ˆæ³¨é‡åœ°æ¿è¦è¨˜å¾—é‹ªåœ°å¢Š</li>
        <li>æ¡¶ä»”é›ç…™éœ§å¤ªå¤§ä¸è¡Œ</li>
        <li>ç™¼é›»æ©Ÿè€å¼å¤ªåµä¸è¡Œ</li>
      </ul>
    </div>
    
    <button class="submit" id="submitBtn">
      <i class="fas fa-paper-plane"></i> é€å‡ºå ±å
    </button>
  </div>

</div>

<!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
<div id="imageModal" class="image-modal">
  <span class="modal-close">&times;</span>
  <img class="modal-content" id="modalImage" src="" alt="">
</div>

<!-- ç¹³è²»å½ˆçª— -->
<div id="paymentModal" class="payment-modal">
  <div class="payment-modal-content">
    <div class="payment-header">
      <h3><i class="fas fa-credit-card"></i> ç¹³äº¤å ´åœ°è²»</h3>
      <span class="modal-close" onclick="closePaymentModal()">&times;</span>
    </div>
    <div class="payment-body">
      <div class="payment-info">
        <p style="font-size: 1.05rem; margin: 5px 0;"><strong>å ´åœ°è²»ï¼š600å…ƒ</strong></p>
        <p style="font-size: 0.9rem; margin: 5px 0;">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼å®Œæˆç¹³è²»</p>
      </div>
      <div class="payment-buttons">
        <button class="payment-btn jkopay-btn" onclick="openJkopay()">
          <i class="fas fa-mobile-alt"></i>
          <span>è¡—å£æ”¯ä»˜</span>
        </button>
        <button class="payment-btn linepay-btn" onclick="openLinepay()">
          <i class="fab fa-line"></i>
          <span>LINE-PAY</span>
        </button>
        <button class="payment-btn bank-btn" onclick="openBankModal()">
          <i class="fas fa-university"></i>
          <span>ç¶²éŠ€è½‰å¸³</span>
        </button>
      </div>
      <div class="payment-notice">
        <p><i class="fas fa-info-circle"></i> ç¹³è²»å®Œæˆå¾Œï¼Œè«‹å°‡æˆªåœ–æˆ–è¨Šæ¯å‚³è‡³<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline; cursor: pointer;">å®˜æ–¹å°å¹«æ‰‹</a></p>
      </div>
    </div>
  </div>
</div>

<!-- éŠ€è¡Œè½‰å¸³è³‡æ–™å½ˆçª— -->
<div id="bankModal" class="bank-modal">
  <div class="bank-modal-content">
    <div class="bank-header">
      <h3><i class="fas fa-university"></i> éŠ€è¡Œè½‰å¸³è³‡è¨Š</h3>
      <span class="modal-close" onclick="closeBankModal()">&times;</span>
    </div>
    <div class="bank-body">
      <div class="bank-info">
        <div class="bank-item">
          <label>éŠ€è¡Œåç¨±ï¼š</label>
          <span>æ¸£æ‰“éŠ€è¡Œ</span>
        </div>
        <div class="bank-item">
          <label>éŠ€è¡Œä»£è™Ÿï¼š</label>
          <span>052</span>
        </div>
        <div class="bank-item">
          <label>å¸³è™Ÿï¼š</label>
          <div class="account-number">
            <span id="accountNumber">02420000547239</span>
            <button class="copy-btn" onclick="copyAccountNumber()">
              <i class="fas fa-copy"></i> è¤‡è£½
            </button>
          </div>
        </div>
        <div class="bank-amount">
          <label>è½‰å¸³é‡‘é¡ï¼š</label>
          <span class="amount">600å…ƒ</span>
        </div>
      </div>
      <div class="bank-notice">
        <p><i class="fas fa-exclamation-triangle"></i> è½‰å¸³å®Œæˆå¾Œï¼Œè«‹å°‡è½‰å¸³æˆªåœ–æˆ–è¨Šæ¯å‚³è‡³<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a></p>
        <button class="official-account-btn" onclick="openOfficialAccount()">
          <i class="fab fa-line"></i> å‚³é€è‡³å®˜æ–¹å°å¹«æ‰‹
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å–æ¶ˆé ç´„å½ˆçª— -->
<div id="cancelModal" class="cancel-modal">
  <div class="cancel-modal-content">
    <div class="cancel-header">
      <h3><i class="fas fa-calendar-times"></i> å–æ¶ˆé ç´„</h3>
      <span class="modal-close" onclick="closeCancelModal()">&times;</span>
    </div>
    <div class="cancel-body">
      <div class="cancel-info">
        <div class="booking-details">
          <h4><i class="fas fa-info-circle"></i> é ç´„è©³æƒ…</h4>
          <div class="detail-item">
            <label>é¤è»Šåç¨±ï¼š</label>
            <span id="cancelVendorName"></span>
          </div>
          <div class="detail-item">
            <label>å ´åœ°ï¼š</label>
            <span id="cancelLocation"></span>
          </div>
          <div class="detail-item">
            <label>æ—¥æœŸï¼š</label>
            <span id="cancelDate"></span>
          </div>
          <div class="detail-item">
            <label>æ™‚é–“ï¼š</label>
            <span>14:00-20:00</span>
          </div>
        </div>
      </div>
      
      <div class="cancel-options">
        <div class="cancel-notice">
          <p><i class="fas fa-exclamation-triangle"></i> ç„¡æ³•è‡ªè¡Œå–æ¶ˆé ç´„ï¼Œè«‹æ´½<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a></p>
        </div>
        
        <div class="cancel-buttons">
          <button class="contact-support-btn" onclick="openOfficialAccount()">
            <i class="fab fa-line"></i> è¯ç¹«å®˜æ–¹å°å¹«æ‰‹
          </button>
          <button class="password-cancel-btn" onclick="showPasswordInput()">
            <i class="fas fa-key"></i> å¯†ç¢¼å–æ¶ˆé ç´„
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å¯†ç¢¼è¼¸å…¥å½ˆçª— -->
<div id="passwordModal" class="password-modal">
  <div class="password-modal-content" style="max-width: 420px;">
    <div class="password-header" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px;">
      <h3 style="font-size: 1.3rem;"><i class="fas fa-shield-alt"></i> å¯†ç¢¼é©—è­‰</h3>
      <span class="modal-close" onclick="closePasswordModal()">&times;</span>
    </div>
    <div class="password-body" style="padding: 25px;">
      <div class="password-info">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
            <i class="fas fa-lock" style="font-size: 1.6rem; color: white;"></i>
          </div>
          <p style="font-size: 1.05rem; color: #333; margin: 0 0 6px 0; font-weight: bold;">è«‹è¼¸å…¥å–æ¶ˆå¯†ç¢¼</p>
          <p style="font-size: 0.85rem; color: #666; margin: 0;">é©—è­‰å¾Œå³å¯å–æ¶ˆé ç´„</p>
        </div>
        
        <div class="password-input-group" style="flex-direction: column; gap: 12px;">
          <div style="position: relative;">
            <i class="fas fa-key" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 1rem;"></i>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="10" style="padding-left: 40px; border: 2px solid #e0e0e0; font-size: 1rem; height: 45px; text-align: center; letter-spacing: 2px;">
          </div>
          <button class="password-submit-btn" onclick="verifyPassword()" style="width: 100%; height: 45px; font-size: 1rem; background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
            <i class="fas fa-check-circle"></i> ç¢ºèªé©—è­‰
          </button>
        </div>
        
        <div style="background: #f8f9fa; border-left: 3px solid #667eea; padding: 10px 12px; margin-top: 15px; border-radius: 4px;">
          <p style="margin: 0; color: #666; font-size: 0.8rem; line-height: 1.4;">
            <i class="fas fa-info-circle" style="color: #667eea;"></i> å¦‚å¿˜è¨˜å¯†ç¢¼ï¼Œè«‹è¯ç¹«<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ’ç­é‡‹å‡ºå½ˆçª— -->
<div id="transferModal" class="password-modal">
  <div class="password-modal-content" style="max-width: 450px;">
    <div class="password-header" style="background: linear-gradient(135deg, #FF8A00, #FF4B2B);">
      <h3><i class="fas fa-exchange-alt"></i> æ’ç­é‡‹å‡º</h3>
      <span class="modal-close" onclick="closeTransferModal()">&times;</span>
    </div>
    <div class="password-body" style="padding: 18px;">
      <div class="transfer-info">
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 12px; margin-bottom: 12px; border-radius: 6px;">
          <p style="margin: 0; color: #856404; font-size: 0.82rem; line-height: 1.4;">
            <i class="fas fa-info-circle"></i> <strong>é‡‹å‡ºèªªæ˜ï¼š</strong>è«‹å…ˆå®Œæˆå ´ç§Ÿäº¤æ˜“å¾Œå†å¡«å¯«
          </p>
        </div>
        
        <div class="original-booking-info" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
          <h4 style="margin-bottom: 8px; color: #FF4B2B; font-size: 0.9rem;">åŸé ç´„è³‡è¨Š</h4>
          <div class="detail-item" style="margin-bottom: 6px; padding: 4px 0;">
            <label style="margin: 0; font-size: 0.8rem; min-width: 50px;">åŸé¤è»Šï¼š</label>
            <span id="transferOriginalVendor" style="font-weight: bold; color: #dc3545; font-size: 0.85rem;"></span>
          </div>
          <div class="detail-item" style="margin-bottom: 6px; padding: 4px 0;">
            <label style="margin: 0; font-size: 0.8rem; min-width: 50px;">å ´åœ°ï¼š</label>
            <span id="transferLocation" style="font-size: 0.85rem;"></span>
          </div>
          <div class="detail-item" style="padding: 4px 0; border: none;">
            <label style="margin: 0; font-size: 0.8rem; min-width: 50px;">æ—¥æœŸï¼š</label>
            <span id="transferDate" style="font-size: 0.85rem;"></span>
          </div>
        </div>
        
        <div class="transfer-form">
          <h4 style="margin-bottom: 10px; color: #FF4B2B; font-size: 0.9rem;">æ¥æ‰‹é¤è»Šè³‡è¨Š</h4>
          
          <label style="margin-top: 8px; font-size: 0.85rem;">æ–°åº—å <span style="color: red;">*</span></label>
          <input type="text" id="transferVendorName" placeholder="è«‹è¼¸å…¥é¤è»Šåç¨±" required style="font-size: 0.88rem; padding: 8px;">
          
          <label style="margin-top: 8px; font-size: 0.85rem;">é¤è»Šé¡å‹ <span style="color: red;">*</span></label>
          <select id="transferFoodType" required style="font-size: 0.88rem; padding: 8px;">
            <option value="">è«‹é¸æ“‡</option>
            <option value="ä¸»é£Ÿé¡">ä¸»é£Ÿé¡</option>
            <option value="ç”œé»é¡">ç”œé»é¡</option>
            <option value="å°é»é¡">å°é»é¡</option>
            <option value="ä¸­å¼é¤é»">ä¸­å¼é¤é»</option>
            <option value="çƒ¤è…¿å¥—é¤">çƒ¤è…¿å¥—é¤</option>
            <option value="ç”œå“é¡">ç”œå“é¡</option>
            <option value="å°åƒé¡å‹">å°åƒé¡å‹</option>
          </select>
          
          <label style="margin-top: 8px; font-size: 0.85rem;">æ›ç­å¯†ç¢¼ <span style="color: red;">*</span></label>
          <div style="position: relative;">
            <i class="fas fa-key" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #FF8A00; font-size: 0.9rem;"></i>
            <input type="password" id="transferPassword" placeholder="è«‹è¼¸å…¥æ›ç­å¯†ç¢¼" maxlength="20" style="padding: 8px; padding-left: 35px; font-size: 0.88rem; height: 38px;">
          </div>
          
          <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 8px 10px; margin-top: 12px;">
            <p style="margin: 0; color: #1976d2; font-size: 0.78rem; line-height: 1.4;">
              <i class="fas fa-exclamation-circle"></i> é‡‹å‡ºå¾Œå°‡æ›¿æ›ç‚ºæ–°é¤è»Šï¼Œéœ€è‡ªè¡Œå®Œæˆå ´ç§Ÿäº¤æ˜“
            </p>
          </div>
          
          <button class="password-submit-btn" onclick="submitTransfer()" style="width: 100%; margin-top: 12px; padding: 10px 12px; font-size: 0.9rem; height: 42px; background: linear-gradient(135deg, #FF8A00, #FF4B2B);">
            <i class="fas fa-exchange-alt"></i> ç¢ºèªé‡‹å‡ºæ›ç­
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ä½¿ç”¨æ•™å­¸å½ˆçª— -->
<div id="helpModal" class="password-modal">
  <div class="password-modal-content" style="max-width: 550px;">
    <div class="password-header" style="background: linear-gradient(135deg, #17a2b8, #138496); padding: 20px;">
      <h3 style="font-size: 1.3rem;"><i class="fas fa-graduation-cap"></i> ä½¿ç”¨æ•™å­¸</h3>
      <span class="modal-close" onclick="closeHelpModal()">&times;</span>
    </div>
    <div class="password-body" style="padding: 25px; max-height: 70vh; overflow-y: auto;">
      <div class="help-content">
        
        <div class="help-section">
          <h4 style="color: #FF4B2B; font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-calendar-check"></i> å¦‚ä½•é ç´„æ’ç­ï¼Ÿ
          </h4>
          <ul style="line-height: 1.8; color: #555; font-size: 0.9rem; padding-left: 20px;">
            <li><strong>æ–¹æ³•1ï¼šå¿«é€Ÿé ç´„</strong><br>ç›´æ¥é»æ“Šæ—¥æ›†ä¸Šçš„<span style="background: #fff5f0; padding: 2px 6px; border-radius: 4px; color: #FF8A00;">ç©ºç™½æ—¥æœŸ</span>ï¼Œç³»çµ±æœƒè‡ªå‹•å¡«å…¥å ´åœ°å’Œæ—¥æœŸ</li>
            <li><strong>æ–¹æ³•2ï¼šè¡¨å–®é ç´„</strong><br>ä¸‹æ»‘åˆ°å ±åè¡¨å–®ï¼Œä¾åºå¡«å¯«é¤è»Šåç¨±ã€å ´åœ°ã€æ—¥æœŸç­‰è³‡è¨Š</li>
            <li>é€å‡ºå¾Œæœƒé¡¯ç¤º<span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; color: #856404;">ç¹³è²»å½ˆçª—</span>ï¼Œè«‹åœ¨24å°æ™‚å…§å®Œæˆä»˜æ¬¾</li>
          </ul>
        </div>
        
        <div class="help-section" style="margin-top: 20px;">
          <h4 style="color: #28a745; font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-credit-card"></i> ä»˜æ¬¾èªªæ˜
          </h4>
          <ul style="line-height: 1.8; color: #555; font-size: 0.9rem; padding-left: 20px;">
            <li>é ç´„å¾Œéœ€åœ¨<strong style="color: #dc3545;">24å°æ™‚å…§ä»˜æ¬¾</strong>ï¼Œå¦å‰‡å°‡è®Šæˆ<span style="background: #f8d7da; padding: 2px 6px; border-radius: 4px; color: #721c24;">é€¾ç¹³å¯æ’</span>ç‹€æ…‹</li>
            <li>æ”¯æ´è¡—å£æ”¯ä»˜ã€LINE-PAYã€éŠ€è¡Œè½‰å¸³ä¸‰ç¨®æ–¹å¼</li>
            <li>ä»˜æ¬¾å®Œæˆå¾Œï¼Œè«‹å°‡æˆªåœ–å‚³è‡³<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a></li>
            <li>ä»˜æ¬¾ç‹€æ…‹æœƒé¡¯ç¤ºç‚º<span style="background: #d4edda; padding: 2px 6px; border-radius: 4px; color: #155724;">âœ“ å·²ä»˜æ¬¾</span></li>
          </ul>
        </div>
        
        <div class="help-section" style="margin-top: 20px;">
          <h4 style="color: #ffc107; font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-exchange-alt"></i> è½‰è®“æ’ç­
          </h4>
          <ul style="line-height: 1.8; color: #555; font-size: 0.9rem; padding-left: 20px;">
            <li>é»æ“Š<span style="background: #d4edda; padding: 2px 6px; border-radius: 4px; color: #155724;">å·²ä»˜æ¬¾</span>çš„æ’ç­ï¼Œå¯ä»¥å°‡æ’ç­è½‰è®“çµ¦å…¶ä»–é¤è»Š</li>
            <li>éœ€å…ˆèˆ‡æ¥æ‰‹é¤è»Šç§ä¸‹å®Œæˆå ´ç§Ÿäº¤æ˜“</li>
            <li>å¡«å¯«æ¥æ‰‹é¤è»Šè³‡è¨Šå’Œæ›ç­å¯†ç¢¼å³å¯å®Œæˆè½‰è®“</li>
            <li>è½‰è®“æˆåŠŸå¾Œï¼Œ<strong>ç³»çµ±æœƒè‡ªå‹•é€šçŸ¥<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a></strong>ï¼šã€Œè¨Šæ¯å·²è½‰çµ¦ <span style="color: #FF8A00; font-weight: bold;">[æ¥æ‰‹é¤è»Šåç¨±]</span> å”åŠ©è½‰è®“æ’ç­ã€</li>
          </ul>
        </div>
        
        <div class="help-section" style="margin-top: 20px;">
          <h4 style="color: #dc3545; font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-times-circle"></i> å–æ¶ˆé ç´„
          </h4>
          <ul style="line-height: 1.8; color: #555; font-size: 0.9rem; padding-left: 20px;">
            <li>å¦‚éœ€å–æ¶ˆé ç´„ï¼Œè«‹<strong>è¯ç¹«<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å®˜æ–¹å°å¹«æ‰‹</a></strong>å”åŠ©è™•ç†</li>
            <li>æä¾›æ‚¨çš„<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px;">é¤è»Šåç¨±</span>ã€<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px;">é ç´„æ—¥æœŸ</span>ã€<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px;">å ´åœ°åç¨±</span></li>
            <li>å°å¹«æ‰‹ç¢ºèªå¾Œå°‡ç‚ºæ‚¨å–æ¶ˆæ’ç­</li>
          </ul>
        </div>
        
        <div class="help-section" style="margin-top: 20px;">
          <h4 style="color: #6c5ce7; font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-hand-holding-usd"></i> æ¥æ‰‹é€¾æœŸæ’ç­
          </h4>
          <ul style="line-height: 1.8; color: #555; font-size: 0.9rem; padding-left: 20px;">
            <li>é€¾æœŸæœªä»˜æ¬¾çš„æ’ç­æœƒé¡¯ç¤º<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">âŒ é€¾ç¹³å¯æ’</span></li>
            <li>é»æ“Šè©²æ’ç­å³å¯æ¥æ‰‹ï¼Œå¡«å¯«æ‚¨çš„é¤è»Šè³‡è¨Š</li>
            <li>æ¥æ‰‹å¾Œéœ€åœ¨24å°æ™‚å…§å®Œæˆä»˜æ¬¾</li>
          </ul>
        </div>
        
        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3; border-radius: 10px; padding: 15px; margin-top: 20px; text-align: center;">
          <p style="margin: 0 0 10px 0; color: #1976d2; font-size: 1rem; font-weight: bold;">
            <i class="fas fa-headset"></i> éœ€è¦å”åŠ©ï¼Ÿ
          </p>
          <button onclick="openOfficialAccount(); closeHelpModal();" style="background: linear-gradient(135deg, #00C300, #00A000); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 195, 0, 0.3);">
            <i class="fab fa-line"></i> è¯ç¹«å®˜æ–¹å°å¹«æ‰‹
          </button>
        </div>
        
      </div>
    </div>
  </div>
</div>

<!-- é€¾æœŸæ¥æ‰‹å½ˆçª— -->
<div id="takeoverModal" class="payment-modal">
  <div class="payment-modal-content">
    <div class="payment-header">
      <h3><i class="fas fa-hand-holding-usd"></i> æ¥æ‰‹é ç´„</h3>
      <span class="modal-close" onclick="closeTakeoverModal()">&times;</span>
    </div>
    <div class="payment-body" style="padding: 18px;">
      <div class="takeover-info">
        <div class="alert-warning" style="padding: 8px 10px; margin-bottom: 10px;">
          <i class="fas fa-exclamation-triangle"></i>
          <p style="font-size: 0.82rem; margin: 0;">æ­¤é ç´„å·²é€¾æœŸï¼Œå¯æ¥æ‰‹</p>
        </div>
        
        <div class="original-booking-info" style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
          <h4 style="margin: 0; font-size: 0.88rem; line-height: 1.4; color: #495057;">
            åŸé ç´„ï¼š<span id="originalVendor" style="color: #dc3545; font-weight: bold;"></span><br>
            <span style="font-size: 0.82rem; color: #6c757d;">
              <i class="fas fa-map-marker-alt" style="font-size: 0.75rem;"></i> <span id="takeoverLocation"></span> | 
              <i class="fas fa-calendar" style="font-size: 0.75rem;"></i> <span id="takeoverDate"></span>
            </span>
          </h4>
        </div>
        
        <div class="takeover-form">
          <h4 style="margin-bottom: 10px; font-size: 0.9rem; color: #FF4B2B;">æ‚¨çš„è³‡è¨Š</h4>
          
          <label style="margin-top: 8px; font-size: 0.85rem;">åº—å <span style="color: red;">*</span></label>
          <input type="text" id="takeoverVendorName" placeholder="è«‹è¼¸å…¥é¤è»Šåç¨±" required style="margin-top: 4px; font-size: 0.9rem; padding: 8px;">
          
          <label style="margin-top: 8px; font-size: 0.85rem;">é¡å‹ <span style="color: red;">*</span></label>
          <select id="takeoverFoodType" required style="margin-top: 4px; font-size: 0.9rem; padding: 8px;">
            <option value="">è«‹é¸æ“‡</option>
            <option value="ä¸»é£Ÿé¡">ä¸»é£Ÿé¡</option>
            <option value="ç”œé»é¡">ç”œé»é¡</option>
            <option value="å°é»é¡">å°é»é¡</option>
            <option value="ä¸­å¼é¤é»">ä¸­å¼é¤é»</option>
            <option value="çƒ¤è…¿å¥—é¤">çƒ¤è…¿å¥—é¤</option>
            <option value="ç”œå“é¡">ç”œå“é¡</option>
            <option value="å°åƒé¡å‹">å°åƒé¡å‹</option>
          </select>
          
          <div class="locked-info" style="margin-top: 8px;">
            <label style="margin: 0; font-size: 0.85rem;"><i class="fas fa-dollar-sign"></i> å ´åœ°è²»</label>
            <div class="fee-input-group" style="margin-top: 4px;">
              <i class="fas fa-coins" style="font-size: 0.9rem; left: 10px;"></i>
              <input type="text" value="600å…ƒ/å¤©" disabled readonly style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #2e7d32; font-weight: bold; cursor: not-allowed; border: 2px solid #4caf50; padding: 8px; padding-left: 32px; font-size: 0.88rem;">
            </div>
          </div>
          
          <div class="takeover-notice" style="background: #e7f3ff; border: 1px solid #2196f3; border-radius: 6px; padding: 8px 10px; margin-top: 10px;">
            <p style="font-size: 0.8rem; margin: 0; color: #1976d2;"><i class="fas fa-clock"></i> æ¥æ‰‹å¾Œéœ€åœ¨24å°æ™‚å…§ä»˜æ¬¾</p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
            <button id="takeoverSubmitBtn" class="submit" onclick="submitTakeover()" style="background: linear-gradient(135deg,#ffc107,#ff9800); margin: 0; padding: 10px 8px; font-size: 0.88rem;">
              <i class="fas fa-hand-holding"></i> ç¢ºèªæ¥æ‰‹
            </button>
            <button class="submit" onclick="closeTakeoverModal(); showPaymentModal();" style="background: linear-gradient(135deg,#28a745,#20c997); margin: 0; padding: 10px 8px; font-size: 0.88rem;">
              <i class="fas fa-credit-card"></i> åŸç­ç¹³è²»
            </button>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px 10px; margin-top: 10px;">
            <p style="margin: 0; color: #856404; font-size: 0.78rem; line-height: 1.4;">
              <i class="fas fa-exclamation-triangle"></i> <strong>åŸç­ç¹³è²»ï¼š</strong><span style="color: #dc3545; font-weight: bold;">é²ç¹³</span>ä»å¯èƒ½<span style="color: #dc3545; font-weight: bold;">è¢«æ’ç­</span>ï¼Œè«‹å„˜å¿«é€šçŸ¥<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: underline;">å°å¹«æ‰‹</a>ç¢ºèª
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* ä½¿ç”¨æ•™å­¸æŒ‰éˆ•æ¨£å¼ */
.help-btn {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(135deg, #17a2b8, #138496);
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.help-btn:hover {
  background: linear-gradient(135deg, #138496, #117a8b);
  transform: translateY(-50%) scale(1.1);
  box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
}

.help-btn i {
  font-size: 1rem;
}

/* ä½¿ç”¨æ•™å­¸å½ˆçª—æ¨£å¼ */
.help-section {
  margin-bottom: 20px;
}

.help-section:last-of-type {
  margin-bottom: 0;
}

.help-section ul {
  margin: 0;
}

.help-section li {
  margin-bottom: 10px;
}

.help-section li:last-child {
  margin-bottom: 0;
}

/* åœ‹å®šå‡æ—¥æ¨™è¨˜æ¨£å¼ - åƒ…ç”¨æ–¼å››ç¶­è·¯60è™Ÿ */
.holiday-badge {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
  font-size: 0.7rem;
  padding: 3px 6px;
  border-radius: 4px;
  margin-top: 4px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
  animation: pulse 2s ease-in-out infinite;
}

.calendar-day.holiday-date {
  border: 2px solid #dc3545 !important;
  background: linear-gradient(135deg, #fff5f5, #ffe6e6) !important;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.05);
    opacity: 0.9;
  }
}

/* ä»˜æ¬¾ç‹€æ…‹æ¨£å¼ - èˆ‡æ—¥æœŸæ•¸å­—æ°´å¹³å°é½Šï¼Œå¯é»æ“Šï¼Œè‡ªå‹•æ›è¡Œï¼Œæ–‡å­—è‡ªå‹•ç¸®æ”¾ */
.payment-status {
  position: absolute;
  top: 8px;
  left: 6px;
  right: 6px;
  font-size: clamp(0.55rem, 1vw, 0.7rem);
  text-align: center;
  z-index: 5;
  white-space: normal;
  max-width: calc(100% - 12px);
  line-height: 1.2;
  background: transparent;
  cursor: pointer; /* å¯é»æ“Š */
  word-break: keep-all;
}

.payment-status span {
  display: inline-block;
  padding: 2px 5px;
  border-radius: 4px;
  font-weight: bold;
  line-height: 1.3;
  font-size: clamp(0.5rem, 0.9vw, 0.65rem);
  transition: all 0.3s;
  white-space: normal;
  word-break: keep-all;
  max-width: 100%;
}

.payment-status span:hover {
  transform: scale(1.15);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.payment-status .paid {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.payment-status .unpaid {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.payment-status .unpaid.urgent {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  animation: blink 1s ease-in-out infinite;
}

.payment-status .unpaid.overdue {
  background: #dc3545;
  color: white;
  border: 1px solid #bd2130;
  animation: shake 0.5s ease-in-out infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  75% { transform: translateX(2px); }
}

/* æ—¥æ›†äº‹ä»¶å®¹å™¨æ¨£å¼èª¿æ•´ */
.event-container {
  position: relative;
  padding: 2px;
  min-height: 40px;
  display: flex;
  flex-direction: column;
  justify-content: center; /* å‚ç›´ç½®ä¸­ */
  width: 100%;
}

.event-item {
  cursor: pointer;
  padding: 5px 7px;
  border-radius: 4px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  line-height: 1.3;
  text-align: center;
  background: #FF8A00; /* æ˜ç¢ºçš„èƒŒæ™¯è‰² */
  color: white;
  min-height: 22px;
  /* ç§»é™¤ margin-topï¼Œè®“å®ƒè‡ªç„¶ç½®ä¸­ */
}

.event-item:hover {
  opacity: 0.8;
}

/* å–æ¶ˆæŒ‰éˆ•æ¨£å¼å„ªåŒ– - å³ä¸Šè§’ */
.cancel-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 16px;
  height: 16px;
  background: rgba(220, 53, 69, 0.95);
  border: 1px solid white;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 16;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.cancel-btn:hover {
  background: #dc3545;
  transform: scale(1.15);
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}

/* é€¾æœŸæ¥æ‰‹æŒ‰éˆ• - å·¦ä¸Šæ–¹ï¼ˆé¿å…å’Œå–æ¶ˆæŒ‰éˆ•é‡ç–Šï¼‰ */
.takeover-btn {
  position: absolute;
  top: -6px;
  left: -6px;
  width: 14px;
  height: 14px;
  background: #ffc107;
  color: #000;
  border: 1px solid white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 9px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 15;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.takeover-btn:hover {
  background: #ff9800;
  transform: scale(1.15);
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}

/* æ—¥æ›†ç¹³è²»æŒ‰éˆ• - å·¦ä¸Šæ–¹ï¼ˆç¶ è‰²ï¼Œé¿å…å’Œå½ˆçª—æŒ‰éˆ•é‡è¤‡ï¼‰ */
.calendar-payment-btn {
  position: absolute;
  top: -6px;
  left: -6px;
  width: 14px;
  height: 14px;
  background: rgba(40, 167, 69, 0.95);
  color: white;
  border: 1px solid white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 9px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  z-index: 15;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.calendar-payment-btn:hover {
  background: #28a745;
  transform: scale(1.15);
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}

/* é˜²æ­¢è¼¸å…¥æ¡†èšç„¦æ™‚å½ˆçª—ç¸®æ”¾ */
.payment-modal-content,
.bank-modal-content,
.cancel-modal-content,
.password-modal-content {
  transform: none !important;
  transition: none !important;
}

.payment-modal-content *,
.bank-modal-content *,
.cancel-modal-content *,
.password-modal-content * {
  -webkit-tap-highlight-color: transparent;
}

/* ç§»é™¤æ‰€æœ‰è¼¸å…¥æ¡†çš„ focus ç¸®æ”¾æ•ˆæœ */
#takeoverModal input:focus,
#takeoverModal select:focus,
#transferModal input:focus,
#transferModal select:focus,
#passwordModal input:focus {
  transform: none !important;
}

/* é€¾æœŸæ¥æ‰‹å½ˆçª—æ¨£å¼ */
.alert-warning {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.alert-warning i {
  color: #856404;
  font-size: 1.5rem;
}

.alert-warning p {
  color: #856404;
  font-weight: 600;
  margin: 0;
}

.original-booking-info {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.original-booking-info h4 {
  color: #495057;
  margin-bottom: 10px;
  font-size: 1rem;
}

.detail-item {
  display: flex;
  padding: 8px 0;
  border-bottom: 1px solid #e9ecef;
}

.detail-item:last-child {
  border-bottom: none;
}

.detail-item label {
  font-weight: bold;
  color: #6c757d;
  min-width: 100px;
}

.detail-item span {
  color: #212529;
}

.takeover-form {
  margin-top: 20px;
}

.takeover-form h4 {
  color: #FF4B2B;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

.takeover-form label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
  color: #555;
}

.takeover-form input,
.takeover-form select {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 2px solid #e9ecef;
  border-radius: 6px;
  font-size: 1rem;
}

.takeover-form input:focus,
.takeover-form select:focus {
  border-color: #FF8A00;
  outline: none;
  box-shadow: 0 0 0 3px rgba(255, 139, 0, 0.1);
  transform: none !important;
}

.locked-info {
  margin-top: 15px;
}

.takeover-notice {
  background: #e7f3ff;
  border: 1px solid #2196f3;
  border-radius: 6px;
  padding: 12px;
  margin-top: 15px;
}

.takeover-notice p {
  color: #1976d2;
  margin: 0;
  font-size: 0.9rem;
}

.takeover-submit-btn {
  width: 100%;
  margin-top: 20px;
}
</style>

<script>
// æ™‚é–“æˆ³è¨˜æ ¼å¼åŒ–å‡½æ•¸ï¼ˆåªåˆ°ç§’æ•¸ï¼Œä¸å«æ¯«ç§’ï¼‰
function formatTimestamp(date = new Date()) {
  return date.toISOString().split('.')[0] + 'Z'; // ç§»é™¤æ¯«ç§’ï¼Œä¿ç•™Z
}

// å¤šå ´åœ°è¦å‰‡é…ç½®
const locationConfigs = {
  "å››ç¶­è·¯59è™Ÿ": {
    name: "æ¥Šæ¢…å€å››ç¶­è·¯59è™Ÿ",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯59è™Ÿ",
    type: "æˆ¶å¤–å ´åœ°",
    days: [1, 2, 3, 4, 5, 6, 0], // æ•´å€‹æœˆéƒ½å¯ä»¥æ’
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Šï¼Œé¤è»Šé«˜åº¦é™åˆ¶",
      ban: "æ²¹ç‚¸è½åœ°æ”¤ã€ç…™éœ§å¤ªå¤§ã€é£²æ–™è»Š",
      special: "æ•´æœˆéƒ½å¯æ’ç­"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "ç¦æ­¢æ²¹ç‚¸è½åœ°æ”¤ï¼Œå…¶ä»–å¯ä»¥ä¸é™ï¼Œç¦ç…™éœ§å¤ªå¤§",
      "ç¦æ­¢é£²æ–™åŠé£²æ–™è»Š",
      "é¤è»Šé«˜åº¦é™åˆ¶ï¼Œè«‹ç‰¹åˆ¥æ³¨æ„",
      "æˆ¿æ±å¾ˆæ³¨é‡åœ°æ¿è¦è¨˜å¾—é‹ªåœ°å¢Š",
      "æ¡¶ä»”é›ç…™éœ§å¤ªå¤§ä¸è¡Œ",
      "ç™¼é›»æ©Ÿè€å¼å¤ªåµä¸è¡Œ"
    ]
  },
  "å››ç¶­è·¯60è™Ÿ": {
    name: "æ¥Šæ¢…å€å››ç¶­è·¯60è™Ÿ",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯60è™Ÿ",
    type: "æˆ¶å¤–å ´åœ°",
    days: [1, 2, 3], // é€±ä¸€~é€±ä¸‰å¯ä»¥ç‡Ÿæ¥­
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Š",
      ban: "æ²¹ç‚¸è½åœ°æ”¤ã€ç…™éœ§å¤ªå¤§",
      special: "è©²å ´åœ°é€±ä¸€~é€±ä¸‰ç‡Ÿæ¥­ï¼Œåœ‹å®šå‡æ—¥ä¼‘æ¯"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "è¦é å·¦é‚Šç›´åœç‚ºä¸»",
      "ä½¿ç”¨é¢ç©è¼ƒå°çš„é¤è»Šå¯ä»¥æ©«æ”¾",
      "è½åœ°æ”¤ä¹Ÿå¯ä»¥æ©«æ”¾",
      "ç¦æ­¢æ²¹ç‚¸è½åœ°æ”¤ã€ç…™éœ§å¤ªå¤§"
    ]
  },
  "æ¼¢å ¡å¤§äº¨": {
    name: "æ¼¢å ¡å¤§äº¨",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯70è™Ÿ",
    type: "åˆä½œåº—é¢",
    days: [1, 2, 3, 4, 5, 6], // åªæœ‰é€±æ—¥ä¼‘ï¼Œå…¶å®ƒæ—¥éƒ½å¯ä»¥æ’
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Šã€ä¸è¦æŠŠè»Šé–‹ä¸Šç£ç£š",
      ban: "æ²¹ç…™éœ§å¤ªå¤§ã€é£²æ–™è»Š",
      special: "è©²å ´åœ°é€±æ—¥ä¼‘æ¯"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "åƒ…é™1è»Šï¼Œè«‹å‹¿æŠŠè»Šé–‹ä¸Šç£ç£š",
      "ç¦æ­¢æ²¹ç…™éœ§å¤ªå¤§çš„é¤è»Š",
      "ç¦æ­¢é£²æ–™è»Š",
      "éœ€é…åˆåº—é¢ç‡Ÿæ¥­æ™‚é–“"
    ]
  },
  "è‡ªç”±é¢¨": {
    name: "è‡ªç”±é¢¨",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯190è™Ÿ",
    type: "åˆä½œåº—é¢",
    days: [0, 1, 2, 4, 5], // é€±ä¸‰ã€é€±å…­ä¸æ’ï¼Œå…¶å®ƒéƒ½å¯æ’
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Šï¼Œéœ€é…åˆåº—é¢ç‡Ÿæ¥­",
      ban: "ç…™éœ§å¤ªå¤§ã€é£²æ–™è»Š",
      special: "é€±ä¸‰é€±å…­ä¸æ’"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "åƒ…é™1è»Šï¼Œéœ€é…åˆåº—é¢ç‡Ÿæ¥­",
      "ç¦æ­¢ç…™éœ§å¤ªå¤§çš„é¤è»Š",
      "ç¦æ­¢é£²æ–™è»Š",
      "é€±ä¸‰ã€é€±å…­ä¸é–‹æ”¾æ’ç­"
    ]
  },
  "è”¬è’”": {
    name: "è”¬è’”",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯216è™Ÿ",
    type: "å¥åº·è”¬é£Ÿ",
    days: [3, 6], // åªæœ‰é€±ä¸‰ã€é€±å…­å¯æ’
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Šï¼Œä¸è¦è·Ÿåº—é¢å¼·ç¢°å•†å“",
      ban: "é£²æ–™è»Šã€ç´ é£Ÿ",
      special: "åªæœ‰é€±ä¸‰ã€é€±å…­å¯æ’ç­"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "åƒ…é™1è»Šï¼Œè«‹å‹¿èˆ‡åº—é¢å•†å“å¼·ç¢°",
      "åªæœ‰é€±ä¸‰ã€é€±å…­å¯æ’ç­",
      "ç¦æ­¢é£²æ–™è»Šã€ç´ é£Ÿ",
      "å»ºè­°å¥åº·è”¬é£Ÿé¡å‹é¤è»Š"
    ]
  },
  "é‡‘æ­£å¥½åƒ": {
    name: "é‡‘æ­£å¥½åƒ",
    address: "æ¥Šæ¢…å€å››ç¶­è·¯218è™Ÿ",
    type: "ç¾é£Ÿå»£å ´",
    days: [2], // åªæœ‰é€±äºŒå¯ä»¥æ’ç­
    slots: ["14:00-20:00"],
    price: {
      "14:00-20:00": "600å…ƒ"
    },
    info: {
      hours: "14:00-20:00",
      fee: "600å…ƒ/å¤©",
      limit: "åƒ…é™1è»Š",
      ban: "ç…™éœ§å¤ªå¤§ã€å™ªéŸ³éå¤§",
      special: "è©²å ´åœ°åƒ…é™é€±äºŒç‡Ÿæ¥­"
    },
    notices: [
      "ä¸ä¾›æ°´ã€ä¸ä¾›é›»ï¼Œéœ€è‡ªè¡Œæ¸…æ½”ç’°å¢ƒåŠåƒåœ¾è™•ç†",
      "åƒ…é™1è»Š",
      "ç¦æ­¢ç…™éœ§å¤ªå¤§çš„é¤è»Š",
      "ç¦æ­¢å™ªéŸ³éå¤§çš„è¨­å‚™",
      "åƒ…é™é€±äºŒç‡Ÿæ¥­"
    ]
  }
};

// å·²é ç´„çš„æ—¥æœŸå’Œæ™‚æ®µ - æ ¹æ“šGoogle Sheets 10æœˆä»½å¯¦éš›æ’ç­è³‡æ–™
// å·²é ç´„æ™‚æ®µ - ç¾åœ¨å®Œå…¨å¾ Google Sheets å‹•æ…‹è¼‰å…¥
const bookedSlots = {
  "å››ç¶­è·¯59è™Ÿ": {},
  "å››ç¶­è·¯60è™Ÿ": {},
  "æ¼¢å ¡å¤§äº¨": {},
  "è‡ªç”±é¢¨": {},
  "è”¬è’”": {},
  "é‡‘æ­£å¥½åƒ": {}
};

// ç•¶å‰é¸ä¸­çš„å ´åœ°
let currentLocation = "å››ç¶­è·¯59è™Ÿ";

// å ´åœ°åˆ†é åˆ‡æ›
document.querySelectorAll('.location-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // ç§»é™¤æ‰€æœ‰activeé¡
    document.querySelectorAll('.location-tab').forEach(t => t.classList.remove('active'));
    // æ·»åŠ activeé¡åˆ°ç•¶å‰é¸ä¸­
    tab.classList.add('active');
    
    // æ›´æ–°ç•¶å‰å ´åœ°
    currentLocation = tab.dataset.location;
    
    // æ›´æ–°è¡¨å–®ä¸­çš„å ´åœ°é¸æ“‡
    document.getElementById('location').value = currentLocation;
    
    // è§¸ç™¼å ±åè¡¨å ´åœ°é¸æ“‡çš„changeäº‹ä»¶
    document.getElementById('location').dispatchEvent(new Event('change'));
    
    // æ›´æ–°å ´åœ°è³‡è¨Šé¡¯ç¤º
    updateLocationInfo(currentLocation);
    
    // æ›´æ–°è¡Œäº‹æ›†ç¯©é¸
    currentFilter = currentLocation;
    // æ›´æ–°è¡Œäº‹æ›†ç¯©é¸æŒ‰éˆ•çš„activeç‹€æ…‹
    document.querySelectorAll('.location-filter .filter-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.location === currentLocation) {
        btn.classList.add('active');
      }
    });
    // é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†
    renderCalendar();
  });
});

// æ›´æ–°å ´åœ°è³‡è¨Šé¡¯ç¤º
function updateLocationInfo(location) {
  const config = locationConfigs[location];
  if (!config) return;
  
  // é¡¯ç¤ºå®Œæ•´åœ°å€ä½œç‚ºæ¨™é¡Œ
  let displayTitle = config.address; // ä½¿ç”¨åœ°å€è€Œéåç¨±
  
  // å¦‚æœæ˜¯åº—é¢å ´åœ°ï¼Œå¯ä»¥åœ¨åœ°å€å¾ŒåŠ ä¸Šåº—åèªªæ˜
  if (config.type !== 'æˆ¶å¤–å ´åœ°') {
    displayTitle = `${config.address} (${location})`;
  }
  
  let specialNotice = '';
  if (config.info.special) {
    specialNotice = `
      <div class="special-notice">
        <i class="fas fa-exclamation-triangle"></i>
        <span>${config.info.special}</span>
      </div>
    `;
  }
  
  const locationInfo = document.getElementById('locationInfo');
  locationInfo.innerHTML = `
    <h3><i class="fas fa-map-marker-alt"></i> ${displayTitle}</h3>
    ${specialNotice}
    <div class="info-grid">
      <div class="info-item">
        <i class="fas fa-clock"></i>
        <span><strong>ç‡Ÿæ¥­æ™‚é–“ï¼š</strong>${config.info.hours}</span>
      </div>
      <div class="info-item">
        <i class="fas fa-dollar-sign"></i>
        <span><strong>è²»ç”¨ï¼š</strong>${config.info.fee}</span>
      </div>
      <div class="info-item">
        <i class="fas fa-truck"></i>
        <span><strong>é™åˆ¶ï¼š</strong>${config.info.limit}</span>
      </div>
      <div class="info-item">
        <i class="fas fa-ban"></i>
        <span><strong>ç¦æ­¢ï¼š</strong>${config.info.ban}</span>
      </div>
    </div>
  `;
  
  // æ›´æ–°æ³¨æ„äº‹é …
  const noticeBox = document.getElementById('noticeBox');
  if (noticeBox && config.notices) {
    const noticesList = config.notices.map(notice => `<li>${notice}</li>`).join('');
    noticeBox.innerHTML = `
      <h4><i class="fas fa-exclamation-triangle"></i> é‡è¦æ³¨æ„äº‹é …</h4>
      <ul>
        ${noticesList}
      </ul>
    `;
  }
}

// 2025å¹´ä¸»è¦åœ‹å®šå‡æ—¥åˆ—è¡¨
const nationalHolidays2025 = [
  '2025-01-01', // å…ƒæ—¦
  '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-03', // æ˜¥ç¯€é€£å‡
  '2025-04-04', '2025-04-05', '2025-04-06', '2025-04-07', // æ¸…æ˜ç¯€é€£å‡
  '2025-05-01', // å‹å‹•ç¯€
  '2025-05-31', // ç«¯åˆç¯€
  '2025-10-06', '2025-10-07', '2025-10-08', // ä¸­ç§‹ç¯€é€£å‡
  '2025-10-10', '2025-10-11', '2025-10-12', '2025-10-13', // åœ‹æ…¶æ—¥é€£å‡
  '2025-12-25'  // è–èª•ç¯€
];

// ç”Ÿæˆå¯ç”¨æ—¥æœŸé¸é … - å®Œå…¨åˆ†é›¢æ¢ä»¶ç‰ˆæœ¬
function generateAvailableDates(location) {
  const locationConfig = locationConfigs[location];
  if (!locationConfig) {
    console.log('æ‰¾ä¸åˆ°å ´åœ°é…ç½®:', location);
    return [];
  }
  
  const availableDates = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // æ¢ä»¶1ï¼šç”Ÿæˆæœªä¾†3å€‹æœˆçš„æ‰€æœ‰æ—¥æœŸï¼ˆç•¶å‰æœˆä»½ + æœªä¾†2å€‹æœˆï¼‰
  const currentMonth = today.getMonth() + 1; // 1-12
  const currentYear = today.getFullYear();
  
  // ç”Ÿæˆç•¶å‰æœˆä»½å’Œæœªä¾†2å€‹æœˆçš„æ‰€æœ‰æ—¥æœŸ
  for (let i = 0; i < 3; i++) {
    const targetMonth = currentMonth + i;
    const targetYear = currentYear;
    
    let year, month;
    if (targetMonth > 12) {
      year = targetYear + Math.floor((targetMonth - 1) / 12);
      month = ((targetMonth - 1) % 12) + 1;
    } else {
      year = targetYear;
      month = targetMonth;
    }
    
    const daysInMonth = new Date(year, month, 0).getDate();
    
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month - 1, day);
      const dayOfWeek = date.getDay();
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      // æ¢ä»¶2ï¼šåªè™•ç†æœªä¾†æ—¥æœŸï¼ˆå ±åç”¨ï¼‰
      if (date < today) continue;
      
      // æ¢ä»¶3ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºè©²å ´åœ°çš„ç‡Ÿæ¥­æ—¥
      if (!locationConfig.days.includes(dayOfWeek)) continue;
      
      // æ¢ä»¶4ï¼šç‰¹åˆ¥è™•ç†å››ç¶­è·¯60è™Ÿçš„åœ‹å®šå‡æ—¥ï¼ˆç›´æ¥è·³éï¼Œä¸å¯é¸æ“‡ï¼‰
      if (location === 'å››ç¶­è·¯60è™Ÿ' && nationalHolidays2025.includes(dateStr)) {
        console.log(`å››ç¶­è·¯60è™Ÿåœ‹å®šå‡æ—¥ä¸å¯é ç´„: ${dateStr} (${getHolidayName(dateStr)})`);
        continue; // åœ‹å®šå‡æ—¥ç›´æ¥è·³éï¼Œä¸æ·»åŠ åˆ°å¯é¸æ—¥æœŸ
      }
      
      // æ¢ä»¶5ï¼šæª¢æŸ¥æ—¥æ›†ä¸Šæ˜¯å¦å·²æœ‰é¤è»Šé ç´„ï¼ˆåŒ…å«æœ¬åœ°å’ŒGoogle Sheetsï¼‰
      const hasEvent = allEvents.some(event => {
        let eventDate;
        if (event.start instanceof Date) {
          eventDate = event.start.toISOString().split('T')[0];
        } else {
          eventDate = event.start.split('T')[0];
        }
        return eventDate === dateStr && event.location === location;
      });
      
      // æ¢ä»¶5.5ï¼šæª¢æŸ¥Google Sheetsä¸­æ˜¯å¦å·²æœ‰é ç´„
      const hasSheetBooking = sheetsBookedDates[location] && 
        sheetsBookedDates[location].some(booking => booking.standardDate === dateStr);
      
      // æ¢ä»¶6ï¼šæ™‚é–“æ§åˆ¶æª¢æŸ¥ï¼ˆç¨ç«‹æ¢ä»¶ï¼‰- é¡¯ç¤º3å€‹æœˆ
      const currentDay = today.getDate();
      const isTimeControlled = true; // é¡¯ç¤º3å€‹æœˆçš„æ’ç­æ—¥æœŸ
      // const isTimeControlled = checkTimeControl(year, month, currentYear, currentMonth, currentDay);
      
      // åªæœ‰é€šéæ‰€æœ‰æ¢ä»¶çš„æ—¥æœŸæ‰åŠ å…¥é¸é …ï¼ˆæ’é™¤æœ¬åœ°é ç´„å’ŒSheetsé ç´„ï¼‰
      if (!hasEvent && !hasSheetBooking && isTimeControlled) {
        const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const displayDate = `${month}æœˆ${day}æ—¥(${dayNames[dayOfWeek]})`;
        availableDates.push({
          value: dateStr,
          text: displayDate,
          dayOfWeek: dayOfWeek
        });
      }
    }
  }
  
  // æŒ‰æ—¥æœŸæ’åº
  availableDates.sort((a, b) => a.value.localeCompare(b.value));
  
  console.log(`å ´åœ°: ${location}, æœ€çµ‚å¯ç”¨æ—¥æœŸæ•¸é‡: ${availableDates.length}`);
  return availableDates;
}

// å–æ¶ˆé ç´„åŠŸèƒ½
function cancelBooking(event, dateStr) {
  // é¡¯ç¤ºå–æ¶ˆé ç´„å½ˆçª—
  showCancelModal(event, dateStr);
}

// é¡¯ç¤ºå–æ¶ˆé ç´„å½ˆçª—
function showCancelModal(event, dateStr) {
  // å¡«å……é ç´„è©³æƒ…
  document.getElementById('cancelVendorName').textContent = event.title;
  document.getElementById('cancelLocation').textContent = event.location;
  document.getElementById('cancelDate').textContent = dateStr;
  
  // å„²å­˜ç•¶å‰äº‹ä»¶å’Œæ—¥æœŸä¾›å¾ŒçºŒä½¿ç”¨
  window.currentCancelEvent = event;
  window.currentCancelDate = dateStr;
  
  // é¡¯ç¤ºå½ˆçª—
  const modal = document.getElementById('cancelModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰å–æ¶ˆé ç´„å½ˆçª—
function closeCancelModal() {
  const modal = document.getElementById('cancelModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥å½ˆçª—
function showPasswordInput() {
  closeCancelModal();
  const modal = document.getElementById('passwordModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // èšç„¦åˆ°å¯†ç¢¼è¼¸å…¥æ¡†
  setTimeout(() => {
    document.getElementById('passwordInput').focus();
  }, 100);
}

// é—œé–‰å¯†ç¢¼è¼¸å…¥å½ˆçª—
function closePasswordModal() {
  const modal = document.getElementById('passwordModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
  
  // æ¸…ç©ºå¯†ç¢¼è¼¸å…¥æ¡†
  document.getElementById('passwordInput').value = '';
}

// é¡¯ç¤ºä½¿ç”¨æ•™å­¸å½ˆçª—
function showHelpModal() {
  const modal = document.getElementById('helpModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰ä½¿ç”¨æ•™å­¸å½ˆçª—
function closeHelpModal() {
  const modal = document.getElementById('helpModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// é¡¯ç¤ºç¾¤çµ„ç‰ˆè¦å½ˆçª—
function showRulesModal() {
  const modal = document.getElementById('rulesModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰ç¾¤çµ„ç‰ˆè¦å½ˆçª—
function closeRulesModal() {
  const modal = document.getElementById('rulesModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// é¡¯ç¤ºä¸‹è¼‰ç´ æå½ˆçª—
function showDownloadModal() {
  const modal = document.getElementById('downloadModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰ä¸‹è¼‰ç´ æå½ˆçª—
function closeDownloadModal() {
  const modal = document.getElementById('downloadModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// é¡¯ç¤ºæ’ç­é‡‹å‡ºå½ˆçª—
function showTransferModal(event, dateStr) {
  console.log('========== é–‹å•Ÿæ’ç­é‡‹å‡ºå½ˆçª— ==========');
  console.log('äº‹ä»¶è³‡è¨Š:', event);
  
  // å¡«å……åŸé ç´„è³‡è¨Š
  document.getElementById('transferOriginalVendor').textContent = event.title;
  document.getElementById('transferLocation').textContent = event.location;
  
  // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
  const date = new Date(dateStr);
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
  const dayName = dayNames[date.getDay()];
  const formattedDate = `${month}æœˆ${day}æ—¥(${dayName})`;
  
  document.getElementById('transferDate').textContent = formattedDate;
  
  // å„²å­˜é‡‹å‡ºè³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
  window.currentTransferEvent = {
    originalEvent: event,
    dateStr: dateStr,
    formattedDate: formattedDate,
    location: event.location,
    rowNumber: event.rowNumber
  };
  
  console.log('ä¿å­˜çš„é‡‹å‡ºè³‡è¨Š:', window.currentTransferEvent);
  
  // æ¸…ç©ºè¡¨å–®
  document.getElementById('transferVendorName').value = '';
  document.getElementById('transferFoodType').value = '';
  document.getElementById('transferPassword').value = '';
  
  // é¡¯ç¤ºå½ˆçª—
  const modal = document.getElementById('transferModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰æ’ç­é‡‹å‡ºå½ˆçª—
function closeTransferModal() {
  const modal = document.getElementById('transferModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
  
  // æ¸…ç©ºè¡¨å–®
  document.getElementById('transferVendorName').value = '';
  document.getElementById('transferFoodType').value = '';
  document.getElementById('transferPassword').value = '';
}

// æäº¤æ’ç­é‡‹å‡º
async function submitTransfer() {
  const newVendor = document.getElementById('transferVendorName').value.trim();
  const newFoodType = document.getElementById('transferFoodType').value;
  const password = document.getElementById('transferPassword').value;
  
  // é©—è­‰è¡¨å–®
  if (!newVendor || !newFoodType || !password) {
    showToast('error', 'è¡¨å–®éŒ¯èª¤', 'è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
    return;
  }
  
  // é©—è­‰å¯†ç¢¼
  if (password !== 'sky36990') {
    showToast('error', 'å¯†ç¢¼éŒ¯èª¤', 'æ›ç­å¯†ç¢¼ä¸æ­£ç¢º');
    document.getElementById('transferPassword').value = '';
    return;
  }
  
  if (!window.currentTransferEvent) {
    showToast('error', 'éŒ¯èª¤', 'ç„¡æ³•ç²å–é‡‹å‡ºè³‡è¨Š');
    return;
  }
  
  const transferData = window.currentTransferEvent;
  
  console.log('========== é‡‹å‡ºæ“ä½œè©³ç´°è³‡è¨Š ==========');
  console.log('åŸäº‹ä»¶è³‡è¨Š:', transferData.originalEvent);
  console.log('åŸäº‹ä»¶ rowNumber:', transferData.originalEvent.rowNumber);
  console.log('transferData rowNumber:', transferData.rowNumber);
  console.log('===================================');
  
  // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„è¡Œè™Ÿ
  const targetRowNumber = transferData.originalEvent.rowNumber || transferData.rowNumber;
  
  // æº–å‚™é‡‹å‡ºæ•¸æ“š
  const formData = {
    vendor: newVendor,
    foodType: newFoodType,
    location: transferData.location,
    date: transferData.dateStr,
    timeSlot: '14:00-20:00',
    fee: '600',
    rowNumber: targetRowNumber, // ä½¿ç”¨æ­£ç¢ºçš„è¡Œè™Ÿ
    action: 'transfer', // æ¨™è¨˜ç‚ºé‡‹å‡ºæ“ä½œ
    originalVendor: transferData.originalEvent.title // è¨˜éŒ„åŸé¤è»Š
  };
  
  console.log('========== æº–å‚™æäº¤çš„é‡‹å‡ºæ•¸æ“š ==========');
  console.log('å®Œæ•´æ•¸æ“š:', formData);
  console.log('è¡Œè™Ÿ rowNumber:', formData.rowNumber);
  console.log('action:', formData.action);
  console.log('===================================');
  
  // é¡¯ç¤ºè¼‰å…¥æç¤º
  showLoading('ğŸ”„ æ­£åœ¨è™•ç†æ’ç­è½‰è®“...');
  
  try {
    // æäº¤åˆ°Google Sheets
    const result = await submitToGoogleSheets(formData);
    
    // æª¢æŸ¥æäº¤çµæœ
    if (result.success) {
      hideLoading();
      showToast('success', 'è½‰è®“æˆåŠŸï¼', `âœ… æ’ç­å·²è½‰è®“\nğŸ“¤ åŸï¼š${transferData.originalEvent.title}\nğŸ“¥ æ–°ï¼š${newVendor}`);
      
      // æ›´æ–°æœ¬åœ°äº‹ä»¶
      const eventIndex = allEvents.findIndex(e => 
        e === transferData.originalEvent ||
        (e.location === transferData.location && e.start.split('T')[0] === transferData.dateStr)
      );
      
      if (eventIndex >= 0) {
        allEvents[eventIndex] = {
          ...allEvents[eventIndex],
          title: newVendor,
          foodType: newFoodType,
          payment: 'å·²ä»˜æ¬¾', // ä¿æŒå·²ä»˜æ¬¾ç‹€æ…‹
          note: `è½‰å‡ºè‡ª: ${transferData.originalEvent.title}`
        };
      }
      
      // é‡æ–°æ¸²æŸ“æ—¥æ›†
      renderCalendar();
      saveToLocalStorage();
      
      // é—œé–‰å½ˆçª—
      closeTransferModal();
      
      // å¤šæ¬¡åŒæ­¥ç¢ºèªæ›´æ–°
      setTimeout(async () => {
        try {
          console.log('é‡‹å‡ºå¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ2ç§’å¾Œï¼‰...');
          await fetchBookingsFromGoogleSheets();
          await fetchBookedDatesFromSheets();
          mergeSheetsDataToCalendar();
          renderCalendar();
          console.log('é‡‹å‡ºå¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ');
        } catch (error) {
          console.error('é‡‹å‡ºå¾ŒåŒæ­¥å¤±æ•—:', error);
        }
      }, 2000);
      
      setTimeout(async () => {
        try {
          console.log('é‡‹å‡ºå¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ4ç§’å¾Œï¼‰...');
          await fetchBookingsFromGoogleSheets();
          mergeSheetsDataToCalendar();
          renderCalendar();
          console.log('é‡‹å‡ºå¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ');
        } catch (error) {
          console.error('é‡‹å‡ºå¾ŒåŒæ­¥å¤±æ•—:', error);
        }
      }, 4000);
      
    } else {
      throw new Error('Google Sheetsæäº¤å¤±æ•—');
    }
    
  } catch (error) {
    console.error('é‡‹å‡ºå¤±æ•—:', error);
    hideLoading();
    showToast('error', 'é‡‹å‡ºå¤±æ•—', 'ç„¡æ³•å®Œæˆé‡‹å‡ºæ“ä½œï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

// é¡¯ç¤ºé€¾æœŸæ¥æ‰‹å½ˆçª—
function showTakeoverModal(event, dateStr) {
  console.log('========== é–‹å•Ÿæ¥æ‰‹å½ˆçª— ==========');
  console.log('äº‹ä»¶è³‡è¨Š:', event);
  console.log('äº‹ä»¶rowNumber:', event.rowNumber);
  console.log('äº‹ä»¶source:', event.source);
  
  // å¡«å……åŸé ç´„è³‡è¨Š
  document.getElementById('originalVendor').textContent = event.title;
  document.getElementById('takeoverLocation').textContent = event.location;
  
  // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
  const date = new Date(dateStr);
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
  const dayName = dayNames[date.getDay()];
  const formattedDate = `${month}æœˆ${day}æ—¥(${dayName})`;
  
  document.getElementById('takeoverDate').textContent = formattedDate;
  
  // å„²å­˜æ¥æ‰‹è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
  window.currentTakeoverEvent = {
    originalEvent: event,
    dateStr: dateStr,
    formattedDate: formattedDate,
    location: event.location,
    rowNumber: event.rowNumber // ä¿å­˜è¡Œè™Ÿç”¨æ–¼æ›´æ–°
  };
  
  console.log('ä¿å­˜çš„æ¥æ‰‹è³‡è¨Š:', window.currentTakeoverEvent);
  console.log('===================================');
  
  // æ¸…ç©ºè¡¨å–®
  document.getElementById('takeoverVendorName').value = '';
  document.getElementById('takeoverFoodType').value = '';
  
  // é¡¯ç¤ºå½ˆçª—
  const modal = document.getElementById('takeoverModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// é—œé–‰é€¾æœŸæ¥æ‰‹å½ˆçª—
function closeTakeoverModal() {
  const modal = document.getElementById('takeoverModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
  
  // æ¸…ç©ºè¡¨å–®
  document.getElementById('takeoverVendorName').value = '';
  document.getElementById('takeoverFoodType').value = '';
}

// æäº¤æ¥æ‰‹é ç´„
async function submitTakeover() {
  const newVendor = document.getElementById('takeoverVendorName').value.trim();
  const newFoodType = document.getElementById('takeoverFoodType').value;
  
  // é©—è­‰è¡¨å–®
  if (!newVendor || !newFoodType) {
    showToast('error', 'è¡¨å–®éŒ¯èª¤', 'è«‹å®Œæ•´å¡«å¯«å¿…è¦æ¬„ä½');
    return;
  }
  
  if (!window.currentTakeoverEvent) {
    showToast('error', 'éŒ¯èª¤', 'ç„¡æ³•ç²å–æ¥æ‰‹è³‡è¨Š');
    return;
  }
  
  const takeoverData = window.currentTakeoverEvent;
  
  console.log('æ¥æ‰‹æ“ä½œ - åŸäº‹ä»¶è³‡è¨Š:', takeoverData.originalEvent);
  console.log('æ¥æ‰‹æ“ä½œ - rowNumber:', takeoverData.rowNumber);
  
  // æº–å‚™æ¥æ‰‹æ•¸æ“š
  const formData = {
    vendor: newVendor,
    foodType: newFoodType,
    location: takeoverData.location,
    date: takeoverData.dateStr,
    timeSlot: '14:00-20:00',
    fee: '600',
    timestamp: formatTimestamp(),
    rowNumber: takeoverData.rowNumber || takeoverData.originalEvent.rowNumber, // ç”¨æ–¼è¦†è“‹æ›´æ–°
    action: 'takeover', // æ¨™è¨˜ç‚ºæ¥æ‰‹æ“ä½œ
    originalVendor: takeoverData.originalEvent.title // è¨˜éŒ„åŸé¤è»Š
  };
  
  console.log('æ¥æ‰‹æ“ä½œ - æäº¤æ•¸æ“š:', formData);
  
  // é¡¯ç¤ºè¼‰å…¥æç¤º
  showToast('info', 'è™•ç†ä¸­', 'ğŸ¤ æ­£åœ¨ç‚ºæ‚¨æ¥æ‰‹æ’ç­...');
  
  // ç¦ç”¨æŒ‰éˆ•
  const submitBtn = document.getElementById('takeoverSubmitBtn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
  submitBtn.disabled = true;
  
  try {
    // åªæäº¤åˆ°Google Sheetsï¼ˆGitHubå·²ç¦ç”¨ï¼‰
    const result = await submitToGoogleSheets(formData);
    
    // æª¢æŸ¥æäº¤çµæœ
    if (result.success) {
      showToast('success', 'æ¥æ‰‹æˆåŠŸï¼', `ğŸ‰ ${newVendor} å·²æˆåŠŸæ¥æ‰‹\nğŸ“ ${takeoverData.location}\nğŸ“… ${takeoverData.formattedDate}`);
      
      // æ›´æ–°æœ¬åœ°äº‹ä»¶
      const eventIndex = allEvents.findIndex(e => 
        e === takeoverData.originalEvent ||
        (e.location === takeoverData.location && e.start.split('T')[0] === takeoverData.dateStr)
      );
      
      if (eventIndex >= 0) {
        allEvents[eventIndex] = {
          ...allEvents[eventIndex],
          title: newVendor,
          foodType: newFoodType,
          timestamp: formatTimestamp(),
          payment: 'å°šæœªä»˜æ¬¾',
          source: 'takeover' // æ¨™è¨˜ç‚ºæ¥æ‰‹çš„é ç´„
        };
      }
      
      // é‡æ–°æ¸²æŸ“æ—¥æ›†
      renderCalendar();
      saveToLocalStorage();
      
      // é—œé–‰å½ˆçª—
      closeTakeoverModal();
      
      // ç«‹å³é‡æ–°æ¸²æŸ“æ—¥æ›†ï¼Œé¡¯ç¤ºæœ¬åœ°æ›´æ–°
      renderCalendar();
      
      // é¡¯ç¤ºç¹³è²»å½ˆçª—
      setTimeout(() => {
        showPaymentModal();
      }, 500);
      
      // å¤šæ¬¡åŒæ­¥Google Sheetsç¢ºèªæ›´æ–°ï¼ˆç¢ºä¿çœ‹åˆ°è®ŠåŒ–ï¼‰
      // ç­‰å¾… Google Sheets æ›´æ–°å®Œæˆ
      setTimeout(async () => {
        try {
          console.log('â±ï¸ ç­‰å¾…2ç§’è®“ Google Sheets å®Œæˆæ›´æ–°...');
        } catch (error) {}
      }, 2000);
      
      setTimeout(async () => {
        try {
          console.log('æ¥æ‰‹å¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ3ç§’å¾Œï¼‰...');
          await fetchBookingsFromGoogleSheets();
          await fetchBookedDatesFromSheets();
          mergeSheetsDataToCalendar();
          renderCalendar();
          console.log('æ¥æ‰‹å¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ');
        } catch (error) {
          console.error('æ¥æ‰‹å¾Œç¬¬1æ¬¡åŒæ­¥å¤±æ•—:', error);
        }
      }, 3000);
      
      setTimeout(async () => {
        try {
          console.log('æ¥æ‰‹å¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ5ç§’å¾Œï¼‰...');
          await fetchBookingsFromGoogleSheets();
          await fetchBookedDatesFromSheets();
          mergeSheetsDataToCalendar();
          renderCalendar();
          console.log('æ¥æ‰‹å¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ');
        } catch (error) {
          console.error('æ¥æ‰‹å¾Œç¬¬2æ¬¡åŒæ­¥å¤±æ•—:', error);
        }
      }, 5000);
      
      setTimeout(async () => {
        try {
          console.log('æ¥æ‰‹å¾Œç¬¬3æ¬¡åŒæ­¥ï¼ˆ7ç§’å¾Œï¼‰...');
          await fetchBookingsFromGoogleSheets();
          mergeSheetsDataToCalendar();
          renderCalendar();
          console.log('æ¥æ‰‹å¾Œç¬¬3æ¬¡åŒæ­¥å®Œæˆ - æ‡‰è©²çœ‹åˆ°æ–°é¤è»Šåç¨±');
        } catch (error) {
          console.error('æ¥æ‰‹å¾Œç¬¬3æ¬¡åŒæ­¥å¤±æ•—:', error);
        }
      }, 7000);
      
    } else {
      throw new Error('Google Sheetsæäº¤å¤±æ•—');
    }
    
  } catch (error) {
    console.error('æ¥æ‰‹å¤±æ•—:', error);
    showToast('error', 'æ¥æ‰‹å¤±æ•—', 'ç„¡æ³•å®Œæˆæ¥æ‰‹æ“ä½œï¼Œè«‹ç¨å¾Œå†è©¦');
    
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
}

// æ³¨æ„ï¼šå·²ç§»é™¤ cancelBookingFromGoogleSheets å‡½æ•¸
// å–æ¶ˆé ç´„ç¾åœ¨åªè™•ç†æœ¬åœ°æ•¸æ“šå’ŒGitHubåŒæ­¥
// Google Sheetsçš„è¨˜éŒ„éœ€è¦æ‰‹å‹•åˆªé™¤

// ä¸Šå‚³å–æ¶ˆé ç´„åˆ°GitHub
async function uploadCancellationToGitHub(event, dateStr) {
  try {
    // ç¢ºä¿cancellationsç›®éŒ„å­˜åœ¨
    await createGitHubDirectory('cancellations');
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `cancellations/cancellation-${timestamp}.json`;
    
    const cancellationData = {
      action: 'cancellation',
      vendor: event.title,
      location: event.location,
      date: dateStr,
      timeSlot: '14:00-20:00',
      cancelledAt: formatTimestamp(),
      timestamp: formatTimestamp(), // æ·»åŠ æ™‚é–“æˆ³ç”¨æ–¼æ’åº
      uploadTime: Date.now(), // æ¯«ç§’ç´šæ™‚é–“æˆ³
      reason: 'user_cancellation'
    };
    
    const content = JSON.stringify(cancellationData, null, 2);
    const encodedContent = safeBase64Encode(content);
    
    console.log('æº–å‚™ä¸Šå‚³å–æ¶ˆè¨˜éŒ„åˆ°GitHub:', {
      filename,
      data: cancellationData,
      encodedLength: encodedContent.length
    });
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `å–æ¶ˆé¤è»Šé ç´„: ${event.title} - ${event.location} - ${dateStr}`,
        content: encodedContent,
        branch: GITHUB_CONFIG.branch
      })
    });
    
    console.log('GitHubå–æ¶ˆAPIå›æ‡‰ç‹€æ…‹:', response.status, response.statusText);
    
    if (response.ok) {
      const result = await response.json();
      console.log('å–æ¶ˆé ç´„ä¸Šå‚³åˆ°GitHubæˆåŠŸ:', result);
      
      // ä¸Šå‚³æˆåŠŸå¾Œï¼Œç«‹å³æ›´æ–°index.htmlå’Œå³æ™‚æ•¸æ“šæ–‡ä»¶
      try {
        await Promise.all([
          updateIndexHtmlOnGitHub(cancellationData),
          updateRealtimeDataFile()
        ]);
        console.log('å–æ¶ˆé ç´„å¾Œindex.htmlå’Œå³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°æˆåŠŸ');
      } catch (updateError) {
        console.error('å–æ¶ˆé ç´„å¾Œæ›´æ–°æ–‡ä»¶å¤±æ•—:', updateError);
        // ä¸å½±éŸ¿ä¸»è¦ä¸Šå‚³æµç¨‹ï¼Œåªè¨˜éŒ„éŒ¯èª¤
      }
      
      return { success: true, url: result.content.html_url };
    } else {
      const errorText = await response.text();
      console.error('å–æ¶ˆé ç´„ä¸Šå‚³åˆ°GitHubå¤±æ•— - ç‹€æ…‹:', response.status);
      console.error('å–æ¶ˆé ç´„ä¸Šå‚³åˆ°GitHubå¤±æ•— - å›æ‡‰:', errorText);
      
      let errorMessage = 'GitHubä¸Šå‚³å¤±æ•—';
      try {
        const error = JSON.parse(errorText);
        errorMessage = error.message || errorMessage;
        console.error('GitHubå–æ¶ˆéŒ¯èª¤è©³æƒ…:', error);
      } catch (e) {
        console.error('ç„¡æ³•è§£æå–æ¶ˆéŒ¯èª¤å›æ‡‰:', errorText);
      }
      
      throw new Error(errorMessage);
    }
  } catch (error) {
    console.error('å–æ¶ˆé ç´„ä¸Šå‚³åˆ°GitHubéŒ¯èª¤:', error);
    throw error;
  }
}

// é©—è­‰å¯†ç¢¼ä¸¦å–æ¶ˆé ç´„
async function verifyPassword() {
  const password = document.getElementById('passwordInput').value;
  const event = window.currentCancelEvent;
  const dateStr = window.currentCancelDate;
  
  if (!password) {
    showToast('error', 'å¯†ç¢¼éŒ¯èª¤', 'è«‹è¼¸å…¥å¯†ç¢¼');
    return;
  }
  
  if (password !== 'sky36990') {
    showToast('error', 'å¯†ç¢¼éŒ¯èª¤', 'å–æ¶ˆå¯†ç¢¼ä¸æ­£ç¢ºï¼Œç„¡æ³•å–æ¶ˆé ç´„');
    document.getElementById('passwordInput').value = '';
    return;
  }
  
  // å¯†ç¢¼æ­£ç¢ºï¼Œç›´æ¥åŸ·è¡Œå–æ¶ˆé ç´„ï¼ˆä¸å†é¡¯ç¤ºäºŒæ¬¡ç¢ºèªï¼‰
  closePasswordModal();
  
  // ç›´æ¥åŸ·è¡Œå–æ¶ˆï¼ˆå¯†ç¢¼é©—è­‰å·²ç¶“æ˜¯ç¢ºèªæ­¥é©Ÿï¼‰
  if (true) {
    // é¡¯ç¤ºè¼‰å…¥æç¤º
    showToast('info', 'è™•ç†ä¸­', 'ğŸ—‘ï¸ æ­£åœ¨ç‚ºæ‚¨å–æ¶ˆæ’ç­...');
    
    // å˜—è©¦å¾Google Sheetsåˆªé™¤ï¼ˆç„¡è«–ä¾†æºï¼Œéƒ½å˜—è©¦åˆªé™¤ï¼‰
    try {
      const deleteData = {
        action: 'delete',
        vendor: event.title,
        location: event.location,
        date: dateStr, // ISOæ ¼å¼ï¼ŒGoogle Apps Scriptæœƒè‡ªå‹•è½‰æ›
        rowNumber: event.rowNumber, // å¦‚æœæœ‰çš„è©±
        timestamp: event.timestamp // å¯èƒ½éœ€è¦ç”¨æ–¼æŸ¥æ‰¾
      };
      
      console.log('========== åˆªé™¤é ç´„ ==========');
      console.log('è¦åˆªé™¤çš„é¤è»Š:', event.title);
      console.log('è¦åˆªé™¤çš„å ´åœ°:', event.location);
      console.log('è¦åˆªé™¤çš„æ—¥æœŸ:', dateStr);
      console.log('å®Œæ•´åˆªé™¤æ•¸æ“š:', deleteData);
      console.log('äº‹ä»¶ä¾†æº:', event.source);
      console.log('äº‹ä»¶rowNumber:', event.rowNumber);
      console.log('ğŸ¯ åªæœƒåˆªé™¤ç¬¦åˆä»¥ä¸Šä¸‰å€‹æ¢ä»¶ï¼ˆé¤è»Š+å ´åœ°+æ—¥æœŸï¼‰çš„é‚£ä¸€ç­†');
      console.log('===========================');
      
      const result = await submitToGoogleSheets(deleteData);
      console.log('Google Sheetsåˆªé™¤APIå›æ‡‰:', result);
      
      if (result.success) {
        console.log('âœ… Google Sheetsåˆªé™¤æˆåŠŸ - æ•´è¡Œå·²ç§»é™¤ï¼ˆåŒ…å«æ‰€æœ‰9å€‹æ¬„ä½ï¼‰');
        showToast('success', 'åˆªé™¤æˆåŠŸ', `å·²å¾ Google Sheets å®Œæ•´åˆªé™¤æ•´è¡Œè³‡æ–™`);
      } else {
        console.warn('âš ï¸ Google Sheetsåˆªé™¤å¯èƒ½å¤±æ•—ï¼Œä½†ç¹¼çºŒæœ¬åœ°åˆªé™¤');
        showToast('warning', 'åˆªé™¤è­¦å‘Š', 'Google Sheetsåˆªé™¤å¯èƒ½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥');
      }
    } catch (error) {
      console.error('âŒ å¾Google Sheetsåˆªé™¤å¤±æ•—:', error);
      // å³ä½¿Sheetsåˆªé™¤å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒæœ¬åœ°åˆªé™¤
    }
    
    // å¾ allEvents ä¸­ç§»é™¤äº‹ä»¶
    const eventIndex = allEvents.findIndex(e => 
      e.title === event.title && 
      e.location === event.location && 
      e.start === event.start
    );
    
    if (eventIndex !== -1) {
      allEvents.splice(eventIndex, 1);
    }
    
    // ä¸å†æ‰‹å‹•æ›´æ–° bookedSlotsï¼Œç­‰å¾… Google Sheets åŒæ­¥å¾Œè‡ªå‹•é‡å»º
    // bookedSlots æœƒåœ¨ mergeSheetsDataToCalendar ä¸­æ¸…ç©ºä¸¦é‡å»º
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆåªä¿å­˜ allEventsï¼‰
    saveToLocalStorage();
    
    // é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†
    renderCalendar();
    
    // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯åŒä¸€å€‹å ´åœ°ï¼Œé‡æ–°ç”Ÿæˆå¯ç”¨æ—¥æœŸé¸é …
    const currentLocation = document.getElementById('location').value;
    if (currentLocation === event.location) {
      const availableDates = generateAvailableDates(currentLocation);
      const dateSelect = document.getElementById('availableDates');
      dateSelect.innerHTML = '<option value="">é¸æ“‡å¯ç”¨æ—¥æœŸ</option>';
      availableDates.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date.value;
        opt.textContent = date.text;
        dateSelect.appendChild(opt);
      });
    }
    
    // å…ˆä¸é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼Œç­‰åŒæ­¥ç¢ºèªå¾Œå†é¡¯ç¤º
    
    // å¤šæ¬¡åŒæ­¥Google Sheetsç¢ºèªåˆªé™¤ï¼ˆç¢ºä¿åˆªé™¤ç”Ÿæ•ˆï¼‰
    // Google Sheets API å¯èƒ½éœ€è¦2-3ç§’è™•ç†åˆªé™¤æ“ä½œ
    setTimeout(async () => {
      try {
        console.log('â±ï¸ ç­‰å¾…2ç§’è®“ Google Sheets å®Œæˆåˆªé™¤...');
      } catch (error) {
        console.error('å»¶é²éŒ¯èª¤:', error);
      }
    }, 2000);
    
    setTimeout(async () => {
      try {
        console.log('å–æ¶ˆå¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ3ç§’å¾Œï¼‰...');
        await fetchBookingsFromGoogleSheets();
        await fetchBookedDatesFromSheets();
        mergeSheetsDataToCalendar();
        renderCalendar();
        console.log('å–æ¶ˆå¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ');
        
        // é©—è­‰åˆªé™¤æ˜¯å¦æˆåŠŸ
        console.log('ğŸ” é©—è­‰åˆªé™¤ï¼šå°‹æ‰¾', {
          é¤è»Š: event.title,
          å ´åœ°: event.location,
          æ—¥æœŸ: dateStr
        });
        
        const stillExists = allEvents.some(e => {
          const eventDateStr = e.start instanceof Date ? 
            `${e.start.getFullYear()}-${String(e.start.getMonth() + 1).padStart(2, '0')}-${String(e.start.getDate()).padStart(2, '0')}` : 
            (typeof e.start === 'string' ? e.start.split('T')[0] : '');
          
          const matches = e.title === event.title && 
                          e.location === event.location && 
                          eventDateStr === dateStr;
          
          if (matches) {
            console.log('æ‰¾åˆ°åŒ¹é…:', {
              é¤è»Š: e.title,
              å ´åœ°: e.location,
              æ—¥æœŸ: eventDateStr
            });
          }
          
          return matches;
        });
        
        console.log('ç•¶å‰ allEvents ç¸½æ•¸:', allEvents.length);
        console.log('è©²é¤è»ŠåŒå ´åœ°çš„æ‰€æœ‰é ç´„:', allEvents.filter(e => 
          e.title === event.title && e.location === event.location
        ).map(e => ({
          é¤è»Š: e.title,
          æ—¥æœŸ: e.start instanceof Date ? e.start.toISOString().split('T')[0] : e.start.split('T')[0]
        })));
        
        if (stillExists) {
          console.warn('âš ï¸ é ç´„å¯èƒ½é‚„å­˜åœ¨ï¼Œå°‡é€²è¡Œç¬¬2æ¬¡åŒæ­¥...');
        } else {
          console.log('âœ… ç¢ºèªåˆªé™¤æˆåŠŸ - æŒ‡å®šæ—¥æœŸçš„é ç´„å·²ç§»é™¤');
          showToast('success', 'å–æ¶ˆæˆåŠŸ', `âœ… ${event.title} çš„æ’ç­å·²å–æ¶ˆ\nğŸ“… æ—¥æœŸï¼š${dateStr}`);
        }
      } catch (error) {
        console.error('å–æ¶ˆå¾Œç¬¬1æ¬¡åŒæ­¥å¤±æ•—:', error);
      }
    }, 3000);
    
    setTimeout(async () => {
      try {
        console.log('å–æ¶ˆå¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ5ç§’å¾Œï¼‰...');
        await fetchBookingsFromGoogleSheets();
        await fetchBookedDatesFromSheets();
        mergeSheetsDataToCalendar();
        renderCalendar();
        console.log('å–æ¶ˆå¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ');
        
        // æœ€çµ‚é©—è­‰
        const stillExists = allEvents.some(e => {
          const eventDateStr = e.start instanceof Date ? 
            `${e.start.getFullYear()}-${String(e.start.getMonth() + 1).padStart(2, '0')}-${String(e.start.getDate()).padStart(2, '0')}` : 
            (typeof e.start === 'string' ? e.start.split('T')[0] : '');
          
          return e.title === event.title && 
                 e.location === event.location && 
                 eventDateStr === dateStr;
        });
        
        if (stillExists) {
          console.error('âŒ åˆªé™¤å¯èƒ½å¤±æ•—ï¼Œé ç´„ä»å­˜åœ¨');
          showToast('warning', 'åˆªé™¤è­¦å‘Š', 'é ç´„å¯èƒ½æœªå®Œå…¨åˆªé™¤ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ Google Sheets');
        } else {
          console.log('âœ…âœ… æœ€çµ‚ç¢ºèªåˆªé™¤æˆåŠŸ');
        }
      } catch (error) {
        console.error('å–æ¶ˆå¾Œç¬¬2æ¬¡åŒæ­¥å¤±æ•—:', error);
      }
    }, 5000);
    
    // ç¬¬3æ¬¡ç¢ºèªåŒæ­¥ï¼ˆ7ç§’å¾Œï¼‰
    setTimeout(async () => {
      try {
        console.log('å–æ¶ˆå¾Œç¬¬3æ¬¡åŒæ­¥ï¼ˆ7ç§’å¾Œï¼‰...');
        await fetchBookingsFromGoogleSheets();
        mergeSheetsDataToCalendar();
        renderCalendar();
        console.log('å–æ¶ˆå¾Œç¬¬3æ¬¡åŒæ­¥å®Œæˆ - æœ€çµ‚ç¢ºèª');
      } catch (error) {
        console.error('å–æ¶ˆå¾Œç¬¬3æ¬¡åŒæ­¥å¤±æ•—:', error);
      }
    }, 7000);
  }
}

// GitHubé…ç½®
const GITHUB_CONFIG = {
  token: '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',
  owner: 'sky770825',
  repo: 'foodcarcalss',
  branch: 'main'
};

// Google Sheetsé…ç½®
// è«‹å°‡æ­¤URLæ›¿æ›ç‚ºæ‚¨çš„Google Apps Script Web App URL
// éƒ¨ç½²å¾Œçš„URLæ ¼å¼é¡ä¼¼ï¼šhttps://script.google.com/macros/s/AKfycby.../exec
const GOOGLE_SHEETS_CONFIG = {
  // å°‡Google Apps Scriptéƒ¨ç½²ç‚ºWeb Appå¾Œï¼Œå°‡URLè²¼åœ¨é€™è£¡
  webAppUrl: 'https://script.google.com/macros/s/AKfycbw7EEhQ3bhM_32WXUMrSeqcuEdawUft9ChQJbWXTMzXJjHiztZbQHQ0U69E6HNYDbn1/exec',
  enabled: true, // è¨­ç‚ºfalseå¯åœç”¨Google SheetsåŒæ­¥
  autoSync: true, // è‡ªå‹•åŒæ­¥
  syncInterval: 30000 // åŒæ­¥é–“éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé è¨­30ç§’
};

// å…¨å±€è®Šæ•¸ï¼šå„²å­˜å¾Google Sheetsè®€å–çš„æ•¸æ“š
let sheetsBookings = [];
let sheetsBookedDates = {}; // å„²å­˜å¾Sheetsè®€å–çš„å·²é ç´„æ—¥æœŸ
let lastSheetsSyncTime = null;
let lastBookedDatesSyncTime = null;
let isSyncingWithSheets = false;

// å®‰å…¨çš„Base64ç·¨ç¢¼å‡½æ•¸ï¼ˆæ”¯æ´ä¸­æ–‡å­—ç¬¦ï¼‰
function safeBase64Encode(str) {
  try {
    return btoa(unescape(encodeURIComponent(str)));
  } catch (error) {
    console.error('Base64ç·¨ç¢¼å¤±æ•—:', error);
    throw new Error('æ•¸æ“šç·¨ç¢¼å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ•¸æ“šæ ¼å¼');
  }
}

// å‰µå»ºGitHubç›®éŒ„
async function createGitHubDirectory(directoryName) {
  try {
    console.log(`å˜—è©¦å‰µå»ºç›®éŒ„: ${directoryName}`);
    
    // å‰µå»ºREADMEæ–‡ä»¶ä¾†å»ºç«‹ç›®éŒ„
    const readmeContent = `# ${directoryName}\n\næ­¤ç›®éŒ„ç”¨æ–¼å­˜å„²é¤è»Šé ç´„ç³»çµ±çš„${directoryName === 'bookings' ? 'é ç´„' : 'å–æ¶ˆ'}è¨˜éŒ„ã€‚\n\n## æ–‡ä»¶æ ¼å¼\n\næ¯å€‹æ–‡ä»¶éƒ½æ˜¯JSONæ ¼å¼ï¼ŒåŒ…å«é ç´„æˆ–å–æ¶ˆçš„è©³ç´°ä¿¡æ¯ã€‚`;
    const encodedContent = safeBase64Encode(readmeContent);
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${directoryName}/README.md`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `å‰µå»º${directoryName}ç›®éŒ„`,
        content: encodedContent,
        branch: GITHUB_CONFIG.branch
      })
    });
    
    if (response.ok) {
      console.log(`æˆåŠŸå‰µå»ºç›®éŒ„: ${directoryName}`);
      return true;
    } else {
      const errorText = await response.text();
      console.log(`ç›®éŒ„å¯èƒ½å·²å­˜åœ¨æˆ–å‰µå»ºå¤±æ•—: ${directoryName}`, response.status, errorText);
      return false;
    }
  } catch (error) {
    console.error(`å‰µå»ºç›®éŒ„å¤±æ•—: ${directoryName}`, error);
    return false;
  }
}

// ä¸Šå‚³æ•¸æ“šåˆ°GitHub
async function uploadToGitHub(data, retryCount = 0) {
  const MAX_RETRIES = 3;
  
  try {
    // ç¢ºä¿ç›®éŒ„å­˜åœ¨
    await createGitHubDirectory('bookings');
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `bookings/booking-${timestamp}.json`;
    
    // ç¢ºä¿æ•¸æ“šåŒ…å«ç²¾ç¢ºçš„æ™‚é–“æˆ³
    const dataWithTimestamp = {
      ...data,
      timestamp: formatTimestamp(),
      uploadTime: Date.now() // æ¯«ç§’ç´šæ™‚é–“æˆ³ï¼Œç”¨æ–¼ç²¾ç¢ºæ’åº
    };
    
    const content = JSON.stringify(dataWithTimestamp, null, 2);
    const encodedContent = safeBase64Encode(content);
    
    console.log('æº–å‚™ä¸Šå‚³åˆ°GitHub:', {
      filename,
      data: dataWithTimestamp,
      encodedLength: encodedContent.length
    });
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `æ–°å¢é¤è»Šé ç´„: ${data.vendor} - ${data.location} - ${data.date}`,
        content: encodedContent,
        branch: GITHUB_CONFIG.branch
      })
    });
    
    console.log('GitHub APIå›æ‡‰ç‹€æ…‹:', response.status, response.statusText);
    
    if (response.ok) {
      const result = await response.json();
      console.log('GitHubä¸Šå‚³æˆåŠŸ:', result);
      
      // ä¸Šå‚³æˆåŠŸå¾Œï¼Œç«‹å³æ›´æ–°index.htmlå’Œå³æ™‚æ•¸æ“šæ–‡ä»¶
      try {
        await Promise.all([
          updateIndexHtmlOnGitHub(dataWithTimestamp),
          updateRealtimeDataFile()
        ]);
        console.log('index.htmlå’Œå³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°æˆåŠŸ');
      } catch (updateError) {
        console.error('æ›´æ–°æ–‡ä»¶å¤±æ•—:', updateError);
        // ä¸å½±éŸ¿ä¸»è¦ä¸Šå‚³æµç¨‹ï¼Œåªè¨˜éŒ„éŒ¯èª¤
      }
      
      return { success: true, url: result.content.html_url };
    } else {
      const errorText = await response.text();
      console.error('GitHubä¸Šå‚³å¤±æ•— - ç‹€æ…‹:', response.status);
      console.error('GitHubä¸Šå‚³å¤±æ•— - å›æ‡‰:', errorText);
      
      let errorMessage = 'GitHubä¸Šå‚³å¤±æ•—';
      try {
        const error = JSON.parse(errorText);
        errorMessage = error.message || errorMessage;
        console.error('GitHubéŒ¯èª¤è©³æƒ…:', error);
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
        if (response.status === 401) {
          errorMessage = 'GitHubèªè­‰å¤±æ•— - Tokenå¯èƒ½å·²éæœŸï¼Œè«‹æª¢æŸ¥Tokenè¨­ç½®';
        } else if (response.status === 403) {
          errorMessage = 'GitHubæ¬Šé™ä¸è¶³ - è«‹æª¢æŸ¥Tokenæ¬Šé™å’Œå€‰åº«è¨­ç½®';
        } else if (response.status === 422) {
          errorMessage = 'GitHubæ•¸æ“šæ ¼å¼éŒ¯èª¤ - è«‹æª¢æŸ¥æ•¸æ“šæ ¼å¼';
        } else if (response.status === 404) {
          errorMessage = 'GitHubå€‰åº«ä¸å­˜åœ¨ - è«‹æª¢æŸ¥å€‰åº«åç¨±å’Œæ¬Šé™';
        }
      } catch (e) {
        console.error('ç„¡æ³•è§£æéŒ¯èª¤å›æ‡‰:', errorText);
      }
      
      throw new Error(errorMessage);
    }
  } catch (error) {
    console.error('GitHubä¸Šå‚³éŒ¯èª¤:', error);
    
    // é‡è©¦æ©Ÿåˆ¶
    if (retryCount < MAX_RETRIES && (
      error.name === 'TypeError' || 
      error.message.includes('fetch') ||
      error.message.includes('network')
    )) {
      console.log(`é‡è©¦ä¸Šå‚³ (${retryCount + 1}/${MAX_RETRIES})...`);
      await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // éå¢å»¶é²
      return uploadToGitHub(data, retryCount + 1);
    }
    
    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      throw new Error('ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
    } else if (error.message.includes('401')) {
      throw new Error('GitHubèªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥Token');
    } else if (error.message.includes('403')) {
      throw new Error('GitHubæ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥å€‰åº«æ¬Šé™');
    } else if (error.message.includes('422')) {
      throw new Error('GitHubæ•¸æ“šæ ¼å¼éŒ¯èª¤');
    }
    
    throw error;
  }
}

// æ›´æ–°GitHubä¸Šçš„index.htmlæ–‡ä»¶
async function updateIndexHtmlOnGitHub(bookingData) {
  try {
    console.log('é–‹å§‹æ›´æ–°GitHubä¸Šçš„index.html...');
    
    // é¦–å…ˆç²å–ç•¶å‰çš„index.htmlå…§å®¹
    const currentIndexResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/index.html`, {
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github+json'
      }
    });
    
    if (!currentIndexResponse.ok) {
      throw new Error(`ç„¡æ³•ç²å–ç•¶å‰index.html: ${currentIndexResponse.status}`);
    }
    
    const currentIndexData = await currentIndexResponse.json();
    const currentContent = atob(currentIndexData.content);
    
    // è§£æç•¶å‰å…§å®¹ï¼Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†
    let updatedContent = currentContent;
    
    // ç²å–æº–ç¢ºçš„çµ±è¨ˆæ•¸æ“š
    const accurateStats = await calculateAccurateStats();
    
    // æ›´æ–°çµ±è¨ˆä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const statsPattern = /<div class="stats">[\s\S]*?<\/div>/;
    const statsMatch = currentContent.match(statsPattern);
    
    if (statsMatch) {
      // æ›´æ–°çµ±è¨ˆå…§å®¹
      const newStats = `<div class="stats">
        <div class="stat-item">
          <i class="fas fa-calendar-check"></i>
          <span>ç¸½é ç´„æ•¸ï¼š${accurateStats.totalBookings}</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-clock"></i>
          <span>ä»Šæ—¥é ç´„ï¼š${accurateStats.todayBookings}</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-map-marker-alt"></i>
          <span>æ´»èºå ´åœ°ï¼š${accurateStats.activeLocations}</span>
        </div>
      </div>`;
      
      updatedContent = updatedContent.replace(statsPattern, newStats);
    }
    
    // ç§»é™¤å³ä¸‹è§’çš„æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤ºï¼ˆç”¨æˆ¶è¦æ±‚éš±è—ï¼‰
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„å³ä¸‹è§’æ™‚é–“é¡¯ç¤º
    const timeDisplayPattern = /<div style="position: fixed; bottom: 10px; right: 10px; background: rgba\(0,0,0,0\.7\); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 1000;">[\s\S]*?<\/div>/g;
    updatedContent = updatedContent.replace(timeDisplayPattern, '');
    
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ç³»çµ±ä¿¡æ¯è¨»é‡‹
    const systemInfoPattern = /<!-- ç³»çµ±ä¿¡æ¯ -->[\s\S]*?<\/div>/g;
    updatedContent = updatedContent.replace(systemInfoPattern, '');
    
    // ç·¨ç¢¼æ›´æ–°å¾Œçš„å…§å®¹
    const encodedUpdatedContent = safeBase64Encode(updatedContent);
    
    // ä¸Šå‚³æ›´æ–°å¾Œçš„index.html
    const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/index.html`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `æ›´æ–°index.html - ${bookingData.action === 'cancellation' ? 'å–æ¶ˆé ç´„' : 'æ–°å¢é ç´„'}: ${bookingData.vendor} - ${bookingData.location} - ${bookingData.date}`,
        content: encodedUpdatedContent,
        branch: GITHUB_CONFIG.branch,
        sha: currentIndexData.sha // éœ€è¦æä¾›ç•¶å‰çš„SHAä»¥æ›´æ–°æ–‡ä»¶
      })
    });
    
    if (updateResponse.ok) {
      const updateResult = await updateResponse.json();
      console.log('index.htmlæ›´æ–°æˆåŠŸ:', updateResult);
      return { success: true, url: updateResult.content.html_url };
    } else {
      const errorText = await updateResponse.text();
      console.error('æ›´æ–°index.htmlå¤±æ•— - ç‹€æ…‹:', updateResponse.status);
      console.error('æ›´æ–°index.htmlå¤±æ•— - å›æ‡‰:', errorText);
      throw new Error(`æ›´æ–°index.htmlå¤±æ•—: ${updateResponse.status}`);
    }
    
  } catch (error) {
    console.error('æ›´æ–°GitHubä¸Šçš„index.htmlæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    throw error;
  }
}

// æ›´æ–°å³æ™‚æ•¸æ“šæ–‡ä»¶
async function updateRealtimeDataFile() {
  try {
    console.log('é–‹å§‹æ›´æ–°å³æ™‚æ•¸æ“šæ–‡ä»¶...');
    
    // ç²å–æ‰€æœ‰é ç´„æ•¸æ“š
    const allBookings = await fetchBookingsFromGitHub();
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const stats = await calculateAccurateStats();
    
    // æº–å‚™å³æ™‚æ•¸æ“š
    const realtimeData = {
      lastUpdated: formatTimestamp(),
      stats: stats,
      bookings: allBookings,
      summary: {
        totalBookings: stats.totalBookings,
        todayBookings: stats.todayBookings,
        activeLocations: stats.activeLocations,
        locations: [
          'å››ç¶­è·¯59è™Ÿ',
          'å››ç¶­è·¯60è™Ÿ', 
          'æ¼¢å ¡å¤§äº¨ - å››ç¶­è·¯70è™Ÿ',
          'è‡ªç”±é¢¨ - å››ç¶­è·¯190è™Ÿ',
          'è”¬è’” - å››ç¶­è·¯216è™Ÿ',
          'é‡‘æ­£å¥½åƒ - å››ç¶­è·¯218è™Ÿ'
        ]
      }
    };
    
    // ç·¨ç¢¼æ•¸æ“š
    const content = JSON.stringify(realtimeData, null, 2);
    const encodedContent = safeBase64Encode(content);
    
    // ä¸Šå‚³åˆ°GitHub
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data/realtime.json`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `æ›´æ–°å³æ™‚æ•¸æ“š - ${new Date().toLocaleString('zh-TW')}`,
        content: encodedContent,
        branch: GITHUB_CONFIG.branch
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°æˆåŠŸ:', result);
      return { success: true, url: result.content.html_url };
    } else {
      const errorText = await response.text();
      console.error('å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°å¤±æ•— - ç‹€æ…‹:', response.status);
      console.error('å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°å¤±æ•— - å›æ‡‰:', errorText);
      throw new Error(`å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°å¤±æ•—: ${response.status}`);
    }
    
  } catch (error) {
    console.error('æ›´æ–°å³æ™‚æ•¸æ“šæ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    throw error;
  }
}

// è¨ˆç®—æº–ç¢ºçš„çµ±è¨ˆæ•¸æ“š
async function calculateAccurateStats() {
  try {
    console.log('é–‹å§‹è¨ˆç®—æº–ç¢ºçš„çµ±è¨ˆæ•¸æ“š...');
    
    // ç²å–æ‰€æœ‰é ç´„å’Œå–æ¶ˆè¨˜éŒ„
    const allBookings = await fetchBookingsFromGitHub();
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    let totalBookings = 0;
    let todayBookings = 0;
    const activeLocations = new Set();
    const today = new Date().toISOString().split('T')[0];
    
    // æŒ‰æ™‚é–“æˆ³æ’åºï¼Œç¢ºä¿æ­£ç¢ºè™•ç†å–æ¶ˆæ“ä½œ
    allBookings.sort((a, b) => {
      const timeA = a.uploadTime || new Date(a.timestamp).getTime();
      const timeB = b.uploadTime || new Date(b.timestamp).getTime();
      return timeA - timeB;
    });
    
    // è¿½è¹¤æ¯å€‹é ç´„çš„ç‹€æ…‹
    const bookingStates = new Map();
    
    for (const booking of allBookings) {
      const bookingKey = `${booking.vendor}-${booking.location}-${booking.date}`;
      
      if (booking.action === 'cancellation') {
        // å–æ¶ˆé ç´„
        if (bookingStates.has(bookingKey)) {
          bookingStates.delete(bookingKey);
        }
      } else {
        // æ–°å¢é ç´„
        bookingStates.set(bookingKey, booking);
      }
    }
    
    // è¨ˆç®—æœ€çµ‚çµ±è¨ˆ
    for (const [key, booking] of bookingStates) {
      totalBookings++;
      activeLocations.add(booking.location);
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šæ—¥é ç´„
      const bookingDate = booking.date.split('T')[0];
      if (bookingDate === today) {
        todayBookings++;
      }
    }
    
    const stats = {
      totalBookings,
      todayBookings,
      activeLocations: activeLocations.size
    };
    
    console.log('çµ±è¨ˆæ•¸æ“šè¨ˆç®—å®Œæˆ:', stats);
    return stats;
    
  } catch (error) {
    console.error('è¨ˆç®—çµ±è¨ˆæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    // è¿”å›é»˜èªå€¼
    return {
      totalBookings: 0,
      todayBookings: 0,
      activeLocations: 6
    };
  }
}

// å¾GitHubç²å–æ‰€æœ‰é ç´„æ•¸æ“š
async function fetchBookingsFromGitHub() {
  try {
    const bookings = [];
    
    // ç²å–é ç´„æ•¸æ“š
    try {
      console.log('é–‹å§‹å¾GitHubç²å–é ç´„æ•¸æ“š...');
      const bookingsResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/bookings`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      console.log('GitHub bookingsç›®éŒ„å›æ‡‰ç‹€æ…‹:', bookingsResponse.status);
      
      if (bookingsResponse.ok) {
        const files = await bookingsResponse.json();
        console.log('æ‰¾åˆ°é ç´„æ–‡ä»¶æ•¸é‡:', files.length);
        
        for (const file of files) {
          if (file.name.endsWith('.json')) {
            console.log('è™•ç†æ–‡ä»¶:', file.name);
            const fileResponse = await fetch(file.download_url);
            if (fileResponse.ok) {
              const booking = await fileResponse.json();
              bookings.push(booking);
              console.log('æˆåŠŸè¼‰å…¥é ç´„:', booking.vendor, booking.date);
            } else {
              console.error('è¼‰å…¥æ–‡ä»¶å¤±æ•—:', file.name, fileResponse.status);
            }
          }
        }
      } else {
        const errorText = await bookingsResponse.text();
        console.error('ç²å–bookingsç›®éŒ„å¤±æ•—:', bookingsResponse.status, errorText);
      }
    } catch (error) {
      console.error('ç²å–é ç´„æ•¸æ“šå¤±æ•—:', error);
    }
    
    // ç²å–å–æ¶ˆè¨˜éŒ„
    try {
      const cancellationsResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/cancellations`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (cancellationsResponse.ok) {
        const files = await cancellationsResponse.json();
        
        for (const file of files) {
          if (file.name.endsWith('.json')) {
            const fileResponse = await fetch(file.download_url);
            if (fileResponse.ok) {
              const cancellation = await fileResponse.json();
              // å°‡å–æ¶ˆè¨˜éŒ„è½‰æ›ç‚ºè² é¢é ç´„è¨˜éŒ„
              const negativeBooking = {
                vendor: cancellation.vendor,
                location: cancellation.location,
                date: cancellation.date,
                timeSlot: cancellation.timeSlot,
                action: 'cancelled',
                cancelledAt: cancellation.cancelledAt
              };
              bookings.push(negativeBooking);
            }
          }
        }
      }
    } catch (error) {
      console.error('ç²å–å–æ¶ˆè¨˜éŒ„å¤±æ•—:', error);
    }
    
    return bookings;
  } catch (error) {
    console.error('ç²å–GitHubæ•¸æ“šéŒ¯èª¤:', error);
    return [];
  }
}

// =============== Google Sheets åŒæ­¥åŠŸèƒ½ ===============

// æäº¤é ç´„åˆ°Google Sheets
async function submitToGoogleSheets(formData) {
  // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨Google SheetsåŒæ­¥
  if (!GOOGLE_SHEETS_CONFIG.enabled) {
    console.log('Google SheetsåŒæ­¥æœªå•Ÿç”¨');
    return { success: false, message: 'Google SheetsåŒæ­¥æœªå•Ÿç”¨' };
  }
  
  // æª¢æŸ¥æ˜¯å¦é…ç½®äº†Web App URL
  if (GOOGLE_SHEETS_CONFIG.webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
    console.warn('è«‹å…ˆé…ç½®Google Apps Script Web App URL');
    return { success: false, message: 'æœªé…ç½®Google Sheets URL' };
  }
  
  try {
    console.log('æäº¤æ•¸æ“šåˆ°Google Sheets:', formData);
    
    // æº–å‚™è¦ç™¼é€çš„æ•¸æ“š
    const dataToSend = {
      vendor: formData.vendor,
      location: formData.location,
      date: formData.date,
      timeSlot: formData.timeSlot || '14:00-20:00',
      foodType: formData.foodType,
      fee: formData.fee || '600',
      timestamp: formData.timestamp || formatTimestamp()
    };
    
    // å¦‚æœæ˜¯æ¥æ‰‹æ“ä½œï¼Œæ·»åŠ é¡å¤–åƒæ•¸
    if (formData.action === 'takeover') {
      dataToSend.action = 'takeover';
      dataToSend.rowNumber = formData.rowNumber;
      dataToSend.originalVendor = formData.originalVendor;
      console.log('æ¥æ‰‹æ“ä½œï¼Œè¡Œè™Ÿ:', formData.rowNumber);
    }
    
    // å¦‚æœæ˜¯æ’ç­é‡‹å‡ºæ“ä½œï¼Œæ·»åŠ é¡å¤–åƒæ•¸
    if (formData.action === 'transfer') {
      dataToSend.action = 'transfer';
      dataToSend.rowNumber = formData.rowNumber;
      dataToSend.originalVendor = formData.originalVendor;
      console.log('é‡‹å‡ºæ“ä½œï¼Œè¡Œè™Ÿ:', formData.rowNumber);
    }
    
    // å¦‚æœæ˜¯åˆªé™¤æ“ä½œï¼Œæ·»åŠ é¡å¤–åƒæ•¸
    if (formData.action === 'delete') {
      dataToSend.action = 'delete';
      dataToSend.rowNumber = formData.rowNumber;
      console.log('åˆªé™¤æ“ä½œï¼Œè¡Œè™Ÿ:', formData.rowNumber);
    }
    
    // ä½¿ç”¨POSTæ–¹å¼ç™¼é€æ•¸æ“šï¼ˆé©ç”¨æ–¼Google Apps Scriptæ¥æ‰‹æ“ä½œï¼‰
    const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dataToSend),
      mode: 'no-cors' // Google Apps Scriptéœ€è¦no-corsæ¨¡å¼
    });
    
    console.log('Google Sheetså›æ‡‰:', response);
    
    // ç”±æ–¼æ˜¯no-corsæ¨¡å¼ï¼Œç„¡æ³•è®€å–å›æ‡‰å…§å®¹ï¼Œåªèƒ½å‡è¨­æˆåŠŸ
    return { success: true, message: 'å·²æäº¤åˆ°Google Sheets' };
    
  } catch (error) {
    console.error('Google Sheetsæäº¤å¤±æ•—:', error);
    throw new Error('ç„¡æ³•é€£æ¥åˆ°Google Sheets: ' + error.message);
  }
}

// å¾Google Sheetsè®€å–æ‰€æœ‰é ç´„æ•¸æ“š
async function fetchBookingsFromGoogleSheets() {
  // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨Google SheetsåŒæ­¥
  if (!GOOGLE_SHEETS_CONFIG.enabled) {
    console.log('Google SheetsåŒæ­¥æœªå•Ÿç”¨');
    return [];
  }
  
  // æª¢æŸ¥æ˜¯å¦é…ç½®äº†Web App URL
  if (GOOGLE_SHEETS_CONFIG.webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
    console.warn('è«‹å…ˆé…ç½®Google Apps Script Web App URL');
    return [];
  }
  
  // é˜²æ­¢é‡è¤‡åŒæ­¥
  if (isSyncingWithSheets) {
    console.log('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè·³éæœ¬æ¬¡è«‹æ±‚');
    return sheetsBookings;
  }
  
  isSyncingWithSheets = true;
  
  try {
    console.log('å¾Google Sheetsè®€å–é ç´„æ•¸æ“š...');
    
    // æ§‹å»ºè«‹æ±‚URL
    const url = new URL(GOOGLE_SHEETS_CONFIG.webAppUrl);
    url.searchParams.append('action', 'getBookings');
    url.searchParams.append('_t', Date.now()); // é˜²æ­¢ç·©å­˜
    
    const response = await fetch(url.toString(), {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('Google Sheetså›æ‡‰:', result);
    
    if (result.success && result.bookings) {
      sheetsBookings = result.bookings;
      lastSheetsSyncTime = formatTimestamp();
      console.log(`æˆåŠŸç²å– ${sheetsBookings.length} æ¢é ç´„è¨˜éŒ„`);
      return sheetsBookings;
    } else {
      console.warn('Google Sheetså›æ‡‰æ ¼å¼ç•°å¸¸:', result);
      return [];
    }
    
  } catch (error) {
    console.error('å¾Google Sheetsè®€å–å¤±æ•—:', error);
    return [];
  } finally {
    isSyncingWithSheets = false;
  }
}

// å ´åœ°åç¨±æ¨™æº–åŒ–å°ç…§è¡¨ï¼ˆè™•ç†ä¸åŒæ ¼å¼çš„å ´åœ°åç¨±ï¼‰
const locationNameMapping = {
  // Google Sheets å¯èƒ½çš„æ ¼å¼ â†’ ç³»çµ±æ¨™æº–æ ¼å¼
  "å››ç¶­è·¯59è™Ÿ": "å››ç¶­è·¯59è™Ÿ",
  "æ¥Šæ¢…å€å››ç¶­è·¯59è™Ÿ": "å››ç¶­è·¯59è™Ÿ",
  "å››ç¶­è·¯60è™Ÿ": "å››ç¶­è·¯60è™Ÿ",
  "æ¥Šæ¢…å€å››ç¶­è·¯60è™Ÿ": "å››ç¶­è·¯60è™Ÿ",
  "æ¼¢å ¡å¤§äº¨": "æ¼¢å ¡å¤§äº¨",
  "æ¼¢å ¡å¤§äº¨ - å››ç¶­è·¯70è™Ÿ": "æ¼¢å ¡å¤§äº¨",
  "å››ç¶­è·¯70è™Ÿ": "æ¼¢å ¡å¤§äº¨",
  "æ¥Šæ¢…å€å››ç¶­è·¯70è™Ÿ": "æ¼¢å ¡å¤§äº¨",
  "è‡ªç”±é¢¨": "è‡ªç”±é¢¨",
  "è‡ªç”±é¢¨ - å››ç¶­è·¯190è™Ÿ": "è‡ªç”±é¢¨",
  "å››ç¶­è·¯190è™Ÿ": "è‡ªç”±é¢¨",
  "æ¥Šæ¢…å€å››ç¶­è·¯190è™Ÿ": "è‡ªç”±é¢¨",
  "è”¬è’”": "è”¬è’”",
  "è”¬è’” - å››ç¶­è·¯216è™Ÿ": "è”¬è’”",
  "å››ç¶­è·¯216è™Ÿ": "è”¬è’”",
  "æ¥Šæ¢…å€å››ç¶­è·¯216è™Ÿ": "è”¬è’”",
  "é‡‘æ­£å¥½åƒ": "é‡‘æ­£å¥½åƒ",
  "é‡‘æ­£å¥½åƒ - å››ç¶­è·¯218è™Ÿ": "é‡‘æ­£å¥½åƒ",
  "å››ç¶­è·¯218è™Ÿ": "é‡‘æ­£å¥½åƒ",
  "æ¥Šæ¢…å€å››ç¶­è·¯218è™Ÿ": "é‡‘æ­£å¥½åƒ"
};

// æ¨™æº–åŒ–å ´åœ°åç¨±
function normalizeLocationName(locationName) {
  if (!locationName) return locationName;
  
  // ç§»é™¤å¤šé¤˜ç©ºæ ¼å’Œå…¨å½¢ç©ºæ ¼
  let trimmed = locationName.trim().replace(/\s+/g, '');
  
  // ç§»é™¤"æ¥Šæ¢…å€"å‰ç¶´ï¼ˆå¦‚æœæœ‰ï¼‰
  trimmed = trimmed.replace(/^æ¥Šæ¢…å€/, '');
  
  // æŸ¥æ‰¾å°ç…§è¡¨ï¼ˆå…ˆç²¾ç¢ºåŒ¹é…ï¼‰
  if (locationNameMapping[locationName.trim()]) {
    return locationNameMapping[locationName.trim()];
  }
  
  // æŸ¥æ‰¾å°ç…§è¡¨ï¼ˆç„¡ç©ºæ ¼ç‰ˆæœ¬ï¼‰
  if (locationNameMapping[trimmed]) {
    return locationNameMapping[trimmed];
  }
  
  // å¦‚æœæ²’æœ‰åœ¨å°ç…§è¡¨ä¸­ï¼Œå˜—è©¦æ™ºèƒ½åŒ¹é…ï¼ˆæ ¹æ“šé–€ç‰Œè™Ÿç¢¼ï¼‰
  if (trimmed.includes('70è™Ÿ') || trimmed.includes('æ¼¢å ¡')) {
    return 'æ¼¢å ¡å¤§äº¨';
  }
  if (trimmed.includes('190è™Ÿ') || trimmed.includes('è‡ªç”±é¢¨')) {
    return 'è‡ªç”±é¢¨';
  }
  if (trimmed.includes('216è™Ÿ') || trimmed.includes('è”¬è’”')) {
    return 'è”¬è’”';
  }
  if (trimmed.includes('218è™Ÿ') || trimmed.includes('é‡‘æ­£å¥½åƒ')) {
    return 'é‡‘æ­£å¥½åƒ';
  }
  if (trimmed.includes('59è™Ÿ')) {
    return 'å››ç¶­è·¯59è™Ÿ';
  }
  if (trimmed.includes('60è™Ÿ')) {
    return 'å››ç¶­è·¯60è™Ÿ';
  }
  
  // å¦‚æœéƒ½ç„¡æ³•åŒ¹é…ï¼Œè¿”å›åŸå§‹åç¨±
  console.warn(`âš ï¸ ç„¡æ³•æ¨™æº–åŒ–å ´åœ°åç¨±: "${locationName}"`);
  return locationName.trim();
}

// å°‡Google Sheetsæ•¸æ“šåˆä½µåˆ°æ—¥æ›†ï¼ˆv2.7ï¼šå®Œå…¨æ›¿æ›æ¨¡å¼ + å ´åœ°åç¨±æ¨™æº–åŒ–ï¼‰
function mergeSheetsDataToCalendar() {
  console.log('========================================');
  console.log('ğŸ“¥ å¾ Google Sheets åŒæ­¥æ•¸æ“šï¼ˆv2.7 - å ´åœ°åç¨±æ¨™æº–åŒ–ï¼‰');
  console.log('========================================');
  
  // v2.3.0ï¼šå®Œå…¨æ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼Œåªä¿ç•™ Google Sheets çš„æ•¸æ“š
  console.log('ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•¸æ“š...');
  allEvents.length = 0;
  Object.keys(bookedSlots).forEach(location => {
    bookedSlots[location] = {};
  });
  
  if (!sheetsBookings || sheetsBookings.length === 0) {
    console.log('âŒ æ²’æœ‰Google Sheetsæ•¸æ“š');
    console.log('âœ… æ—¥æ›†å°‡é¡¯ç¤ºç‚ºç©º');
    renderCalendar();
    return;
  }
  
  console.log(`ğŸ“Š æº–å‚™è¼‰å…¥ ${sheetsBookings.length} æ¢Google Sheetsè¨˜éŒ„`);
  
  let addedCount = 0;
  let skippedCount = 0;
  
  // v2.7.0ï¼šç›´æ¥æ·»åŠ æ‰€æœ‰Google Sheetsæ•¸æ“šï¼Œä¸¦æ¨™æº–åŒ–å ´åœ°åç¨±
  sheetsBookings.forEach((booking, index) => {
    // è§£ææ—¥æœŸæ ¼å¼ï¼ˆä¾‹å¦‚ï¼š10æœˆ16æ—¥(æ˜ŸæœŸå››)ï¼‰
    const dateMatch = booking.date.match(/(\d+)æœˆ(\d+)æ—¥/);
    if (!dateMatch) {
      console.warn('âŒ ç„¡æ³•è§£ææ—¥æœŸæ ¼å¼:', booking.date, '- è·³éæ­¤ç­†è³‡æ–™');
      skippedCount++;
      return;
    }
    
    const month = parseInt(dateMatch[1]);
    const day = parseInt(dateMatch[2]);
    const year = new Date().getFullYear(); // å‡è¨­ç‚ºç•¶å¹´
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // æ¨™æº–åŒ–å ´åœ°åç¨±
    const originalLocation = booking.location;
    const normalizedLocation = normalizeLocationName(booking.location);
    
    if (originalLocation !== normalizedLocation) {
      console.log(`ğŸ”„ å ´åœ°åç¨±æ¨™æº–åŒ–: "${originalLocation}" â†’ "${normalizedLocation}"`);
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆå ´åœ°
    if (!locationConfigs[normalizedLocation]) {
      console.warn(`âš ï¸ æœªçŸ¥å ´åœ°: "${booking.location}" (æ¨™æº–åŒ–: "${normalizedLocation}") - è·³éæ­¤ç­†è³‡æ–™`);
      skippedCount++;
      return;
    }
    
    // v2.7.0ï¼šç›´æ¥æ·»åŠ äº‹ä»¶ï¼Œä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„å ´åœ°åç¨±
    const newEvent = {
      title: booking.vendor,
      start: dateStr,
      location: normalizedLocation, // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„åç¨±
      color: '#17a2b8', // ç”¨ä¸åŒé¡è‰²æ¨™ç¤ºä¾†è‡ªSheetsçš„æ•¸æ“š
      timestamp: booking.timestamp,
      foodType: booking.foodType,
      fee: booking.fee,
      payment: booking.payment,
      bookedStatus: booking.bookedStatus, // å·±æ’ç‹€æ…‹
      note: booking.note,
      source: 'google_sheets', // æ¨™è¨˜ä¾†æº
      rowNumber: booking.rowNumber, // ä¿å­˜è¡Œè™Ÿï¼Œç”¨æ–¼å¾ŒçºŒæ›´æ–°
      originalLocation: originalLocation // ä¿å­˜åŸå§‹å ´åœ°åç¨±
    };
    
    allEvents.push(newEvent);
    
    // æ›´æ–°bookedSlotsï¼ˆä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„åç¨±ï¼‰
    if (!bookedSlots[normalizedLocation]) {
      bookedSlots[normalizedLocation] = {};
    }
    if (!bookedSlots[normalizedLocation][dateStr]) {
      bookedSlots[normalizedLocation][dateStr] = [];
    }
    bookedSlots[normalizedLocation][dateStr].push('14:00-20:00');
    
    addedCount++;
  });
  
  // v2.7.0ï¼šé¡¯ç¤ºè¼‰å…¥çµ±è¨ˆï¼ˆåŒ…å«è·³éçš„è³‡æ–™ï¼‰
  
  console.log('========================================');
  console.log(`âœ… Google Sheets æ•¸æ“šè¼‰å…¥å®Œæˆ`);
  console.log(`ğŸ“Š æˆåŠŸè¼‰å…¥: ${addedCount} å€‹é ç´„`);
  if (skippedCount > 0) {
    console.warn(`âš ï¸ è·³é: ${skippedCount} ç­†è³‡æ–™ï¼ˆå ´åœ°åç¨±ä¸åŒ¹é…æˆ–æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼‰`);
    console.warn(`ğŸ’¡ è«‹åœ¨æ§åˆ¶å°åŸ·è¡Œ checkSheetsLocationNames() æŸ¥çœ‹è©³æƒ…`);
  }
  console.log('========================================');
  
  if (addedCount > 0) {
    // é¡¯ç¤ºæ¯å€‹å ´åœ°çš„é ç´„æ•¸é‡
    const locationCounts = {};
    allEvents.forEach(event => {
      locationCounts[event.location] = (locationCounts[event.location] || 0) + 1;
    });
    
    console.log('ğŸ“ å„å ´åœ°é ç´„æ•¸é‡:');
    Object.keys(locationCounts).forEach(location => {
      console.log(`   ${location}: ${locationCounts[location]} å€‹é ç´„`);
    });
    
    // æª¢æŸ¥æ˜¯å¦æœ‰å ´åœ°æ²’æœ‰é ç´„
    const allLocations = Object.keys(locationConfigs);
    const missingLocations = allLocations.filter(loc => !locationCounts[loc]);
    if (missingLocations.length > 0) {
      console.log('\nğŸ“­ ä»¥ä¸‹å ´åœ°ç›®å‰ç„¡é ç´„:');
      missingLocations.forEach(loc => {
        console.log(`   â€¢ ${loc}`);
      });
    }
    
    console.log('========================================');
    
    renderCalendar(); // é‡æ–°æ¸²æŸ“æ—¥æ›†
    // v2.3.0ï¼šä¸å†ä¿å­˜åˆ°localStorageï¼Œé¿å…èˆŠæ•¸æ“šæ±¡æŸ“
  } else {
    console.log('âš ï¸ æ²’æœ‰è¼‰å…¥ä»»ä½•é ç´„æ•¸æ“š');
    renderCalendar(); // é¡¯ç¤ºç©ºæ—¥æ›†
  }
}

// å®šæœŸå¾Google SheetsåŒæ­¥æ•¸æ“š
let sheetsSyncInterval = null;
let paymentCountdownInterval = null;

function startSheetsSyncInterval() {
  if (!GOOGLE_SHEETS_CONFIG.enabled || !GOOGLE_SHEETS_CONFIG.autoSync) {
    console.log('Google Sheetsè‡ªå‹•åŒæ­¥æœªå•Ÿç”¨');
    return;
  }
  
  // æ¸…é™¤èˆŠçš„åŒæ­¥è¨ˆæ™‚å™¨
  if (sheetsSyncInterval) {
    clearInterval(sheetsSyncInterval);
  }
  
  // è¨­ç½®æ–°çš„åŒæ­¥è¨ˆæ™‚å™¨
  sheetsSyncInterval = setInterval(async () => {
    console.log('å®šæœŸåŒæ­¥Google Sheetsæ•¸æ“š...');
    try {
      // åŒæ™‚åŒæ­¥å®Œæ•´é ç´„æ•¸æ“šå’Œå·²é ç´„æ—¥æœŸ
      await Promise.all([
        fetchBookingsFromGoogleSheets(),
        fetchBookedDatesFromSheets()
      ]);
      mergeSheetsDataToCalendar();
      console.log('âœ… å®šæœŸåŒæ­¥å®Œæˆ');
    } catch (error) {
      console.error('å®šæœŸåŒæ­¥å¤±æ•—:', error);
    }
  }, GOOGLE_SHEETS_CONFIG.syncInterval);
  
  console.log(`å·²å•Ÿå‹•Google Sheetså®šæœŸåŒæ­¥ï¼Œé–“éš”: ${GOOGLE_SHEETS_CONFIG.syncInterval/1000}ç§’`);
  
  // å•Ÿå‹•ä»˜æ¬¾å€’è¨ˆæ™‚æ›´æ–°å™¨ï¼ˆæ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡ï¼‰
  if (paymentCountdownInterval) {
    clearInterval(paymentCountdownInterval);
  }
  
  paymentCountdownInterval = setInterval(() => {
    // åªæ›´æ–°æ—¥æ›†é¡¯ç¤ºï¼Œä¸é‡æ–°fetchæ•¸æ“š
    renderCalendar();
  }, 60000); // æ¯60ç§’æ›´æ–°ä¸€æ¬¡å€’è¨ˆæ™‚
  
  console.log('å·²å•Ÿå‹•ä»˜æ¬¾å€’è¨ˆæ™‚æ›´æ–°å™¨');
}

// æ‰‹å‹•è§¸ç™¼Google SheetsåŒæ­¥
async function syncGoogleSheets() {
  console.log('æ‰‹å‹•åŒæ­¥Google Sheets...');
  showToast('info', 'æ›´æ–°ä¸­', 'ğŸ”„ æ­£åœ¨æ›´æ–°æœ€æ–°æ’ç­è³‡è¨Š...');
  
  try {
    // åŒæ™‚åŒæ­¥å®Œæ•´é ç´„æ•¸æ“šå’Œå·²é ç´„æ—¥æœŸ
    await Promise.all([
      fetchBookingsFromGoogleSheets(),
      fetchBookedDatesFromSheets()
    ]);
    mergeSheetsDataToCalendar();
    
    // è¨ˆç®—å·²é ç´„ç¸½æ•¸
    let totalBooked = 0;
    for (const location in sheetsBookedDates) {
      totalBooked += sheetsBookedDates[location].length;
    }
    
    showToast('success', 'æ›´æ–°æˆåŠŸ', `âœ… å·²æ›´æ–° ${sheetsBookings.length} å€‹æ’ç­ï¼Œ${totalBooked} å€‹å·²é ç´„æª”æœŸ`);
    
    // é‡æ–°ç”Ÿæˆç•¶å‰å ´åœ°çš„å¯ç”¨æ—¥æœŸ
    const currentLoc = document.getElementById('location').value;
    if (currentLoc) {
      document.getElementById('location').dispatchEvent(new Event('change'));
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰é€¾æœŸæœªä»˜æ¬¾çš„é ç´„
    checkOverduePayments();
  } catch (error) {
    console.error('åŒæ­¥å¤±æ•—:', error);
    showToast('error', 'æ›´æ–°å¤±æ•—', 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

// æª¢æŸ¥é€¾æœŸæœªä»˜æ¬¾çš„é ç´„
function checkOverduePayments() {
  if (!allEvents || allEvents.length === 0) return;
  
  const now = new Date();
  const overdueEvents = [];
  const urgentEvents = [];
  
  allEvents.forEach(event => {
    // åªæª¢æŸ¥å°šæœªä»˜æ¬¾çš„é ç´„
    if (event.payment !== 'å·²ä»˜æ¬¾' && event.timestamp) {
      const bookingTime = new Date(event.timestamp);
      const deadline = new Date(bookingTime.getTime() + 24 * 60 * 60 * 1000);
      const timeLeft = deadline - now;
      
      if (timeLeft < 0) {
        // å·²é€¾æœŸ
        overdueEvents.push(event);
      } else if (timeLeft < 6 * 60 * 60 * 1000) {
        // å°‘æ–¼6å°æ™‚
        urgentEvents.push(event);
      }
    }
  });
  
  // é¡¯ç¤ºæé†’
  if (overdueEvents.length > 0) {
    console.warn(`âš ï¸ ç™¼ç¾ ${overdueEvents.length} å€‹é€¾æœŸæœªä»˜æ¬¾çš„é ç´„ï¼š`);
    overdueEvents.forEach(e => {
      console.warn(`  - ${e.title} (${e.location})`);
    });
  }
  
  if (urgentEvents.length > 0) {
    console.warn(`â° ç™¼ç¾ ${urgentEvents.length} å€‹å³å°‡é€¾æœŸçš„é ç´„ï¼š`);
    urgentEvents.forEach(e => {
      const bookingTime = new Date(e.timestamp);
      const deadline = new Date(bookingTime.getTime() + 24 * 60 * 60 * 1000);
      const timeLeft = deadline - new Date();
      const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
      console.warn(`  - ${e.title} (${e.location}) - å‰©é¤˜ ${hoursLeft} å°æ™‚`);
    });
  }
}

// å¾Google Sheetsç²å–å·²é ç´„æ—¥æœŸ
async function fetchBookedDatesFromSheets() {
  // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨Google SheetsåŒæ­¥
  if (!GOOGLE_SHEETS_CONFIG.enabled) {
    console.log('Google SheetsåŒæ­¥æœªå•Ÿç”¨');
    return {};
  }
  
  // æª¢æŸ¥æ˜¯å¦é…ç½®äº†Web App URL
  if (GOOGLE_SHEETS_CONFIG.webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
    console.warn('è«‹å…ˆé…ç½®Google Apps Script Web App URL');
    return {};
  }
  
  try {
    console.log('å¾Google Sheetsè®€å–å·²é ç´„æ—¥æœŸ...');
    
    // æ§‹å»ºè«‹æ±‚URL
    const url = new URL(GOOGLE_SHEETS_CONFIG.webAppUrl);
    url.searchParams.append('action', 'getBookedDates');
    url.searchParams.append('_t', Date.now()); // é˜²æ­¢ç·©å­˜
    
    const response = await fetch(url.toString(), {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('Google Sheetså·²é ç´„æ—¥æœŸå›æ‡‰:', result);
    
    if (result.success && result.bookedDates) {
      sheetsBookedDates = result.bookedDates;
      lastBookedDatesSyncTime = formatTimestamp();
      
      // è¨ˆç®—ç¸½é ç´„æ•¸
      let totalBooked = 0;
      for (const location in sheetsBookedDates) {
        totalBooked += sheetsBookedDates[location].length;
      }
      
      console.log(`âœ… æˆåŠŸç²å–å·²é ç´„æ—¥æœŸï¼Œå…± ${totalBooked} å€‹é ç´„`);
      return sheetsBookedDates;
    } else {
      console.warn('Google Sheetså›æ‡‰æ ¼å¼ç•°å¸¸:', result);
      return {};
    }
    
  } catch (error) {
    console.error('å¾Google Sheetsè®€å–å·²é ç´„æ—¥æœŸå¤±æ•—:', error);
    return {};
  }
}

// æš´éœ²åˆ°å…¨å±€ï¼Œä¾›æ§åˆ¶å°èª¿è©¦ä½¿ç”¨
window.syncGoogleSheets = syncGoogleSheets;
window.fetchBookingsFromGoogleSheets = fetchBookingsFromGoogleSheets;
window.fetchBookedDatesFromSheets = fetchBookedDatesFromSheets;
window.sheetsBookings = () => sheetsBookings;
window.sheetsBookedDates = () => sheetsBookedDates;

// =============== End of Google Sheets åŒæ­¥åŠŸèƒ½ ===============

// ç²å–åœ‹å®šå‡æ—¥åç¨±
function getHolidayName(dateStr) {
  const holidayMap = {
    '2025-01-01': 'å…ƒæ—¦',
    '2025-01-28': 'æ˜¥ç¯€',
    '2025-01-29': 'æ˜¥ç¯€',
    '2025-01-30': 'æ˜¥ç¯€',
    '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
    '2025-04-04': 'å…’ç«¥ç¯€',
    '2025-04-05': 'æ¸…æ˜ç¯€',
    '2025-05-01': 'å‹å‹•ç¯€',
    '2025-06-14': 'ç«¯åˆç¯€',
    '2025-09-27': 'ä¸­ç§‹ç¯€',
    '2025-10-10': 'åœ‹æ…¶æ—¥',
    '2025-12-25': 'è–èª•ç¯€'
  };
  return holidayMap[dateStr] || 'åœ‹å®šå‡æ—¥';
}

// æ™‚é–“æ§åˆ¶æª¢æŸ¥å‡½æ•¸ï¼ˆç¨ç«‹æ¢ä»¶ï¼‰
function checkTimeControl(targetYear, targetMonth, currentYear, currentMonth, currentDay) {
  console.log(`æª¢æŸ¥æ™‚é–“æ§åˆ¶: ç›®æ¨™${targetYear}-${targetMonth}, ç•¶å‰${currentYear}-${currentMonth}-${currentDay}`);
  
  // ç¸½æ˜¯å…è¨±ç•¶å‰æœˆä»½
  if (targetYear === currentYear && targetMonth === currentMonth) {
    console.log(`å…è¨±ç•¶å‰æœˆä»½: ${targetYear}-${targetMonth}`);
    return true;
  }
  
  // æ ¹æ“šæ™‚é–“æ§åˆ¶è¦å‰‡æª¢æŸ¥å…¶ä»–æœˆä»½
  if (currentDay >= 1) { // æ¯æœˆ1æ—¥é–‹å§‹
    // é–‹æ”¾ç•¶å‰æœˆä»½ + 3å€‹æœˆå¾Œçš„æœˆä»½
    // ä¾‹å¦‚ï¼š9æœˆ â†’ é–‹æ”¾12æœˆï¼Œ10æœˆ â†’ é–‹æ”¾éš”å¹´1æœˆï¼Œ11æœˆ â†’ é–‹æ”¾éš”å¹´2æœˆ
    const allowedMonth = currentMonth + 3;
    const allowedYear = currentYear;
    
    let finalAllowedMonth, finalAllowedYear;
    if (allowedMonth > 12) {
      finalAllowedYear = allowedYear + Math.floor((allowedMonth - 1) / 12);
      finalAllowedMonth = ((allowedMonth - 1) % 12) + 1;
    } else {
      finalAllowedYear = allowedYear;
      finalAllowedMonth = allowedMonth;
    }
    
    console.log(`è¨ˆç®—å…è¨±æœˆä»½: ${finalAllowedYear}-${finalAllowedMonth}`);
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºå…è¨±çš„æœˆä»½
    if (targetYear === finalAllowedYear && targetMonth === finalAllowedMonth) {
      console.log(`å…è¨±æœˆä»½: ${targetYear}-${targetMonth}`);
      return true;
    }
    
    // å¦‚æœå·²ç¶“éäº†æœˆä¸­ï¼Œä¹Ÿé–‹æ”¾ä¸‹ä¸€å€‹æœˆ
    if (currentDay >= 15) {
      const nextAllowedMonth = allowedMonth + 1;
      let finalNextAllowedMonth, finalNextAllowedYear;
      if (nextAllowedMonth > 12) {
        finalNextAllowedYear = allowedYear + Math.floor((nextAllowedMonth - 1) / 12);
        finalNextAllowedMonth = ((nextAllowedMonth - 1) % 12) + 1;
      } else {
        finalNextAllowedYear = allowedYear;
        finalNextAllowedMonth = nextAllowedMonth;
      }
      
      console.log(`è¨ˆç®—æœˆä¸­å…è¨±æœˆä»½: ${finalNextAllowedYear}-${finalNextAllowedMonth}`);
      
      if (targetYear === finalNextAllowedYear && targetMonth === finalNextAllowedMonth) {
        console.log(`å…è¨±æœˆä¸­æœˆä»½: ${targetYear}-${targetMonth}`);
        return true;
      }
    }
  }
  
  console.log(`æ‹’çµ•æœˆä»½: ${targetYear}-${targetMonth}`);
  return false;
}

// å ´åœ°é¸æ“‡äº‹ä»¶
document.getElementById('location').addEventListener('change', async () => {
  const loc = document.getElementById('location').value;
  const dateInput = document.getElementById('date');
  const dateSelect = document.getElementById('availableDates');
  const dateInfo = document.getElementById('dateInfo');
  
  // åŒæ­¥æ›´æ–°è¡Œäº‹æ›†ç¯©é¸å’Œä¸Šæ–¹å ´åœ°åˆ†é 
  if (loc) {
    currentFilter = loc;
    
    // æ›´æ–°è¡Œäº‹æ›†ç¯©é¸æŒ‰éˆ•çš„activeç‹€æ…‹
    document.querySelectorAll('.location-filter .filter-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.location === loc) {
        btn.classList.add('active');
      }
    });
    
    // æ›´æ–°ä¸Šæ–¹å ´åœ°åˆ†é çš„activeç‹€æ…‹
    document.querySelectorAll('.location-tab').forEach(tab => {
      tab.classList.remove('active');
      if (tab.dataset.location === loc) {
        tab.classList.add('active');
      }
    });
    
    // æ›´æ–°å ´åœ°è³‡è¨Šé¡¯ç¤º
    updateLocationInfo(loc);
    
    // ç«‹å³é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†ï¼ˆä¸ç­‰å¾…ï¼‰
    renderCalendar();
  }
  
  // é‡ç½®
  dateInput.value = '';
  dateInput.style.display = 'none';
  dateSelect.style.display = 'block';
  dateInfo.style.display = 'block';
  
  if (!loc) {
    dateSelect.style.display = 'none';
    dateInfo.style.display = 'none';
    return;
  }
  
  const locationConfig = locationConfigs[loc];
  if (!locationConfig) {
    return;
  }
  
  // å…ˆç”¨æœ¬åœ°æ•¸æ“šå¿«é€Ÿç”Ÿæˆé¸é …ï¼ˆç«‹å³éŸ¿æ‡‰ï¼‰
  const quickAvailableDates = generateAvailableDates(loc);
  
  if (quickAvailableDates.length > 0) {
    // ç«‹å³æ›´æ–°é¸é …ï¼ˆä½¿ç”¨æœ¬åœ°æ•¸æ“šï¼‰
    dateSelect.innerHTML = '<option value="">é¸æ“‡å¯ç”¨æ—¥æœŸ</option>';
    quickAvailableDates.forEach(date => {
      const opt = document.createElement('option');
      opt.value = date.value;
      opt.textContent = date.text;
      dateSelect.appendChild(opt);
    });
    
    // æ›´æ–°æç¤ºè¨Šæ¯
    if (locationConfig.days.length < 7) {
      const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
      const allowedDays = locationConfig.days.map(day => dayNames[day]).join('ã€');
      dateInfo.innerHTML = `<small><i class="fas fa-info-circle"></i> è©²å ´åœ°åƒ…é™${allowedDays}ç‡Ÿæ¥­</small>`;
    } else {
      dateInfo.innerHTML = '<small><i class="fas fa-info-circle"></i> è©²å ´åœ°æ•´å€‹æœˆéƒ½å¯ä»¥æ’ç­</small>';
    }
  } else {
    dateInfo.innerHTML = '<small><i class="fas fa-exclamation-triangle"></i> è©²å ´åœ°è¿‘æœŸç„¡å¯ç”¨æ—¥æœŸ</small>';
  }
  
  // åœ¨èƒŒæ™¯å¾Google Sheetsç²å–æœ€æ–°æ•¸æ“šä¸¦æ›´æ–°ï¼ˆç•°æ­¥ï¼Œä¸é˜»å¡UIï¼‰
  if (GOOGLE_SHEETS_CONFIG.enabled && GOOGLE_SHEETS_CONFIG.webAppUrl !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
    // å»¶é²åŸ·è¡Œï¼Œä¸é˜»å¡UI
    setTimeout(async () => {
      try {
        await fetchBookedDatesFromSheets();
        console.log(`âœ… å·²æ›´æ–°å ´åœ° ${loc} çš„å·²é ç´„æ—¥æœŸ`);
        
        // é‡æ–°ç”Ÿæˆé¸é …ï¼ˆä½¿ç”¨æœ€æ–°æ•¸æ“šï¼‰
        const updatedAvailableDates = generateAvailableDates(loc);
        
        // åªæœ‰åœ¨é¸é …æœ‰è®ŠåŒ–æ™‚æ‰æ›´æ–°
        if (JSON.stringify(updatedAvailableDates) !== JSON.stringify(quickAvailableDates)) {
          dateSelect.innerHTML = '<option value="">é¸æ“‡å¯ç”¨æ—¥æœŸ</option>';
          updatedAvailableDates.forEach(date => {
            const opt = document.createElement('option');
            opt.value = date.value;
            opt.textContent = date.text;
            dateSelect.appendChild(opt);
          });
          console.log('ğŸ“… æ—¥æœŸé¸é …å·²æ›´æ–°ï¼ˆä¾†è‡ªGoogle Sheetsæœ€æ–°æ•¸æ“šï¼‰');
        }
      } catch (error) {
        console.error('èƒŒæ™¯ç²å–å·²é ç´„æ—¥æœŸå¤±æ•—:', error);
        // å¤±æ•—ä¸å½±éŸ¿ï¼Œå·²æœ‰æœ¬åœ°æ•¸æ“šé¡¯ç¤º
      }
    }, 100); // å»¶é²100msåŸ·è¡Œï¼Œè®“UIå…ˆéŸ¿æ‡‰
  }
});

// æ—¥æœŸé¸æ“‡äº‹ä»¶
function handleDateChange() {
  const loc = document.getElementById('location').value;
  const dateSelect = document.getElementById('availableDates');
  const selectedDate = dateSelect.value;
  
  if (!loc || !selectedDate) {
    return;
  }
  
  // æª¢æŸ¥æ—¥æ›†ä¸Šæ˜¯å¦å·²æœ‰é¤è»Šåç¨±
  const hasEvent = allEvents.some(event => {
    let eventDate;
    if (event.start instanceof Date) {
      eventDate = event.start.toISOString().split('T')[0];
    } else {
      eventDate = event.start.split('T')[0];
    }
    return eventDate === selectedDate && event.location === loc;
  });
  
  if (hasEvent) {
    alert('è©²æ—¥æœŸå·²æœ‰é¤è»Šæ’ç­ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
    return;
  }
}

// ç¶å®šäº‹ä»¶
document.getElementById('date').addEventListener('change', handleDateChange);
document.getElementById('availableDates').addEventListener('change', handleDateChange);

// æ•¸æ“šæŒä¹…åŒ–åŠŸèƒ½ï¼ˆv2.3.0ï¼šå·²åœç”¨ï¼Œå®Œå…¨ä¾è³´Google Sheetsï¼‰
function saveToLocalStorage() {
  // v2.3.0ï¼šä¸å†ä¿å­˜åˆ°localStorageï¼Œé¿å…èˆŠæ•¸æ“šæ±¡æŸ“
  // æ‰€æœ‰æ•¸æ“šå®Œå…¨ä¾†è‡ªGoogle Sheets
  console.log('â„¹ï¸ v2.3.0: ä¸ä½¿ç”¨æœ¬åœ°å­˜å„²ï¼Œæ•¸æ“šå®Œå…¨ä¾†è‡ª Google Sheets');
  return;
  
  // ä»¥ä¸‹ä»£ç¢¼å·²åœç”¨
  // try {
  //   const data = {
  //     allEvents: allEvents,
  //     bookedSlots: bookedSlots,
  //     lastUpdate: formatTimestamp()
  //   };
  //   localStorage.setItem('foodtruck_bookings', JSON.stringify(data));
  //   console.log('æ•¸æ“šå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å„²');
  // } catch (error) {
  //   console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å„²å¤±æ•—:', error);
  // }
}

// æ¸…é™¤æœ¬åœ°ç·©å­˜
function clearLocalCache() {
  localStorage.clear();
  allEvents.length = 0;
  Object.keys(bookedSlots).forEach(key => delete bookedSlots[key]);
  console.log('âœ… æœ¬åœ°ç·©å­˜å·²æ¸…é™¤');
  showToast('success', 'ç·©å­˜å·²æ¸…é™¤', 'æœ¬åœ°æ•¸æ“šå·²æ¸…ç©ºï¼Œè«‹é‡æ–°æ•´ç†é é¢');
}

// è¨ºæ–·æ‰€æœ‰é ç´„æ•¸æ“š
function diagnoseAllBookings() {
  console.log('========== é ç´„æ•¸æ“šè¨ºæ–· ==========');
  
  // 1. æª¢æŸ¥allEvents
  console.log('\nã€allEventsã€‘å…±', allEvents.length, 'å€‹äº‹ä»¶:');
  allEvents.forEach((event, index) => {
    let eventDate;
    if (event.start instanceof Date) {
      eventDate = event.start.toISOString().split('T')[0];
    } else {
      eventDate = event.start.split('T')[0];
    }
    console.log(`  ${index + 1}. ${event.title} - ${event.location} - ${eventDate} (ä¾†æº: ${event.source || 'æœªçŸ¥'})`);
  });
  
  // 2. æª¢æŸ¥bookedSlots
  console.log('\nã€bookedSlotsã€‘:');
  Object.keys(bookedSlots).forEach(location => {
    console.log(`  å ´åœ°: ${location}`);
    Object.keys(bookedSlots[location]).forEach(date => {
      console.log(`    - ${date}: ${bookedSlots[location][date].join(', ')}`);
    });
  });
  
  // 3. æª¢æŸ¥sheetsBookedDates
  console.log('\nã€sheetsBookedDatesã€‘:');
  Object.keys(sheetsBookedDates).forEach(location => {
    console.log(`  å ´åœ°: ${location}, æ•¸é‡: ${sheetsBookedDates[location].length}`);
    sheetsBookedDates[location].forEach(booking => {
      console.log(`    - ${booking.standardDate}: ${booking.vendor || 'ç„¡åº—å'}`);
    });
  });
  
  // 4. æª¢æŸ¥sheetsBookings
  console.log('\nã€sheetsBookingsã€‘å…±', sheetsBookings.length, 'ç­†:');
  sheetsBookings.forEach((booking, index) => {
    console.log(`  ${index + 1}. ${booking.vendor} - ${booking.location} - ${booking.date}`);
  });
  
  // 5. æª¢æŸ¥localStorage
  console.log('\nã€localStorageã€‘:');
  const localData = localStorage.getItem('foodtruck_bookings');
  if (localData) {
    const parsed = JSON.parse(localData);
    console.log('  lastUpdate:', parsed.lastUpdate);
    console.log('  allEventsæ•¸é‡:', parsed.allEvents?.length || 0);
    console.log('  bookedSlotså ´åœ°æ•¸:', Object.keys(parsed.bookedSlots || {}).length);
  } else {
    console.log('  ç„¡æœ¬åœ°å­˜å„²æ•¸æ“š');
  }
  
  console.log('\n===================================');
  
  return {
    allEvents: allEvents.length,
    bookedSlots: Object.keys(bookedSlots).length,
    sheetsBookedDates: Object.keys(sheetsBookedDates).length,
    sheetsBookings: sheetsBookings.length
  };
}

// å¿«é€Ÿæ¸¬è©¦åŒæ­¥
window.quickTest = async function() {
  console.log('========== å¿«é€Ÿæ¸¬è©¦ ==========');
  
  // 1. æª¢æŸ¥é…ç½®
  console.log('Google Sheets URL:', GOOGLE_SHEETS_CONFIG.webAppUrl);
  console.log('åŒæ­¥å·²å•Ÿç”¨:', GOOGLE_SHEETS_CONFIG.enabled);
  
  // 2. æ‰‹å‹•åŒæ­¥
  console.log('\næ­£åœ¨åŒæ­¥ Google Sheets...');
  try {
    await fetchBookingsFromGoogleSheets();
    console.log('åŒæ­¥å¾Œ sheetsBookings æ•¸é‡:', sheetsBookings.length);
    
    await fetchBookedDatesFromSheets();
    let totalBooked = 0;
    Object.keys(sheetsBookedDates).forEach(loc => {
      totalBooked += sheetsBookedDates[loc].length;
    });
    console.log('åŒæ­¥å¾Œå·²é ç´„æ—¥æœŸæ•¸é‡:', totalBooked);
    
    // 3. åˆä½µåˆ°æ—¥æ›†
    mergeSheetsDataToCalendar();
    console.log('åˆä½µå¾Œ allEvents æ•¸é‡:', allEvents.length);
    
    // 4. é‡æ–°æ¸²æŸ“
    renderCalendar();
    
    console.log('\nâœ… æ¸¬è©¦å®Œæˆï¼å¦‚æœæ•¸é‡ç‚º0ï¼Œè¡¨ç¤º Google Sheets å¯èƒ½æ˜¯ç©ºçš„');
    console.log('è«‹åŸ·è¡Œ diagnoseAllBookings() æŸ¥çœ‹è©³ç´°è³‡æ–™');
    
  } catch (error) {
    console.error('âŒ æ¸¬è©¦å¤±æ•—:', error);
  }
  
  console.log('===========================');
};

// æª¢æŸ¥ç•¶å‰é¡¯ç¤ºçš„æ•¸æ“šä¾†æº
function checkDataSource() {
  console.log('========================================');
  console.log('ğŸ“Š ç•¶å‰æ•¸æ“šä¾†æºæª¢æŸ¥');
  console.log('========================================');
  console.log(`ç¸½äº‹ä»¶æ•¸: ${allEvents.length}`);
  
  const sourceCounts = {};
  allEvents.forEach(event => {
    const source = event.source || 'æœªçŸ¥';
    sourceCounts[source] = (sourceCounts[source] || 0) + 1;
  });
  
  console.log('\nğŸ“ æ•¸æ“šä¾†æºçµ±è¨ˆ:');
  Object.keys(sourceCounts).forEach(source => {
    console.log(`   ${source}: ${sourceCounts[source]} å€‹äº‹ä»¶`);
  });
  
  console.log('\nğŸ“‹ è©³ç´°åˆ—è¡¨:');
  allEvents.forEach((event, index) => {
    let dateStr;
    if (event.start instanceof Date) {
      dateStr = event.start.toISOString().split('T')[0];
    } else {
      dateStr = event.start.split('T')[0];
    }
    const originalLoc = event.originalLocation ? ` (åŸ: ${event.originalLocation})` : '';
    console.log(`   ${index + 1}. ${event.title} | ${event.location}${originalLoc} | ${dateStr} | ä¾†æº: ${event.source || 'æœªçŸ¥'}`);
  });
  
  console.log('========================================');
  console.log('âœ… å¦‚æœæ‰€æœ‰ä¾†æºéƒ½æ˜¯ "google_sheets"ï¼Œè¡¨ç¤ºæ•¸æ“šæ­£ç¢º');
  console.log('âŒ å¦‚æœæœ‰å…¶ä»–ä¾†æºï¼Œè«‹åŸ·è¡Œ clearLocalCache() æ¸…é™¤èˆŠæ•¸æ“š');
  console.log('========================================');
}

// æª¢æŸ¥ Google Sheets ä¸­çš„å ´åœ°åç¨±æ ¼å¼
function checkSheetsLocationNames() {
  console.log('========================================');
  console.log('ğŸ” æª¢æŸ¥ Google Sheets å ´åœ°åç¨±æ ¼å¼');
  console.log('========================================');
  
  if (!sheetsBookings || sheetsBookings.length === 0) {
    console.warn('âŒ æ²’æœ‰ Google Sheets æ•¸æ“š');
    console.log('è«‹å…ˆåŸ·è¡Œ: await fetchBookingsFromGoogleSheets()');
    return;
  }
  
  console.log(`ğŸ“Š å…± ${sheetsBookings.length} ç­†è³‡æ–™\n`);
  
  // çµ±è¨ˆå ´åœ°åç¨±
  const locationStats = {};
  const unknownLocations = [];
  
  sheetsBookings.forEach((booking, index) => {
    const original = booking.location;
    const normalized = normalizeLocationName(booking.location);
    const isValid = locationConfigs[normalized] !== undefined;
    
    if (!locationStats[original]) {
      locationStats[original] = {
        count: 0,
        normalized: normalized,
        isValid: isValid
      };
    }
    locationStats[original].count++;
    
    if (!isValid) {
      unknownLocations.push({
        index: index + 1,
        vendor: booking.vendor,
        location: original,
        date: booking.date
      });
    }
  });
  
  console.log('ğŸ“ å ´åœ°åç¨±çµ±è¨ˆ:\n');
  Object.keys(locationStats).forEach(location => {
    const stat = locationStats[location];
    const status = stat.isValid ? 'âœ…' : 'âŒ';
    const normalized = location !== stat.normalized ? ` â†’ ${stat.normalized}` : '';
    console.log(`${status} "${location}"${normalized}: ${stat.count} ç­†`);
  });
  
  if (unknownLocations.length > 0) {
    console.log('\nâŒ ç„¡æ³•è­˜åˆ¥çš„å ´åœ°åç¨±:');
    unknownLocations.forEach(item => {
      console.log(`   ç¬¬ ${item.index} ç­†: ${item.vendor} | "${item.location}" | ${item.date}`);
    });
    console.log('\nğŸ’¡ å»ºè­°ä¿®æ­£ Google Sheets ä¸­çš„å ´åœ°åç¨±ç‚ºä»¥ä¸‹æ ¼å¼ä¹‹ä¸€:');
    console.log('   â€¢ å››ç¶­è·¯59è™Ÿ');
    console.log('   â€¢ å››ç¶­è·¯60è™Ÿ');
    console.log('   â€¢ æ¼¢å ¡å¤§äº¨ æˆ– å››ç¶­è·¯70è™Ÿ');
    console.log('   â€¢ è‡ªç”±é¢¨ æˆ– å››ç¶­è·¯190è™Ÿ');
    console.log('   â€¢ è”¬è’” æˆ– å››ç¶­è·¯216è™Ÿ');
    console.log('   â€¢ é‡‘æ­£å¥½åƒ æˆ– å››ç¶­è·¯218è™Ÿ');
  }
  
  console.log('========================================');
}

// æš´éœ²åˆ°å…¨å±€ä¾›æ§åˆ¶å°ä½¿ç”¨
window.clearLocalCache = clearLocalCache;
window.diagnoseAllBookings = diagnoseAllBookings;
window.checkDataSource = checkDataSource;
window.syncOnlySheetsData = syncOnlySheetsData;
window.checkSheetsLocationNames = checkSheetsLocationNames;
window.normalizeLocationName = normalizeLocationName;

function loadFromLocalStorage() {
  try {
    const data = localStorage.getItem('foodtruck_bookings');
    if (data) {
      const parsed = JSON.parse(data);
      
      // åªè¼‰å…¥ allEventsï¼Œä¸è¼‰å…¥ bookedSlotsï¼ˆé¿å…é«’æ•¸æ“šï¼‰
      // bookedSlots æœƒå¾ Google Sheets å’Œ allEvents é‡å»º
      if (parsed.allEvents) {
        allEvents.length = 0;
        allEvents.push(...parsed.allEvents);
      }
      
      // ä¸å†è¼‰å…¥ bookedSlotsï¼Œé¿å…èˆŠæ•¸æ“šè¡çª
      // if (parsed.bookedSlots) {
      //   Object.assign(bookedSlots, parsed.bookedSlots);
      // }
      
      console.log('å¾æœ¬åœ°å­˜å„²è¼‰å…¥æ•¸æ“šæˆåŠŸï¼ˆåƒ…è¼‰å…¥äº‹ä»¶ï¼Œä¸è¼‰å…¥æ™‚æ®µæ•¸æ“šï¼‰');
      return true;
    }
  } catch (error) {
    console.error('å¾æœ¬åœ°å­˜å„²è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
  }
  return false;
}

// æ™ºèƒ½åˆä½µæ•¸æ“šï¼ˆåŸºæ–¼æ™‚é–“æˆ³çš„å…ˆå¾Œé †åºï¼‰
function mergeDataByTimestamp(githubBookings) {
  const mergedEvents = [];
  const mergedBookedSlots = {};
  const processedKeys = new Set(); // è¨˜éŒ„å·²è™•ç†çš„é ç´„éµå€¼
  
  // æŒ‰æ™‚é–“æˆ³æ’åºï¼ˆèˆŠçš„åœ¨å‰ï¼Œæ–°çš„åœ¨å¾Œï¼‰
  const sortedBookings = githubBookings.sort((a, b) => {
    const timeA = new Date(a.timestamp || a.cancelledAt || '1970-01-01');
    const timeB = new Date(b.timestamp || b.cancelledAt || '1970-01-01');
    return timeA - timeB;
  });
  
  // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('æŒ‰æ™‚é–“æˆ³æ’åºçš„é ç´„æ•¸æ“š:', sortedBookings);
  }
  
  sortedBookings.forEach(booking => {
    const bookingKey = `${booking.location}-${booking.date}-${booking.timeSlot || '14:00-20:00'}`;
    
    // å¦‚æœæ˜¯å–æ¶ˆè¨˜éŒ„
    if (booking.action === 'cancelled') {
      // å¾å·²è™•ç†çš„è¨˜éŒ„ä¸­ç§»é™¤
      processedKeys.delete(bookingKey);
      
      // å¾åˆä½µæ•¸æ“šä¸­ç§»é™¤
      const eventIndex = mergedEvents.findIndex(e => 
        e.title === booking.vendor && 
        e.location === booking.location && 
        e.start === booking.date
      );
      if (eventIndex !== -1) {
        mergedEvents.splice(eventIndex, 1);
        // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log(`ç§»é™¤å–æ¶ˆçš„é ç´„: ${booking.vendor} - ${booking.location} - ${booking.date}`);
        }
      }
      
      // å¾å·²é ç´„æ™‚æ®µä¸­ç§»é™¤
      if (mergedBookedSlots[booking.location] && mergedBookedSlots[booking.location][booking.date]) {
        const slotIndex = mergedBookedSlots[booking.location][booking.date].indexOf(booking.timeSlot || '14:00-20:00');
        if (slotIndex !== -1) {
          mergedBookedSlots[booking.location][booking.date].splice(slotIndex, 1);
          
          // å¦‚æœè©²æ—¥æœŸæ²’æœ‰å…¶ä»–æ™‚æ®µï¼Œåˆªé™¤æ•´å€‹æ—¥æœŸ
          if (mergedBookedSlots[booking.location][booking.date].length === 0) {
            delete mergedBookedSlots[booking.location][booking.date];
          }
        }
      }
    } else {
      // å¦‚æœæ˜¯é ç´„è¨˜éŒ„
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éï¼ˆå¾Œä¾†çš„æœƒè¦†è“‹å‰é¢çš„ï¼‰
      if (processedKeys.has(bookingKey)) {
        // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log(`è·³éé‡è¤‡é ç´„: ${booking.vendor} - ${booking.location} - ${booking.date} (å·²æœ‰æ›´æ–°çš„è¨˜éŒ„)`);
        }
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰äº‹ä»¶è¡çª
      const existingEvent = mergedEvents.find(e => 
        e.location === booking.location && 
        e.start === booking.date
      );
      
      if (existingEvent) {
        // æ¯”è¼ƒæ™‚é–“æˆ³ï¼Œä¿ç•™è¼ƒæ–°çš„
        const existingTime = new Date(existingEvent.timestamp || '1970-01-01');
        const newTime = new Date(booking.timestamp || '1970-01-01');
        
        if (newTime > existingTime) {
          // ç§»é™¤èˆŠçš„ï¼Œæ·»åŠ æ–°çš„
          const oldIndex = mergedEvents.indexOf(existingEvent);
          mergedEvents.splice(oldIndex, 1);
          // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log(`æ›¿æ›é ç´„: ${existingEvent.title} â†’ ${booking.vendor} (${booking.location} - ${booking.date})`);
          }
        } else {
          // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log(`ä¿ç•™ç¾æœ‰é ç´„: ${existingEvent.title} (${booking.location} - ${booking.date})`);
          }
          return;
        }
      }
      
      // æ·»åŠ æ–°äº‹ä»¶
      const event = {
        title: booking.vendor,
        start: booking.date,
        location: booking.location,
        color: '#28a745',
        source: 'github',
        timestamp: booking.timestamp
      };
      mergedEvents.push(event);
      
      // æ›´æ–°å·²é ç´„æ™‚æ®µ
      if (!mergedBookedSlots[booking.location]) {
        mergedBookedSlots[booking.location] = {};
      }
      if (!mergedBookedSlots[booking.location][booking.date]) {
        mergedBookedSlots[booking.location][booking.date] = [];
      }
      if (!mergedBookedSlots[booking.location][booking.date].includes(booking.timeSlot || '14:00-20:00')) {
        mergedBookedSlots[booking.location][booking.date].push(booking.timeSlot || '14:00-20:00');
      }
      
      processedKeys.add(bookingKey);
      // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹è¼¸å‡ºè©³ç´°æ—¥èªŒ
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log(`æ·»åŠ é ç´„: ${booking.vendor} - ${booking.location} - ${booking.date}`);
      }
    }
  });
  
  return { mergedEvents, mergedBookedSlots };
}

// å³æ™‚æ•¸æ“šåŒæ­¥
async function syncWithGitHub() {
  try {
    console.log('é–‹å§‹åŒæ­¥GitHubæ•¸æ“š...');
    const githubBookings = await fetchBookingsFromGitHub();
    
    if (githubBookings.length > 0) {
      // ä½¿ç”¨æ™ºèƒ½åˆä½µè™•ç†æ•¸æ“š
      const { mergedEvents, mergedBookedSlots } = mergeDataByTimestamp(githubBookings);
      
      // æ›´æ–°æœ¬åœ°æ•¸æ“šï¼ˆå¾GitHub JSONåŒæ­¥ï¼‰
      allEvents.length = 0;
      allEvents.push(...mergedEvents);
      Object.assign(bookedSlots, mergedBookedSlots);
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
      saveToLocalStorage();
      
      // é‡æ–°æ¸²æŸ“è¡Œäº‹æ›†ï¼ˆé¡¯ç¤ºå¾JSONåŒæ­¥çš„æ•¸æ“šï¼‰
      renderCalendar();
      
      console.log('æ—¥æ›†å·²æ›´æ–°ï¼Œé¡¯ç¤ºå¾GitHub JSONåŒæ­¥çš„é ç´„æ•¸æ“š');
      
      console.log('GitHubæ•¸æ“šåŒæ­¥å®Œæˆï¼Œå…±è™•ç†', githubBookings.length, 'ç­†è¨˜éŒ„');
      showSyncStatus('åŒæ­¥å®Œæˆ', 'success');
    } else {
      showSyncStatus('æ•¸æ“šå·²æ˜¯æœ€æ–°', 'success');
    }
  } catch (error) {
    console.error('åŒæ­¥GitHubæ•¸æ“šå¤±æ•—:', error);
    showSyncStatus('åŒæ­¥å¤±æ•—', 'error');
  }
}

// åŒæ­¥ç‹€æ…‹æ§åˆ¶ - å·²éš±è—ï¼ˆç”¨æˆ¶è¦æ±‚ï¼‰
function showSyncStatus(message, type = 'default') {
  // ä¸é¡¯ç¤ºåŒæ­¥ç‹€æ…‹ï¼Œç”¨æˆ¶è¦æ±‚éš±è—å³ä¸‹è§’æ•¸æ“š
  return;
  
  const status = document.getElementById('syncStatus');
  const icon = status.querySelector('i');
  const text = status.querySelector('span');
  
  status.className = `sync-status show ${type}`;
  text.textContent = message;
  
  if (type === 'default') {
    icon.className = 'fas fa-sync-alt';
  } else if (type === 'success') {
    icon.className = 'fas fa-check';
  } else if (type === 'error') {
    icon.className = 'fas fa-exclamation-triangle';
  }
  
  // æ·»åŠ é»æ“Šæ‰‹å‹•åŒæ­¥åŠŸèƒ½
  status.onclick = function() {
    if (window.manualSync) {
      window.manualSync();
    }
  };
  
  // æ·»åŠ æç¤ºæ–‡å­—
  status.title = 'é»æ“Šæ‰‹å‹•åŒæ­¥æœ€æ–°æ•¸æ“š';
  
  // 5ç§’å¾Œè‡ªå‹•éš±è—ï¼ˆå»¶é•·é¡¯ç¤ºæ™‚é–“ï¼‰
  setTimeout(() => {
    status.classList.remove('show');
  }, 5000);
}

// æª¢æŸ¥é ç´„è¡çªï¼ˆå®Œå…¨ä¾è³´Google Sheetsï¼‰
async function checkBookingConflict(location, date, timeSlot) {
  try {
    console.log(`æª¢æŸ¥é ç´„è¡çª: ${location} - ${date} - ${timeSlot}`);
    
    // 1. æª¢æŸ¥æœ¬åœ°æ•¸æ“š
    if (bookedSlots[location] && bookedSlots[location][date]) {
      if (bookedSlots[location][date].includes(timeSlot)) {
        console.log('æœ¬åœ°æ•¸æ“šç™¼ç¾è¡çª');
        return true;
      }
    }
    
    // 2. æª¢æŸ¥Google Sheetså·²é ç´„æ—¥æœŸï¼ˆæœ€æº–ç¢ºçš„ä¾†æºï¼‰
    if (sheetsBookedDates[location]) {
      const hasConflict = sheetsBookedDates[location].some(booking => 
        booking.standardDate === date
      );
      
      if (hasConflict) {
        console.log('Google Sheetsæ•¸æ“šç™¼ç¾è¡çª');
        return true;
      }
    }
    
    // 3. æª¢æŸ¥allEventsä¸­çš„é ç´„
    const hasEventConflict = allEvents.some(event => {
      let eventDate;
      if (event.start instanceof Date) {
        eventDate = `${event.start.getFullYear()}-${String(event.start.getMonth() + 1).padStart(2, '0')}-${String(event.start.getDate()).padStart(2, '0')}`;
      } else {
        eventDate = event.start.split('T')[0];
      }
      return eventDate === date && event.location === location;
    });
    
    if (hasEventConflict) {
      console.log('æ—¥æ›†äº‹ä»¶ç™¼ç¾è¡çª');
      return true;
    }
    
    console.log('æ²’æœ‰ç™¼ç¾è¡çª');
    return false;
  } catch (error) {
    console.error('æª¢æŸ¥é ç´„è¡çªå¤±æ•—:', error);
    // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œè¿”å›falseè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒé ç´„
    return false;
  }
}

// å³æ™‚æ•¸æ“šåŒæ­¥ç³»çµ±ï¼ˆæš«æ™‚ç¦ç”¨GitHubåŒæ­¥ï¼‰
function startPeriodicSync() {
  console.log('GitHubå®šæœŸåŒæ­¥å·²ç¦ç”¨ï¼Œç³»çµ±å®Œå…¨ä¾è³´Google Sheets');
  
  // æš«æ™‚ç¦ç”¨æ‰€æœ‰GitHubåŒæ­¥ï¼Œé¿å…401éŒ¯èª¤
  // ç³»çµ±ä¸»è¦ä¾è³´Google Sheetsé‹ä½œ
  
  // let lastSyncTime = 0;
  // const SYNC_INTERVAL = 60000;
  // const MIN_SYNC_INTERVAL = 30000;
  // const FAST_SYNC_INTERVAL = 5000;
  
  // async function smartSync(force = false, fast = false) {
  //   const now = Date.now();
  //   const minInterval = fast ? FAST_SYNC_INTERVAL : MIN_SYNC_INTERVAL;
  //   
  //   if (!force && (now - lastSyncTime) < minInterval) {
  //     console.log('è·³éGitHubåŒæ­¥ï¼šè·é›¢ä¸Šæ¬¡åŒæ­¥æ™‚é–“å¤ªçŸ­');
  //     return;
  //   }
  //   
  //   lastSyncTime = now;
  //   showSyncStatus('åŒæ­¥ä¸­...', 'default');
  //   await syncWithGitHub();
  // }
  
  // setInterval(() => {
  //   smartSync();
  // }, SYNC_INTERVAL);
  
  // document.addEventListener('visibilitychange', async () => {
  //   if (!document.hidden) {
  //     await smartSync(true, true);
  //   }
  // });
  
  // ç¦ç”¨ç”¨æˆ¶é»æ“Šè§¸ç™¼åŒæ­¥ï¼ˆé¿å…éæ–¼é »ç¹ï¼‰
  // let syncTimeout;
  // document.addEventListener('click', () => {
  //   clearTimeout(syncTimeout);
  //   syncTimeout = setTimeout(() => {
  //     smartSync(false, true); // å¿«é€ŸåŒæ­¥
  //   }, 1000); // 1ç§’å¾Œå¿«é€ŸåŒæ­¥
  // });
  
  // ç¦ç”¨è¡¨å–®æäº¤è§¸ç™¼åŒæ­¥ï¼ˆå·²åœ¨æäº¤æˆåŠŸå¾Œæ‰‹å‹•è§¸ç™¼ï¼‰
  // document.addEventListener('submit', () => {
  //   setTimeout(() => {
  //     smartSync(true, true); // å¼·åˆ¶å¿«é€ŸåŒæ­¥
  //   }, 500);
  // });
  
  // GitHubåŒæ­¥å·²ç¦ç”¨
  // let lastFocusSync = 0;
  // window.addEventListener('focus', () => {
  //   const now = Date.now();
  //   if (now - lastFocusSync > 60000) {
  //     lastFocusSync = now;
  //     smartSync(true, true);
  //   }
  // });
  
  // window.addEventListener('online', () => {
  //   smartSync(true, true);
  // });
  
  // æ·»åŠ æ‰‹å‹•åŒæ­¥åŠŸèƒ½
  window.manualSync = async function() {
    showSyncStatus('æ‰‹å‹•åŒæ­¥ä¸­...', 'default');
    await smartSync(true);
  };
  
  // æ·»åŠ æ¸¬è©¦åŒæ­¥åŠŸèƒ½
  window.testSync = async function() {
    console.log('é–‹å§‹æ¸¬è©¦åŒæ­¥...');
    showSyncStatus('æ¸¬è©¦åŒæ­¥ä¸­...', 'default');
    
    try {
      await syncWithGitHub();
      console.log('æ¸¬è©¦åŒæ­¥å®Œæˆ');
    } catch (error) {
      console.error('æ¸¬è©¦åŒæ­¥å¤±æ•—:', error);
      showSyncStatus('æ¸¬è©¦åŒæ­¥å¤±æ•—', 'error');
    }
  };
  
  // æ·»åŠ GitHubè¨ºæ–·åŠŸèƒ½
  window.diagnoseGitHub = async function() {
    console.log('é–‹å§‹è¨ºæ–·GitHubé€£æ¥...');
    
    try {
      // æ¸¬è©¦1: æª¢æŸ¥Token
      console.log('æ¸¬è©¦1: æª¢æŸ¥Tokenæ¬Šé™...');
      const userResponse = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (userResponse.ok) {
        const userData = await userResponse.json();
        console.log('âœ… Tokenæœ‰æ•ˆï¼Œç”¨æˆ¶:', userData.login);
      } else {
        console.error('âŒ Tokenç„¡æ•ˆ:', userResponse.status, await userResponse.text());
        return;
      }
      
      // æ¸¬è©¦2: æª¢æŸ¥å€‰åº«
      console.log('æ¸¬è©¦2: æª¢æŸ¥å€‰åº«æ¬Šé™...');
      const repoResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (repoResponse.ok) {
        const repoData = await repoResponse.json();
        console.log('âœ… å€‰åº«å¯è¨ªå•:', repoData.full_name);
      } else {
        console.error('âŒ å€‰åº«ç„¡æ³•è¨ªå•:', repoResponse.status, await repoResponse.text());
        return;
      }
      
      // æ¸¬è©¦3: æª¢æŸ¥bookingsç›®éŒ„
      console.log('æ¸¬è©¦3: æª¢æŸ¥bookingsç›®éŒ„...');
      const bookingsResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/bookings`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (bookingsResponse.ok) {
        const bookingsData = await bookingsResponse.json();
        console.log('âœ… bookingsç›®éŒ„å¯è¨ªå•ï¼Œæ–‡ä»¶æ•¸é‡:', bookingsData.length);
      } else {
        console.error('âŒ bookingsç›®éŒ„ç„¡æ³•è¨ªå•:', bookingsResponse.status, await bookingsResponse.text());
      }
      
      // æ¸¬è©¦4: å˜—è©¦ä¸Šå‚³æ¸¬è©¦æ–‡ä»¶
      console.log('æ¸¬è©¦4: å˜—è©¦ä¸Šå‚³æ¸¬è©¦æ–‡ä»¶...');
      const testData = {
        vendor: 'è¨ºæ–·æ¸¬è©¦',
        location: 'å››ç¶­è·¯59è™Ÿ',
        date: new Date().toISOString().split('T')[0],
        timeSlot: '14:00-20:00',
        fee: '600',
        timestamp: formatTimestamp(),
        uploadTime: Date.now()
      };
      
      const result = await uploadToGitHub(testData);
      console.log('âœ… æ¸¬è©¦ä¸Šå‚³æˆåŠŸ:', result);
      
    } catch (error) {
      console.error('âŒ è¨ºæ–·å¤±æ•—:', error);
    }
  };
  
  // æ·»åŠ æ¸¬è©¦index.htmlæ›´æ–°åŠŸèƒ½
  window.testIndexUpdate = async function() {
    console.log('é–‹å§‹æ¸¬è©¦index.htmlæ›´æ–°åŠŸèƒ½...');
    
    try {
      const testData = {
        vendor: 'æ¸¬è©¦æ›´æ–°',
        location: 'å››ç¶­è·¯60è™Ÿ',
        date: formatTimestamp().split('T')[0],
        timeSlot: '14:00-20:00',
        foodType: 'æ¸¬è©¦é¡å‹',
        fee: '600',
        timestamp: formatTimestamp(),
        uploadTime: Date.now()
      };
      
      const result = await updateIndexHtmlOnGitHub(testData);
      console.log('âœ… index.htmlæ›´æ–°æ¸¬è©¦æˆåŠŸ:', result);
      showToast('success', 'æ¸¬è©¦æˆåŠŸ', 'index.htmlæ›´æ–°åŠŸèƒ½æ­£å¸¸');
      
    } catch (error) {
      console.error('âŒ index.htmlæ›´æ–°æ¸¬è©¦å¤±æ•—:', error);
      showToast('error', 'æ¸¬è©¦å¤±æ•—', 'index.htmlæ›´æ–°åŠŸèƒ½ç•°å¸¸: ' + error.message);
    }
  };
  
  // æ·»åŠ æ¸¬è©¦çµ±è¨ˆè¨ˆç®—åŠŸèƒ½
  window.testStatsCalculation = async function() {
    console.log('é–‹å§‹æ¸¬è©¦çµ±è¨ˆè¨ˆç®—åŠŸèƒ½...');
    
    try {
      const stats = await calculateAccurateStats();
      console.log('âœ… çµ±è¨ˆè¨ˆç®—æ¸¬è©¦æˆåŠŸ:', stats);
      showToast('success', 'çµ±è¨ˆè¨ˆç®—æˆåŠŸ', `ç¸½é ç´„: ${stats.totalBookings}, ä»Šæ—¥: ${stats.todayBookings}, æ´»èºå ´åœ°: ${stats.activeLocations}`);
      
    } catch (error) {
      console.error('âŒ çµ±è¨ˆè¨ˆç®—æ¸¬è©¦å¤±æ•—:', error);
      showToast('error', 'çµ±è¨ˆè¨ˆç®—å¤±æ•—', 'çµ±è¨ˆè¨ˆç®—åŠŸèƒ½ç•°å¸¸: ' + error.message);
    }
  };
  
  // æ·»åŠ æ¸¬è©¦å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°åŠŸèƒ½
  window.testRealtimeDataUpdate = async function() {
    console.log('é–‹å§‹æ¸¬è©¦å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°åŠŸèƒ½...');
    
    try {
      const result = await updateRealtimeDataFile();
      console.log('âœ… å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°æ¸¬è©¦æˆåŠŸ:', result);
      showToast('success', 'å³æ™‚æ•¸æ“šæ›´æ–°æˆåŠŸ', 'å³æ™‚æ•¸æ“šæ–‡ä»¶å·²æ›´æ–°åˆ°GitHub');
      
    } catch (error) {
      console.error('âŒ å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°æ¸¬è©¦å¤±æ•—:', error);
      showToast('error', 'å³æ™‚æ•¸æ“šæ›´æ–°å¤±æ•—', 'å³æ™‚æ•¸æ“šæ–‡ä»¶æ›´æ–°ç•°å¸¸: ' + error.message);
    }
  };
  
  // æ·»åŠ Tokenæ›´æ–°åŠŸèƒ½
  window.updateGitHubToken = function(newToken) {
    if (!newToken || !newToken.startsWith('ghp_')) {
      console.error('âŒ ç„¡æ•ˆçš„Tokenæ ¼å¼ï¼ŒTokenæ‡‰è©²ä»¥ghp_é–‹é ­');
      showToast('error', 'Tokenæ ¼å¼éŒ¯èª¤', 'Tokenæ‡‰è©²ä»¥ghp_é–‹é ­');
      return false;
    }
    
    GITHUB_CONFIG.token = newToken;
    console.log('âœ… GitHub Tokenå·²æ›´æ–°');
    showToast('success', 'Tokenå·²æ›´æ–°', 'GitHub Tokenå·²æˆåŠŸæ›´æ–°');
    
    // ç«‹å³æ¸¬è©¦æ–°Token
    setTimeout(() => {
      diagnoseGitHub();
    }, 1000);
    
    return true;
  };
  
  
  // æ·»åŠ æ—¥æ›†æ•¸æ“šåŒæ­¥æ¸¬è©¦
  window.testCalendarSync = async function() {
    console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦æ—¥æ›†æ•¸æ“šåŒæ­¥...');
    
    try {
      // 1. æª¢æŸ¥ç•¶å‰æ—¥æ›†æ•¸æ“š
      console.log('ç•¶å‰æ—¥æ›†äº‹ä»¶æ•¸é‡:', allEvents.length);
      console.log('ç•¶å‰é ç´„æ™‚æ®µ:', Object.keys(bookedSlots).length);
      
      // 2. å¾GitHubåŒæ­¥æ•¸æ“š
      console.log('å¾GitHubåŒæ­¥æ•¸æ“š...');
      await syncWithGitHub();
      
      // 3. æª¢æŸ¥åŒæ­¥å¾Œçš„æ•¸æ“š
      console.log('åŒæ­¥å¾Œæ—¥æ›†äº‹ä»¶æ•¸é‡:', allEvents.length);
      console.log('åŒæ­¥å¾Œé ç´„æ™‚æ®µ:', Object.keys(bookedSlots).length);
      
      // 4. æª¢æŸ¥æ—¥æ›†æ˜¯å¦æ­£ç¢ºæ¸²æŸ“
      const calendarGrid = document.getElementById('calendarGrid');
      const eventElements = calendarGrid.querySelectorAll('.event-item');
      console.log('æ—¥æ›†ä¸­é¡¯ç¤ºçš„äº‹ä»¶æ•¸é‡:', eventElements.length);
      
      showToast('success', 'æ—¥æ›†åŒæ­¥æ¸¬è©¦å®Œæˆ', `æ—¥æ›†äº‹ä»¶: ${allEvents.length}, é¡¯ç¤ºäº‹ä»¶: ${eventElements.length}`);
      
    } catch (error) {
      console.error('âŒ æ—¥æ›†åŒæ­¥æ¸¬è©¦å¤±æ•—:', error);
      showToast('error', 'æ—¥æ›†åŒæ­¥æ¸¬è©¦å¤±æ•—', error.message);
    }
  };
  
  // æ·»åŠ è©³ç´°çš„GitHubéŒ¯èª¤è¨ºæ–·
  window.diagnoseGitHubDetailed = async function() {
    console.log('ğŸ” é–‹å§‹è©³ç´°è¨ºæ–·GitHubå•é¡Œ...');
    
    try {
      // æ¸¬è©¦1: åŸºæœ¬é€£æ¥
      console.log('æ¸¬è©¦1: åŸºæœ¬APIé€£æ¥...');
      const basicResponse = await fetch('https://api.github.com/zen');
      if (basicResponse.ok) {
        const zen = await basicResponse.text();
        console.log('âœ… GitHub APIå¯è¨ªå•:', zen);
      } else {
        console.error('âŒ GitHub APIç„¡æ³•è¨ªå•:', basicResponse.status);
        return;
      }
      
      // æ¸¬è©¦2: Tokené©—è­‰
      console.log('æ¸¬è©¦2: Tokené©—è­‰...');
      const userResponse = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (userResponse.ok) {
        const userData = await userResponse.json();
        console.log('âœ… Tokenæœ‰æ•ˆï¼Œç”¨æˆ¶:', userData.login);
        console.log('ç”¨æˆ¶ä¿¡æ¯:', userData);
      } else {
        const errorText = await userResponse.text();
        console.error('âŒ Tokenç„¡æ•ˆ:', userResponse.status, errorText);
        return;
      }
      
      // æ¸¬è©¦3: å€‰åº«è¨ªå•
      console.log('æ¸¬è©¦3: å€‰åº«è¨ªå•...');
      const repoResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (repoResponse.ok) {
        const repoData = await repoResponse.json();
        console.log('âœ… å€‰åº«å¯è¨ªå•:', repoData.full_name);
        console.log('å€‰åº«ä¿¡æ¯:', {
          name: repoData.name,
          full_name: repoData.full_name,
          private: repoData.private,
          permissions: repoData.permissions
        });
      } else {
        const errorText = await repoResponse.text();
        console.error('âŒ å€‰åº«ç„¡æ³•è¨ªå•:', repoResponse.status, errorText);
        return;
      }
      
      // æ¸¬è©¦4: å‰µå»ºæ¸¬è©¦æ–‡ä»¶
      console.log('æ¸¬è©¦4: å‰µå»ºæ¸¬è©¦æ–‡ä»¶...');
      const testContent = JSON.stringify({
        test: true,
        timestamp: formatTimestamp(),
        message: 'GitHubé€£æ¥æ¸¬è©¦'
      }, null, 2);
      
      const testResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/test-connection.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.github+json'
        },
        body: JSON.stringify({
          message: 'æ¸¬è©¦GitHubé€£æ¥',
          content: safeBase64Encode(testContent),
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (testResponse.ok) {
        const testResult = await testResponse.json();
        console.log('âœ… æ¸¬è©¦æ–‡ä»¶å‰µå»ºæˆåŠŸ:', testResult.content.html_url);
        
        // åˆªé™¤æ¸¬è©¦æ–‡ä»¶
        setTimeout(async () => {
          try {
            const deleteResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/test-connection.json`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github+json'
              },
              body: JSON.stringify({
                message: 'åˆªé™¤æ¸¬è©¦æ–‡ä»¶',
                sha: testResult.content.sha,
                branch: GITHUB_CONFIG.branch
              })
            });
            
            if (deleteResponse.ok) {
              console.log('âœ… æ¸¬è©¦æ–‡ä»¶å·²åˆªé™¤');
            } else {
              console.log('âš ï¸ æ¸¬è©¦æ–‡ä»¶åˆªé™¤å¤±æ•—ï¼Œä½†é€™ä¸å½±éŸ¿åŠŸèƒ½');
            }
          } catch (error) {
            console.log('âš ï¸ æ¸¬è©¦æ–‡ä»¶åˆªé™¤å¤±æ•—ï¼Œä½†é€™ä¸å½±éŸ¿åŠŸèƒ½');
          }
        }, 2000);
        
      } else {
        const errorText = await testResponse.text();
        console.error('âŒ æ¸¬è©¦æ–‡ä»¶å‰µå»ºå¤±æ•—:', testResponse.status, errorText);
      }
      
      console.log('ğŸ‰ GitHubè©³ç´°è¨ºæ–·å®Œæˆï¼');
      
    } catch (error) {
      console.error('âŒ è¨ºæ–·éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
    }
  };
  
  // å³æ™‚æ•¸æ“šç›£è½å™¨ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…ç„¡é™å¾ªç’°ï¼‰
  // let lastDataHash = '';
  // async function checkForDataChanges() {
  //   try {
  //     // ç²å–ç•¶å‰æ•¸æ“šçš„å“ˆå¸Œå€¼ï¼ˆä½¿ç”¨ç°¡å–®çš„å­—ç¬¦ä¸²é•·åº¦å’Œå…§å®¹æª¢æŸ¥ï¼‰
  //     const currentData = JSON.stringify({ allEvents, bookedSlots });
  //     const currentHash = currentData.length + '_' + currentData.slice(0, 50); // ç°¡å–®å“ˆå¸Œ
  //     
  //     if (currentHash !== lastDataHash) {
  //       lastDataHash = currentHash;
  //       // æ•¸æ“šæœ‰è®ŠåŒ–ï¼Œè§¸ç™¼å¿«é€ŸåŒæ­¥
  //       await smartSync(false, true);
  //     }
  //   } catch (error) {
  //     console.error('æ•¸æ“šè®ŠåŒ–æª¢æ¸¬å¤±æ•—:', error);
  //   }
  // }
  // 
  // // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡æ•¸æ“šè®ŠåŒ–
  // setInterval(checkForDataChanges, 2000);
  
  // ç›£è½å…¶ä»–é ç±¤çš„æ•¸æ“šè®ŠåŒ–ï¼ˆä½¿ç”¨localStorageäº‹ä»¶ï¼‰
  window.addEventListener('storage', (e) => {
    if (e.key === 'foodtruck_bookings' || e.key === 'foodtruck_bookedSlots') {
      // å…¶ä»–é ç±¤æ›´æ–°äº†æ•¸æ“šï¼Œç«‹å³åŒæ­¥
      setTimeout(() => {
        smartSync(true, true);
      }, 100);
    }
  });
  
  // æ·»åŠ GitHubé€£æ¥æ¸¬è©¦åŠŸèƒ½
  window.testGitHubConnection = async function() {
    try {
      console.log('æ¸¬è©¦GitHubé€£æ¥...');
      showSyncStatus('æ¸¬è©¦GitHubé€£æ¥...', 'default');
      
      // æ¸¬è©¦ç²å–å€‰åº«ä¿¡æ¯
      const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
        headers: {
          'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
          'Accept': 'application/vnd.github+json'
        }
      });
      
      if (response.ok) {
        const repo = await response.json();
        console.log('GitHubå€‰åº«ä¿¡æ¯:', repo);
        showSyncStatus('GitHubé€£æ¥æ­£å¸¸', 'success');
        
        // æ¸¬è©¦ç²å–bookingsç›®éŒ„
        const bookingsResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/bookings`, {
          headers: {
            'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
            'Accept': 'application/vnd.github+json'
          }
        });
        
        if (bookingsResponse.ok) {
          const files = await bookingsResponse.json();
          console.log('bookingsç›®éŒ„æ–‡ä»¶:', files);
          showSyncStatus(`GitHubé€£æ¥æ­£å¸¸ï¼Œæ‰¾åˆ°${files.length}å€‹æ–‡ä»¶`, 'success');
        } else {
          console.error('ç„¡æ³•è¨ªå•bookingsç›®éŒ„:', bookingsResponse.status);
          showSyncStatus('GitHubé€£æ¥æ­£å¸¸ï¼Œä½†ç„¡æ³•è¨ªå•bookingsç›®éŒ„', 'error');
        }
      } else {
        const error = await response.text();
        console.error('GitHubé€£æ¥å¤±æ•—:', response.status, error);
        showSyncStatus('GitHubé€£æ¥å¤±æ•—', 'error');
      }
    } catch (error) {
      console.error('GitHubé€£æ¥æ¸¬è©¦éŒ¯èª¤:', error);
      showSyncStatus('GitHubé€£æ¥æ¸¬è©¦å¤±æ•—', 'error');
    }
  };
  
  // æ·»åŠ æ‰‹å‹•å‰µå»ºç›®éŒ„åŠŸèƒ½
  window.createGitHubDirectories = async function() {
    try {
      console.log('é–‹å§‹å‰µå»ºGitHubç›®éŒ„...');
      showSyncStatus('å‰µå»ºGitHubç›®éŒ„...', 'default');
      
      const bookingsResult = await createGitHubDirectory('bookings');
      const cancellationsResult = await createGitHubDirectory('cancellations');
      
      if (bookingsResult && cancellationsResult) {
        showSyncStatus('æˆåŠŸå‰µå»ºæ‰€æœ‰ç›®éŒ„', 'success');
        console.log('æ‰€æœ‰ç›®éŒ„å‰µå»ºæˆåŠŸ');
      } else {
        showSyncStatus('éƒ¨åˆ†ç›®éŒ„å‰µå»ºå¤±æ•—', 'error');
        console.log('ç›®éŒ„å‰µå»ºçµæœ:', { bookingsResult, cancellationsResult });
      }
    } catch (error) {
      console.error('å‰µå»ºç›®éŒ„éŒ¯èª¤:', error);
      showSyncStatus('å‰µå»ºç›®éŒ„å¤±æ•—', 'error');
    }
  };
}

// æ‰€æœ‰å ´åœ°çš„é ç´„äº‹ä»¶ - æ ¹æ“šGoogle Sheets 10æœˆä»½å¯¦éš›æ’ç­è³‡æ–™æ›´æ–°
// æ‰€æœ‰äº‹ä»¶ - ç¾åœ¨å®Œå…¨å¾ Google Sheets å‹•æ…‹è¼‰å…¥
let allEvents = [];

// æ–°è¡Œäº‹æ›†ç³»çµ±
let currentDate = new Date(); // ç•¶å‰æ—¥æœŸ
let currentFilter = 'å››ç¶­è·¯59è™Ÿ';

// åˆå§‹åŒ–æ–°è¡Œäº‹æ›†
function initNewCalendar() {
  renderCalendar();
  setupCalendarEvents();
}

// æ¸²æŸ“è¡Œäº‹æ›†
function renderCalendar() {
  const calendarGrid = document.getElementById('calendarGrid');
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // æ›´æ–°æœˆä»½é¡¯ç¤º
  document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
  
  // æ¸…ç©ºç¶²æ ¼
  calendarGrid.innerHTML = '';
  
  // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
  const dayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  dayHeaders.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    header.textContent = day;
    calendarGrid.appendChild(header);
  });
  
  // ç²å–æœˆä»½çš„ç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  // ç”Ÿæˆ42å€‹æ—¥æœŸæ ¼å­ï¼ˆ6é€±ï¼‰
  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºå…¶ä»–æœˆä»½
    if (date.getMonth() !== month) {
      dayElement.classList.add('other-month');
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
    const today = new Date();
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºéå»æ—¥æœŸ
    const todayForComparison = new Date();
    todayForComparison.setHours(0, 0, 0, 0);
    const dateForComparison = new Date(date);
    dateForComparison.setHours(0, 0, 0, 0);
    
    if (dateForComparison < todayForComparison) {
      dayElement.classList.add('past-date');
    }
    
    // æ·»åŠ æ—¥æœŸæ•¸å­—
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = date.getDate();
    dayElement.appendChild(dayNumber);
    
    // æ·»åŠ äº‹ä»¶
    const eventsContainer = document.createElement('div');
    eventsContainer.className = 'day-events';
    
    // ä¿®æ­£æ™‚å€å•é¡Œï¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const dayEvents = allEvents.filter(event => {
      const eventDate = event.start instanceof Date ? 
        `${event.start.getFullYear()}-${String(event.start.getMonth() + 1).padStart(2, '0')}-${String(event.start.getDate()).padStart(2, '0')}` : 
        event.start.split('T')[0];
      return eventDate === dateStr;
    });
    
    let paymentStatusElement = null; // ä¿å­˜ä»˜æ¬¾ç‹€æ…‹å…ƒç´ 
    
    dayEvents.forEach(event => {
      // åªé¡¯ç¤ºç•¶å‰ç¯©é¸å ´åœ°çš„äº‹ä»¶
      if (event.location === currentFilter) {
        const eventContainer = document.createElement('div');
        eventContainer.className = 'event-container';
        
        const eventElement = document.createElement('div');
        eventElement.className = 'event-item';
        eventElement.textContent = event.title;
        eventElement.title = `${event.title} - ${event.location}`;
        eventElement.addEventListener('click', () => {
          // å¦‚æœæ˜¯å·±ä»˜æ¬¾çš„é ç´„ï¼Œé¡¯ç¤ºé‡‹å‡ºé¸é …
          if (event.payment === 'å·²ä»˜æ¬¾' || event.payment === 'å·±ç¹³æ¬¾') {
            showTransferModal(event, dateStr);
          } else {
            showToast('info', 'é¤è»Šè³‡è¨Š', `${event.title}\nå ´åœ°ï¼š${event.location}\næ™‚é–“ï¼š14:00-20:00`);
          }
        });
        
        eventContainer.appendChild(eventElement);
        
        // æ·»åŠ ä»˜æ¬¾ç‹€æ…‹å’Œå€’è¨ˆæ™‚
        let isOverdue = false;
        let needsPayment = false;
        
        if (event.payment || event.timestamp || event.bookedStatus) {
          const paymentStatus = document.createElement('div');
          paymentStatus.className = 'payment-status';
          
          // æ—¥èªŒï¼šè¨ºæ–·ä»˜æ¬¾ç‹€æ…‹
          console.log(`ğŸ“Š ä»˜æ¬¾ç‹€æ…‹æª¢æŸ¥ - é¤è»Š: ${event.title}, payment: "${event.payment}", bookedStatus: "${event.bookedStatus}"`);
          
          // æª¢æŸ¥ä»˜æ¬¾ç‹€æ…‹ï¼ˆåŒ…å«ã€Œå·²ä»˜æ¬¾ã€å’Œã€Œå·±ç¹³æ¬¾ã€ï¼‰
          if (event.payment === 'å·²ä»˜æ¬¾' || event.payment === 'å·±ç¹³æ¬¾') {
            console.log('  âœ… å·²ä»˜æ¬¾ - é¡¯ç¤ºå¯é‡‹å‡º');
            paymentStatus.innerHTML = '<span class="paid">âœ“ å·²ä»˜æ¬¾</span>';
            paymentStatus.classList.add('paid-status');
            // å·²ä»˜æ¬¾çš„é ç´„å¯ä»¥é»æ“Šé‡‹å‡º
            paymentStatus.style.cursor = 'pointer';
            paymentStatus.title = 'é»æ“Šé‡‹å‡ºæ’ç­';
            paymentStatus.addEventListener('click', (e) => {
              e.stopPropagation();
              showTransferModal(event, dateStr);
            });
          } 
          // æª¢æŸ¥æ˜¯å¦ç‚ºé€¾ç¹³å¯æ’ç‹€æ…‹ï¼ˆä¾†è‡ªGoogle Sheetsï¼‰
          else if (event.bookedStatus === 'é€¾ç¹³å¯æ’') {
            isOverdue = true;
            paymentStatus.innerHTML = '<span class="unpaid overdue">âŒ é€¾ç¹³å¯æ’</span>';
            paymentStatus.classList.add('overdue-status');
            // é»æ“Šæ–‡å­—æ‰“é–‹æ¥æ‰‹å½ˆçª—
            paymentStatus.addEventListener('click', (e) => {
              e.stopPropagation();
              showTakeoverModal(event, dateStr);
            });
            paymentStatus.title = 'é»æ“Šæ¥æ‰‹æ­¤é ç´„';
          } 
          // ä¸€èˆ¬æœªä»˜æ¬¾ç‹€æ…‹
          else {
            console.log('  â° æœªä»˜æ¬¾ - é¡¯ç¤ºå€’è¨ˆæ™‚');
            // è¨ˆç®—24å°æ™‚å€’è¨ˆæ™‚
            console.log('è¨ˆç®—å€’è¨ˆæ™‚ - æ™‚é–“æˆ³è¨˜:', event.timestamp);
            const bookingTime = new Date(event.timestamp);
            console.log('è¨ˆç®—å€’è¨ˆæ™‚ - é ç´„æ™‚é–“:', bookingTime.toISOString());
            const deadline = new Date(bookingTime.getTime() + 24 * 60 * 60 * 1000); // 24å°æ™‚å¾Œ
            console.log('è¨ˆç®—å€’è¨ˆæ™‚ - æˆªæ­¢æ™‚é–“:', deadline.toISOString());
            const now = new Date();
            const timeLeft = deadline - now;
            console.log('è¨ˆç®—å€’è¨ˆæ™‚ - å‰©é¤˜æ¯«ç§’:', timeLeft);
            
            if (timeLeft > 0) {
              needsPayment = true;
              const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
              const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
              
              if (hoursLeft < 6) {
                // å°‘æ–¼6å°æ™‚ï¼Œæ©™ç´…è­¦å‘Š
                paymentStatus.innerHTML = `<span class="unpaid urgent">âš ï¸ ${hoursLeft}h${minutesLeft}mç¹³è²»æ™‚é–“</span>`;
              } else {
                // é‚„æœ‰æ™‚é–“ï¼Œé»ƒè‰²æé†’
                paymentStatus.innerHTML = `<span class="unpaid">â° ${hoursLeft}hç¹³è²»æ™‚é–“</span>`;
              }
              paymentStatus.classList.add('unpaid-status');
              // é»æ“Šæ–‡å­—æ‰“é–‹ç¹³è²»å½ˆçª—
              paymentStatus.addEventListener('click', (e) => {
                e.stopPropagation();
                showPaymentModal();
              });
              paymentStatus.title = 'é»æ“Šå‰å¾€ç¹³è²»';
            } else {
              // å·²é€¾æœŸï¼ˆè¶…é24å°æ™‚ï¼‰
              isOverdue = true;
              paymentStatus.innerHTML = '<span class="unpaid overdue">âŒ é€¾ç¹³å¯æ’</span>';
              paymentStatus.classList.add('overdue-status');
              // é»æ“Šæ–‡å­—æ‰“é–‹æ¥æ‰‹å½ˆçª—
              paymentStatus.addEventListener('click', (e) => {
                e.stopPropagation();
                showTakeoverModal(event, dateStr);
              });
              paymentStatus.title = 'é»æ“Šæ¥æ‰‹æ­¤é ç´„';
            }
          }
          
          // ä¿å­˜ä»˜æ¬¾ç‹€æ…‹å…ƒç´ ï¼Œç¨å¾Œappendåˆ°dayElement
          paymentStatusElement = paymentStatus;
        }
        
        // æ·»åŠ å–æ¶ˆæŒ‰éˆ•ï¼ˆåªå°ç•¶å¤©å’Œæœªä¾†æ—¥æœŸé¡¯ç¤ºï¼‰
        const today = new Date();
        today.setHours(0, 0, 0, 0); // é‡ç½®æ™‚é–“åˆ°ç•¶å¤©é–‹å§‹
        
        const eventDate = new Date(dateStr);
        eventDate.setHours(0, 0, 0, 0); // é‡ç½®æ™‚é–“åˆ°ç•¶å¤©é–‹å§‹
        
        const isTodayOrFuture = eventDate >= today;
        
        if (isTodayOrFuture) {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'cancel-btn';
          cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
          cancelBtn.title = 'å–æ¶ˆé ç´„';
          cancelBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            cancelBooking(event, dateStr);
          });
          eventContainer.appendChild(cancelBtn);
        }
        
        eventsContainer.appendChild(eventContainer);
      }
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é ç´„
    if (dayEvents.length > 0) {
      const hasEventForLocation = dayEvents.some(event => event.location === currentFilter);
      if (hasEventForLocation) {
        dayElement.classList.add('booked');
      }
    }
    
    // æª¢æŸ¥å„å ´åœ°çš„éé–‹æ”¾æ—¥æœŸ
    if (date.getMonth() === month) {
      const dayOfWeek = date.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, 2=é€±äºŒ, 3=é€±ä¸‰, 4=é€±å››, 5=é€±äº”, 6=é€±å…­
      let isNonOperating = false;
      
      switch (currentFilter) {
        case 'å››ç¶­è·¯60è™Ÿ':
          // é€±å››~é€±æ—¥ä¸é–‹æ”¾
          if (dayOfWeek >= 4 || dayOfWeek === 0) {
            isNonOperating = true;
          }
          // åªæœ‰åœ¨ç‡Ÿæ¥­æ—¥ï¼ˆé€±ä¸€~é€±ä¸‰ï¼‰æ‰æª¢æŸ¥ä¸¦æ¨™è¨˜åœ‹å®šå‡æ—¥
          else if (nationalHolidays2025.includes(dateStr)) {
            const holidayBadge = document.createElement('div');
            holidayBadge.className = 'holiday-badge';
            holidayBadge.innerHTML = 'âŒ åœ‹å®šå‡æ—¥';
            holidayBadge.title = getHolidayName(dateStr);
            dayElement.appendChild(holidayBadge);
            dayElement.classList.add('holiday-date');
          }
          break;
        case 'è”¬è’”':
          // åªæœ‰é€±ä¸‰ã€é€±å…­å¯æ’
          if (dayOfWeek !== 3 && dayOfWeek !== 6) {
            isNonOperating = true;
          }
          break;
        case 'é‡‘æ­£å¥½åƒ':
          // åªæœ‰é€±äºŒå¯æ’
          if (dayOfWeek !== 2) {
            isNonOperating = true;
          }
          break;
        case 'è‡ªç”±é¢¨':
          // é€±ä¸‰ã€é€±å…­ä¸æ’ï¼Œå…¶å®ƒéƒ½å¯æ’
          if (dayOfWeek === 3 || dayOfWeek === 6) {
            isNonOperating = true;
          }
          break;
        case 'æ¼¢å ¡å¤§äº¨': // å››ç¶­è·¯70è™Ÿ
          // é€±æ—¥ä¸æ’ï¼Œå…¶å®ƒéƒ½å¯æ’
          if (dayOfWeek === 0) {
            isNonOperating = true;
          }
          break;
      }
      
      if (isNonOperating) {
        dayElement.classList.add('non-operating');
      }
    }
    
    dayElement.appendChild(eventsContainer);
    
    // å¦‚æœæœ‰ä»˜æ¬¾ç‹€æ…‹ï¼Œç›´æ¥appendåˆ°dayElementï¼ˆé€™æ¨£å®ƒå°±èƒ½ç§»åˆ°æœ€ä¸Šæ–¹ï¼‰
    if (paymentStatusElement) {
      dayElement.appendChild(paymentStatusElement);
    }
    
    // ç‚ºç©ºç™½ä¸”å¯é ç´„çš„æ—¥æœŸæ·»åŠ é»æ“Šé ç´„åŠŸèƒ½
    const isEmptyDay = dayEvents.length === 0 || !dayEvents.some(e => e.location === currentFilter);
    const isCurrentMonth = date.getMonth() === month;
    const isFuture = dateForComparison >= todayForComparison;
    const isOperating = !dayElement.classList.contains('non-operating');
    
    if (isEmptyDay && isCurrentMonth && isFuture && isOperating) {
      dayElement.style.cursor = 'pointer';
      dayElement.title = 'é»æ“Šå¿«é€Ÿé ç´„';
      
      // æ·»åŠ hoveræ•ˆæœ
      dayElement.addEventListener('mouseenter', () => {
        if (!dayElement.classList.contains('booked') && !dayElement.classList.contains('non-operating')) {
          dayElement.style.backgroundColor = '#fff5f0';
        }
      });
      
      dayElement.addEventListener('mouseleave', () => {
        if (!dayElement.classList.contains('booked') && !dayElement.classList.contains('non-operating')) {
          dayElement.style.backgroundColor = '';
        }
      });
      
      // é»æ“Šäº‹ä»¶ - å¿«é€Ÿé ç´„
      dayElement.addEventListener('click', (e) => {
        // æª¢æŸ¥æ˜¯å¦é»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–äº‹ä»¶
        if (e.target.closest('.cancel-btn') || 
            e.target.closest('.takeover-btn') || 
            e.target.closest('.calendar-payment-btn') ||
            e.target.closest('.event-item') ||
            e.target.closest('.payment-status')) {
          return; // ä¸è™•ç†æŒ‰éˆ•å’Œäº‹ä»¶çš„é»æ“Š
        }
        
        // å¿«é€Ÿé ç´„åŠŸèƒ½
        quickBooking(dateStr, currentFilter);
      });
    }
    
    calendarGrid.appendChild(dayElement);
  }
}

// å¿«é€Ÿé ç´„åŠŸèƒ½
function quickBooking(dateStr, location) {
  console.log('å¿«é€Ÿé ç´„:', dateStr, location);
  
  // è‡ªå‹•å¡«å…¥å ´åœ°
  const locationSelect = document.getElementById('location');
  locationSelect.value = location;
  locationSelect.dispatchEvent(new Event('change'));
  
  // ç­‰å¾…å ´åœ°é¸æ“‡å™¨æ›´æ–°å¾Œï¼Œå†è¨­å®šæ—¥æœŸ
  setTimeout(() => {
    const dateSelect = document.getElementById('availableDates');
    
    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨é¸é …ä¸­
    const dateOption = Array.from(dateSelect.options).find(opt => opt.value === dateStr);
    
    if (dateOption) {
      dateSelect.value = dateStr;
      
      // æ»¾å‹•åˆ°è¡¨å–®
      const formElement = document.getElementById('form');
      formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // é«˜äº®è¡¨å–®ä¸¦æç¤º
      formElement.style.transition = 'all 0.3s ease';
      formElement.style.boxShadow = '0 0 0 3px rgba(255, 139, 0, 0.3)';
      
      setTimeout(() => {
        formElement.style.boxShadow = '';
      }, 2000);
      
      showToast('success', 'å·²é¸æ“‡æª”æœŸ', `ğŸ“ ${location}\nğŸ“… ${dateStr}\nğŸ‘‰ è«‹å¡«å¯«é¤è»Šè³‡è¨Šå¾Œé€å‡º`);
      
      // èšç„¦åˆ°é¤è»Šåç¨±è¼¸å…¥æ¡†
      setTimeout(() => {
        document.getElementById('vendorName').focus();
      }, 500);
    } else {
      showToast('warning', 'æ—¥æœŸä¸å¯ç”¨', 'è©²æ—¥æœŸå¯èƒ½å·²è¢«é ç´„æˆ–ä¸åœ¨å¯é¸ç¯„åœå…§ï¼Œè«‹é‡æ–°é¸æ“‡');
    }
  }, 300);
}

// è¨­å®šè¡Œäº‹æ›†äº‹ä»¶
function setupCalendarEvents() {
  // æœˆä»½å°èˆª
  document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });
  
  document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });
  
  document.getElementById('todayBtn').addEventListener('click', () => {
    currentDate = new Date();
    renderCalendar();
  });
  
  // å ´åœ°ç¯©é¸æŒ‰éˆ•
  document.querySelectorAll('.location-filter .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeé¡åˆ¥
      document.querySelectorAll('.location-filter .filter-btn').forEach(b => b.classList.remove('active'));
      // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ activeé¡åˆ¥
      btn.classList.add('active');
      // æ›´æ–°ç¯©é¸æ¢ä»¶
      currentFilter = btn.dataset.location;
      
      // åŒæ­¥æ›´æ–°å ±åè¡¨çš„å ´åœ°é¸æ“‡
      const formLocationSelect = document.getElementById('location');
      if (formLocationSelect) {
        formLocationSelect.value = currentFilter;
        // è§¸ç™¼changeäº‹ä»¶ä¾†æ›´æ–°æ—¥æœŸé¸é …
        formLocationSelect.dispatchEvent(new Event('change'));
      }
      
      renderCalendar();
    });
  });
}


// Toast æç¤ºåŠŸèƒ½
function showToast(type, title, message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: 'fas fa-check-circle',
    error: 'fas fa-exclamation-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle'
  };
  
  toast.innerHTML = `
    <div class="toast-header">
      <i class="toast-icon ${icons[type]}"></i>
      <span class="toast-title">${title}</span>
    </div>
    <div class="toast-message">${message}</div>
  `;
  
  container.appendChild(toast);
  
  // é¡¯ç¤ºå‹•ç•«
  setTimeout(() => toast.classList.add('show'), 100);
  
  // è‡ªå‹•éš±è—
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => container.removeChild(toast), 300);
  }, 4000);
}

// è¼‰å…¥ç‹€æ…‹æ§åˆ¶ï¼ˆæ”¯æ´HTMLæ ¼å¼ï¼‰
function showLoading(message = 'è™•ç†ä¸­...') {
  const overlay = document.getElementById('loadingOverlay');
  const messageEl = document.getElementById('loadingMessage');
  
  // æª¢æŸ¥æ˜¯å¦åŒ…å«HTMLæ¨™ç±¤
  if (message.includes('<div') || message.includes('<span')) {
    messageEl.innerHTML = message;
  } else {
    messageEl.textContent = message;
  }
  
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// é˜²æ­¢é‡è¤‡æäº¤çš„æ¨™è¨˜
let isSubmitting = false;

// è¡¨å–®æäº¤
document.getElementById('submitBtn').addEventListener('click', async () => {
  console.log('è¡¨å–®æäº¤æŒ‰éˆ•è¢«é»æ“Š');
  
  // é˜²æ­¢é‡è¤‡æäº¤
  if (isSubmitting) {
    showToast('warning', 'è«‹ç¨å€™', 'æ­£åœ¨è™•ç†æ‚¨çš„é ç´„ï¼Œè«‹å‹¿é‡è¤‡æäº¤');
    return;
  }
  
  const vendor = document.getElementById('vendorName').value.trim();
  const loc = document.getElementById('location').value;
  const date = document.getElementById('availableDates').value;
  const foodType = document.getElementById('foodType').value;
  
  console.log('è¡¨å–®æ•¸æ“š:', { vendor, loc, date, foodType });
  
  // é©—è­‰è¡¨å–®
  if (!vendor || !loc || !date || !foodType) {
    showToast('error', 'è¡¨å–®éŒ¯èª¤', 'è«‹å®Œæ•´å¡«å¯«å¿…è¦æ¬„ä½');
    return;
  }
  
  // è¨­ç½®æäº¤ä¸­ç‹€æ…‹
  isSubmitting = true;
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  showLoading('ğŸ” æª¢æŸ¥æª”æœŸå¯ç”¨æ€§...');
  
  // ç¦ç”¨æäº¤æŒ‰éˆ•
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
  submitBtn.disabled = true;
  
  // å¤šç”¨æˆ¶ç’°å¢ƒä¸‹çš„é ç´„é–å®šæ©Ÿåˆ¶
  const bookingKey = `${loc}_${date}_14:00-20:00`;
  const lockKey = `booking_lock_${bookingKey}`;
  
  // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è™•ç†ä¸­
  if (sessionStorage.getItem(lockKey)) {
    hideLoading();
    showToast('error', 'è™•ç†ä¸­', 'è©²æ™‚æ®µæ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
    isSubmitting = false;
    return;
  }
  
  // è¨­ç½®è™•ç†é–å®š
  sessionStorage.setItem(lockKey, 'true');
  
  try {
    // æª¢æŸ¥é ç´„è¡çª
    const hasConflict = await checkBookingConflict(loc, date, '14:00-20:00');
    
    if (hasConflict) {
      hideLoading();
      showToast('error', 'é ç´„è¡çª', 'è©²æ™‚æ®µå·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸæˆ–é‡æ–°æ•´ç†é é¢æŸ¥çœ‹æœ€æ–°ç‹€æ…‹');
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      isSubmitting = false;
      return;
    }
  } catch (error) {
    console.error('æª¢æŸ¥é ç´„è¡çªå¤±æ•—:', error);
  } finally {
    // æ¸…é™¤è™•ç†é–å®š
    sessionStorage.removeItem(lockKey);
  }
  
  // æª¢æŸ¥æ—¥æ›†ä¸Šæ˜¯å¦å·²æœ‰é¤è»Šåç¨±ï¼ˆæœ¬åœ°æª¢æŸ¥ï¼‰
  const hasEvent = allEvents.some(event => {
    let eventDate;
    if (event.start instanceof Date) {
      eventDate = `${event.start.getFullYear()}-${String(event.start.getMonth() + 1).padStart(2, '0')}-${String(event.start.getDate()).padStart(2, '0')}`;
    } else {
      eventDate = event.start.split('T')[0];
    }
    return eventDate === date && event.location === loc;
  });
  
  if (hasEvent) {
    hideLoading();
    showToast('error', 'æ—¥æœŸè¡çª', 'è©²æ—¥æœŸå·²æœ‰é¤è»Šæ’ç­ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
    isSubmitting = false;
    return;
  }
  
  // æ›´æ–°è¼‰å…¥è¨Šæ¯
  showLoading('ğŸ“ æ­£åœ¨ç‚ºæ‚¨å ±å...');
  
  // æº–å‚™æäº¤æ•¸æ“š
  const formData = {
    vendor,
    foodType,
    location: loc,
    date,
    timeSlot: '14:00-20:00',
    fee: '600',
    timestamp: formatTimestamp()
  };
  
  // åªæäº¤åˆ°Google Sheetsï¼ˆGitHubå·²ç¦ç”¨ï¼‰
  submitToGoogleSheets(formData)
    .then((result) => {
      console.log('Google Sheetsæäº¤çµæœ:', result);
      
      // éš±è—è¼‰å…¥ç‹€æ…‹
      hideLoading();
      
      // æª¢æŸ¥Google Sheetsæäº¤çµæœ
      if (result.success) {
        console.log('Google Sheetsæäº¤æˆåŠŸ:', result);
        
        // é¡¯ç¤ºæˆåŠŸæç¤º
        showToast('success', 'å ±åæˆåŠŸï¼', `ğŸ‰ ${vendor} å·²æˆåŠŸé ç´„\nğŸ“ å ´åœ°ï¼š${loc}\nğŸ“… æ—¥æœŸï¼š${date}\nğŸ’° å ´åœ°è²»ï¼š600å…ƒ`);
        
        // Google Sheetsæäº¤æˆåŠŸå¾Œï¼Œç­‰å¾…ä¸¦å¤šæ¬¡åŒæ­¥æ•¸æ“š
        setTimeout(async () => {
          try {
            console.log('â±ï¸ ç­‰å¾…2ç§’è®“ Google Sheets å®Œæˆæ–°å¢...');
          } catch (error) {}
        }, 2000);
        
        setTimeout(async () => {
          try {
            console.log('å ±åå¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ3ç§’å¾Œï¼‰...');
            await fetchBookingsFromGoogleSheets();
            await fetchBookedDatesFromSheets();
            mergeSheetsDataToCalendar();
            renderCalendar();
            console.log('å ±åå¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ');
          } catch (error) {
            console.error('å ±åå¾Œç¬¬1æ¬¡åŒæ­¥å¤±æ•—:', error);
          }
        }, 3000);
        
        setTimeout(async () => {
          try {
            console.log('å ±åå¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ5ç§’å¾Œï¼‰...');
            await fetchBookingsFromGoogleSheets();
            await fetchBookedDatesFromSheets();
            mergeSheetsDataToCalendar();
            renderCalendar();
            console.log('å ±åå¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ - æ—¥æ›†æ‡‰è©²å·²æ›´æ–°');
          } catch (error) {
            console.error('å ±åå¾Œç¬¬2æ¬¡åŒæ­¥å¤±æ•—:', error);
          }
        }, 5000);
      } else {
        // Google Sheetsæäº¤å¤±æ•—
        hideLoading();
        showToast('error', 'å ±åå¤±æ•—', 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦');
        
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        isSubmitting = false;
        return;
      }
      
      // Google Sheetsæäº¤æˆåŠŸï¼Œç¹¼çºŒè™•ç†
      if (result.success) {
        
        // æ·»åŠ åˆ°äº‹ä»¶åˆ—è¡¨ï¼ˆç›´æ¥å¯«å…¥æ—¥æ›†ï¼‰
        const newEvent = {
          title: vendor,
          start: date,
          location: loc,
          color: '#28a745',
          timestamp: formatTimestamp(),
          foodType: foodType,
          fee: '600',
          payment: 'å°šæœªä»˜æ¬¾', // åˆå§‹ä»˜æ¬¾ç‹€æ…‹
          source: 'user_booking' // æ¨™è¨˜ç‚ºç”¨æˆ¶é ç´„
        };
        
        allEvents.push(newEvent);
        
        // ç«‹å³é‡æ–°æ¸²æŸ“æ—¥æ›†ï¼Œé¡¯ç¤ºæ–°é ç´„
        renderCalendar();
        
        // ä¸å†æ‰‹å‹•æ›´æ–° bookedSlotsï¼Œç­‰å¾… Google Sheets åŒæ­¥å¾Œè‡ªå‹•é‡å»º
        // bookedSlots æœƒåœ¨ mergeSheetsDataToCalendar ä¸­å¾ Sheets é‡å»º
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆåªä¿å­˜ allEventsï¼‰
        saveToLocalStorage();
        
        // é‡ç½®è¡¨å–®
        document.getElementById('vendorName').value = '';
        document.getElementById('location').value = currentLocation;
        document.getElementById('availableDates').value = '';
        document.getElementById('foodType').value = '';
        
        // é‡æ–°ç”Ÿæˆå¯ç”¨æ—¥æœŸé¸é …
        const availableDates = generateAvailableDates(loc);
        const dateSelect = document.getElementById('availableDates');
        dateSelect.innerHTML = '<option value="">é¸æ“‡å¯ç”¨æ—¥æœŸ</option>';
        availableDates.forEach(date => {
          const opt = document.createElement('option');
          opt.value = date.value;
          opt.textContent = date.text;
          dateSelect.appendChild(opt);
        });
        
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        isSubmitting = false;
        
        // é¡¯ç¤ºç¹³è²»å½ˆçª—
        showPaymentModal();
        
        // GitHubåŒæ­¥å·²ç¦ç”¨ï¼Œä¾è³´Google Sheetsè‡ªå‹•åŒæ­¥
        console.log('å ±åæˆåŠŸï¼ŒGoogle Sheetså°‡è‡ªå‹•åŒæ­¥');
      }
    })
    .catch((error) => {
      // Google Sheetsæäº¤å¤±æ•—
      console.error('æäº¤å¤±æ•—:', error);
      hideLoading();
      showToast('error', 'å ±åå¤±æ•—', 'âŒ ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦');
      
      // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      isSubmitting = false;
    });
});

// ç¹³è²»å½ˆçª—ç›¸é—œå‡½æ•¸
function showPaymentModal() {
  const modal = document.getElementById('paymentModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
}

function closePaymentModal() {
  const modal = document.getElementById('paymentModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto'; // æ¢å¾©æ»¾å‹•
}

function showBankModal() {
  const modal = document.getElementById('bankModal');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeBankModal() {
  const modal = document.getElementById('bankModal');
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

// ä»˜æ¬¾æ–¹å¼æŒ‰éˆ•å‡½æ•¸
function openJkopay() {
  // è¡—å£æ”¯ä»˜é€£çµ
  window.open('https://www.jkos.com/contact-person?j=ContactPerson:901644985', '_blank');
  showToast('info', 'è¡—å£æ”¯ä»˜', 'å·²é–‹å•Ÿè¡—å£æ”¯ä»˜é é¢ï¼Œè«‹å®Œæˆä»˜æ¬¾å¾Œå°‡æˆªåœ–å‚³è‡³å®˜æ–¹å°å¹«æ‰‹');
}

function openLinepay() {
  // LINE-PAYé€£çµ
  window.open('https://line.me/ti/p/natrAYmeWy', '_blank');
  showToast('info', 'LINE-PAY', 'å·²é–‹å•ŸLINE-PAYé é¢ï¼Œè«‹å®Œæˆä»˜æ¬¾å¾Œå°‡æˆªåœ–å‚³è‡³å®˜æ–¹å°å¹«æ‰‹');
}

function openBankModal() {
  closePaymentModal();
  showBankModal();
}

function openOfficialAccount() {
  // å®˜æ–¹å°å¹«æ‰‹é€£çµ
  window.open('https://lin.ee/BStZlfM', '_blank');
  showToast('info', 'å®˜æ–¹å°å¹«æ‰‹', 'å·²é–‹å•Ÿå®˜æ–¹å°å¹«æ‰‹ï¼Œè«‹å°‡ä»˜æ¬¾æˆªåœ–æˆ–è¨Šæ¯å‚³é€çµ¦æˆ‘å€‘');
}

// è¤‡è£½å¸³è™ŸåŠŸèƒ½
function copyAccountNumber() {
  const accountNumber = document.getElementById('accountNumber').textContent;
  
  // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(accountNumber).then(() => {
      showToast('success', 'è¤‡è£½æˆåŠŸ', 'éŠ€è¡Œå¸³è™Ÿå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }).catch(() => {
      fallbackCopyTextToClipboard(accountNumber);
    });
  } else {
    fallbackCopyTextToClipboard(accountNumber);
  }
}

// å‚™ç”¨è¤‡è£½æ–¹æ³•
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showToast('success', 'è¤‡è£½æˆåŠŸ', 'éŠ€è¡Œå¸³è™Ÿå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    } else {
      showToast('error', 'è¤‡è£½å¤±æ•—', 'è«‹æ‰‹å‹•è¤‡è£½å¸³è™Ÿï¼š' + text);
    }
  } catch (err) {
    showToast('error', 'è¤‡è£½å¤±æ•—', 'è«‹æ‰‹å‹•è¤‡è£½å¸³è™Ÿï¼š' + text);
  }
  
  document.body.removeChild(textArea);
}


// è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
document.getElementById('date').min = new Date().toISOString().split('T')[0];

// ç³»çµ±ç‰ˆæœ¬è™Ÿ
const SYSTEM_VERSION = '3.2.1';

// æª¢æ¸¬LINEç€è¦½å™¨ä¸¦æ·»åŠ ç‰¹æ®Šé¡å
function detectLineApp() {
  const ua = navigator.userAgent.toLowerCase();
  const isLine = ua.indexOf('line') > -1;
  const isWebView = /(iphone|ipod|ipad).*applewebkit(?!.*safari)|android.*applewebkit/i.test(ua);
  
  console.log('========================================');
  console.log('ğŸšš æ¥Šæ¢…é¤è»Šæ’ç­ç³»çµ± v' + SYSTEM_VERSION);
  console.log('========================================');
  console.log('ç€è¦½å™¨è³‡è¨Š:', ua);
  console.log('æ˜¯å¦ç‚ºLINE:', isLine);
  console.log('æ˜¯å¦ç‚ºWebView:', isWebView);
  
  if (isLine || isWebView) {
    document.body.classList.add('line-browser');
    console.log('âœ… å·²å•Ÿç”¨ LINE/WebView å…¼å®¹æ¨¡å¼');
    console.log('- é¤è»Šåç¨±ï¼šæ°´å¹³é¡¯ç¤ºï¼ˆè‡ªå‹•æ›è¡Œï¼‰');
    console.log('- å­—é«”å¤§å°ï¼šå›ºå®šå€¼ï¼ˆä¸ä½¿ç”¨å‹•æ…‹ç¸®æ”¾ï¼‰');
    
    // æ›´æ–°é é¢åº•éƒ¨é¡¯ç¤º
    setTimeout(() => {
      const modeDisplay = document.getElementById('browserMode');
      if (modeDisplay) {
        modeDisplay.innerHTML = '<span style="color: #ffc107;">LINEå…¼å®¹æ¨¡å¼</span>';
      }
    }, 100);
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆç¾åŒ–è¨Šæ¯ï¼‰
    setTimeout(() => {
      showToast('info', 'æ­¡è¿å…‰è‡¨', 'ğŸ¨ å·²å„ªåŒ–é¡¯ç¤ºæ¨¡å¼ï¼Œç‚ºæ‚¨å‘ˆç¾æœ€ä½³é«”é©—');
    }, 1000);
  } else {
    console.log('âœ… æ¨™æº–æ¨¡å¼');
    console.log('- é¤è»Šåç¨±ï¼šå‚ç›´é¡¯ç¤º');
    console.log('- å­—é«”å¤§å°ï¼šè‡ªå‹•ç¸®æ”¾');
    
    // æ›´æ–°é é¢åº•éƒ¨é¡¯ç¤º
    setTimeout(() => {
      const modeDisplay = document.getElementById('browserMode');
      if (modeDisplay) {
        modeDisplay.innerHTML = '<span style="color: #2ecc71;">æ¨™æº–æ¨¡å¼</span>';
      }
    }, 100);
  }
  console.log('========================================');
  
  return isLine || isWebView;
}

// æª¢æŸ¥æ˜¯å¦éœ€è¦å¼·åˆ¶åˆ·æ–°ç·©å­˜
function checkVersionAndRefresh() {
  const storedVersion = localStorage.getItem('system_version');
  
  if (storedVersion !== SYSTEM_VERSION) {
    console.log('ğŸ”„ æª¢æ¸¬åˆ°æ–°ç‰ˆæœ¬ï¼Œæ¸…é™¤æ‰€æœ‰èˆŠç·©å­˜...');
    console.log('èˆŠç‰ˆæœ¬:', storedVersion || 'æœªçŸ¥');
    console.log('æ–°ç‰ˆæœ¬:', SYSTEM_VERSION);
    
    // æ¸…é™¤æ‰€æœ‰èˆŠçš„é ç´„æ•¸æ“šï¼ˆåªä¿ç•™Google Sheetsæ•¸æ“šï¼‰
    console.log('æ¸…é™¤æœ¬åœ°é ç´„æ•¸æ“š...');
    localStorage.removeItem('foodtruck_bookings');
    localStorage.removeItem('foodtruck_bookedSlots');
    
    // æ¸…ç©ºå…§å­˜ä¸­çš„äº‹ä»¶
    allEvents.length = 0;
    Object.keys(bookedSlots).forEach(location => {
      bookedSlots[location] = {};
    });
    
    // å„²å­˜æ–°ç‰ˆæœ¬è™Ÿ
    localStorage.setItem('system_version', SYSTEM_VERSION);
    
    // é¡¯ç¤ºæ›´æ–°æç¤º
    setTimeout(() => {
      showToast('success', 'ç³»çµ±å·²æ›´æ–°', `âœ¨ å·²æ›´æ–°è‡³ v${SYSTEM_VERSION}\nğŸ”„ å·²æ¸…é™¤èˆŠè³‡æ–™ï¼Œé‡æ–°æ•´ç†æ’ç­`);
    }, 500);
    
    return true; // è¡¨ç¤ºå·²æ¸…é™¤æ•¸æ“š
  }
  
  return false; // æ²’æœ‰æ¸…é™¤æ•¸æ“š
}

// å¼·åˆ¶åªé¡¯ç¤ºGoogle Sheetsçš„æ•¸æ“š
function syncOnlySheetsData() {
  console.log('========================================');
  console.log('ğŸ“Š å¼·åˆ¶åªé¡¯ç¤º Google Sheets æ•¸æ“š');
  console.log('========================================');
  
  // æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•¸æ“š
  allEvents.length = 0;
  Object.keys(bookedSlots).forEach(location => {
    bookedSlots[location] = {};
  });
  
  console.log('âœ… å·²æ¸…ç©ºæœ¬åœ°æ•¸æ“š');
  console.log('â³ ç­‰å¾…å¾ Google Sheets åŒæ­¥...');
}

// é é¢è¼‰å…¥æ™‚æª¢æ¸¬
detectLineApp();
checkVersionAndRefresh();

// åœ–ç‰‡æ”¾å¤§åŠŸèƒ½
document.addEventListener('DOMContentLoaded', async function() {
  // v2.4.0ï¼šå®Œå…¨ä¾è³´Google Sheetsï¼Œæ¸…é™¤æ‰€æœ‰æœ¬åœ°ç·©å­˜
  console.log('========================================');
  console.log('ğŸ“‹ ç³»çµ±åˆå§‹åŒ–ä¸­... (v2.4.0)');
  console.log('========================================');
  console.log('ğŸš« ä¸ä½¿ç”¨æœ¬åœ°ç·©å­˜æ•¸æ“šï¼ˆå·²åœç”¨localStorageï¼‰');
  console.log('âœ… å®Œå…¨å¾ Google Sheets åŒæ­¥æ•¸æ“š');
  console.log('âœ… æ¯æ¬¡åˆ·æ–°éƒ½é¡¯ç¤º Google Sheets æœ€æ–°è³‡æ–™');
  
  // é¡¯ç¤ºè¼‰å…¥ç•«é¢ï¼ˆå‰åˆ©èªï¼‰
  showLoading(`<div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; color: #FF4B2B; letter-spacing: 2px;">ğŸŠ å¥½é‹é™è‡¨</div><div style="font-size: 0.85rem; color: #999; font-weight: 500;">ç³»çµ±å•Ÿå‹•ä¸­...</div>`);
  
  // å¼·åˆ¶æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•¸æ“š
  allEvents.length = 0;
  Object.keys(bookedSlots).forEach(location => {
    bookedSlots[location] = {};
  });
  
  console.log('âœ… æœ¬åœ°æ•¸æ“šå·²æ¸…ç©º');
  console.log('========================================');
  
  // åˆå§‹åŒ–æ–°è¡Œäº‹æ›†ï¼ˆæ­¤æ™‚ç‚ºç©ºï¼Œä¸é¡¯ç¤ºï¼‰
  initNewCalendar();
  
  // è¨­å®šé è¨­å ´åœ°
  updateLocationInfo(currentLocation);
  document.getElementById('location').value = currentLocation;
  
  // è§¸ç™¼å ´åœ°é¸æ“‡äº‹ä»¶ä»¥åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨
  document.getElementById('location').dispatchEvent(new Event('change'));
  
  // å•Ÿå‹•å®šæœŸåŒæ­¥
  startPeriodicSync();
  
  // å•Ÿå‹•Google Sheetså®šæœŸåŒæ­¥
  startSheetsSyncInterval();
  
  // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºåŒæ­¥ç‹€æ…‹
  showSyncStatus('ç³»çµ±åˆå§‹åŒ–ä¸­...', 'default');
  
  // GitHubåŒæ­¥å·²ç¦ç”¨ï¼Œç³»çµ±å®Œå…¨ä¾è³´Google Sheets
  console.log('ç³»çµ±å®Œå…¨ä¾è³´Google Sheetsï¼ŒGitHubåŒæ­¥å·²ç¦ç”¨');
  
  // if (!hasLocalData) {
  //   await syncWithGitHub();
  // } else {
  //   setTimeout(async () => {
  //     await syncWithGitHub();
  //   }, 1000);
  // }
  
  // åˆæ¬¡è¼‰å…¥æ™‚åŒæ­¥Google Sheetsæ•¸æ“šï¼ˆå¸¶é€²åº¦æç¤ºï¼‰
  if (GOOGLE_SHEETS_CONFIG.enabled) {
    // è¨˜éŒ„é–‹å§‹æ™‚é–“
    const startTime = Date.now();
    
    // æ›´æ–°è¼‰å…¥è¨Šæ¯ï¼ˆå‰åˆ©èªï¼‰
    showLoading('ğŸŠ å¥½é‹é™è‡¨...');
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºï¼ˆå‰åˆ©èªè¼ªæ’­ï¼‰
    let countdown = 0;
    const loadingMessages = [
      'ğŸ§§ è²¡æºæ»¾æ»¾',
      'ğŸ‰ ç”Ÿæ„èˆˆéš†',
      'ğŸ’° å¤§ç™¼åˆ©å¸‚',
      'ğŸŒŸ å¥½é‹é€£é€£',
      'ğŸŠ è³“å®¢æ»¿é–€',
      'ğŸœ å®¢ä¼¼é›²ä¾†',
      'âœ¨ åœ“æ»¿é †åˆ©',
      'ğŸ¯ è²¡é‹äº¨é€š'
    ];
    
    const countdownInterval = setInterval(() => {
      countdown++;
      // æ¯2ç§’æ›ä¸€å€‹å‰åˆ©è©±
      const messageIndex = Math.min(Math.floor(countdown / 2), loadingMessages.length - 1);
      const message = loadingMessages[messageIndex];
      showLoading(`<div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 10px; color: #FF4B2B; letter-spacing: 2px;">${message}</div><div style="font-size: 0.85rem; color: #999; font-weight: 500;">è¼‰å…¥æ’ç­è³‡æ–™ Â· ${countdown} ç§’</div>`);
    }, 1000);
    
    // ç«‹å³é–‹å§‹åŒæ­¥ï¼ˆä¸å»¶é²ï¼‰
    (async () => {
      try {
        const syncStartTime = Date.now();
        console.log('â±ï¸ é–‹å§‹åŒæ­¥ Google Sheets...');
        
        // ç«‹å³åŒæ­¥ï¼Œä¸é¡¯ç¤ºä¸­é–“éç¨‹è¨Šæ¯ï¼ˆå¤ªå¿«çœ‹ä¸åˆ°ï¼‰
        // åŒæ™‚ç²å–å®Œæ•´é ç´„æ•¸æ“šå’Œå·²é ç´„æ—¥æœŸ
        await Promise.all([
          fetchBookingsFromGoogleSheets(),
          fetchBookedDatesFromSheets()
        ]);
        
        mergeSheetsDataToCalendar();
        
        // é‡æ–°ç”Ÿæˆç•¶å‰å ´åœ°çš„å¯ç”¨æ—¥æœŸï¼ˆæ’é™¤å·²é ç´„æ—¥æœŸï¼‰
        const currentLoc = document.getElementById('location').value;
        if (currentLoc) {
          document.getElementById('location').dispatchEvent(new Event('change'));
        }
        
        // è¨ˆç®—å¯¦éš›è¼‰å…¥æ™‚é–“
        const syncEndTime = Date.now();
        const syncDuration = ((syncEndTime - syncStartTime) / 1000).toFixed(1);
        const totalDuration = ((syncEndTime - startTime) / 1000).toFixed(1);
        
        console.log('========================================');
        console.log('âœ… Google Sheets åˆå§‹åŒ–å®Œæˆ');
        console.log(`â±ï¸ åŒæ­¥è€—æ™‚: ${syncDuration} ç§’`);
        console.log(`â±ï¸ ç¸½è€—æ™‚: ${totalDuration} ç§’`);
        console.log(`ğŸ“Š è¼‰å…¥é ç´„æ•¸: ${allEvents.length}`);
        console.log('========================================');
        
        // æ¸…é™¤å€’æ•¸è¨ˆæ™‚
        clearInterval(countdownInterval);
        
        // å»¶é²ä¸€ä¸‹å†éš±è—è¼‰å…¥ç•«é¢ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ã€Œå®Œæˆã€ç‹€æ…‹
        const totalBookings = allEvents.length;
        const successMessage = totalBookings > 0 
          ? `<div style="font-size: 1.35rem; font-weight: 700; margin-bottom: 10px; color: #28a745; letter-spacing: 2px;">ğŸ‰ è¬äº‹å¦‚æ„</div><div style="font-size: 0.9rem; color: #666; font-weight: 500;">å·²è¼‰å…¥ ${totalBookings} å€‹æ’ç­ Â· æº–å‚™å°±ç·’</div>`
          : `<div style="font-size: 1.35rem; font-weight: 700; margin-bottom: 10px; color: #28a745; letter-spacing: 2px;">ğŸŠ ä¸€åˆ‡é †åˆ©</div><div style="font-size: 0.9rem; color: #666; font-weight: 500;">ç›®å‰ç„¡æ’ç­è³‡æ–™ Â· æº–å‚™å°±ç·’</div>`;
        
        showLoading(successMessage);
        setTimeout(() => {
          hideLoading();
          // é¡¯ç¤ºä¸»è¦å…§å®¹ï¼ˆæ·¡å…¥æ•ˆæœï¼‰
          const mainContent = document.getElementById('mainContent');
          if (mainContent) {
            mainContent.style.opacity = '1';
          }
        }, 600);
        
      } catch (error) {
        console.error('åˆæ¬¡åŒæ­¥Google Sheetså¤±æ•—:', error);
        clearInterval(countdownInterval);
        showLoading(`<div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; color: #ffc107; letter-spacing: 2px;">ğŸ™ ç¨å®‰å‹¿èº</div><div style="font-size: 0.85rem; color: #dc3545; font-weight: 500;">ç¶²è·¯ä¸ç©© Â· è«‹ç¨å¾Œå†è©¦</div>`);
        setTimeout(() => {
          hideLoading();
          // å³ä½¿å¤±æ•—ä¹Ÿè¦é¡¯ç¤ºä¸»è¦å…§å®¹
          const mainContent = document.getElementById('mainContent');
          if (mainContent) {
            mainContent.style.opacity = '1';
          }
          showToast('warning', 'è«‹ç¨å€™', 'ğŸ™ ç¶²è·¯é€£ç·šä¸ç©©ï¼Œå»ºè­°ç¨å¾Œé‡æ–°æ•´ç†');
        }, 1200);
      }
    })(); // ç«‹å³åŸ·è¡ŒåŒæ­¥ï¼Œä¸å»¶é²
  } else {
    // å¦‚æœæœªå•Ÿç”¨Google Sheetsï¼Œç›´æ¥éš±è—è¼‰å…¥ç•«é¢ä¸¦é¡¯ç¤ºå…§å®¹
    hideLoading();
    const mainContent = document.getElementById('mainContent');
    if (mainContent) {
      mainContent.style.opacity = '1';
    }
  }
  
  // åœ–ç‰‡é»æ“Šæ”¾å¤§åŠŸèƒ½
  document.querySelectorAll('.location-thumbnail').forEach(thumbnail => {
    thumbnail.addEventListener('click', function(e) {
      e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å ´åœ°åˆ‡æ›
      const fullImageSrc = this.getAttribute('data-full-image');
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      modalImage.src = fullImageSrc;
      modalImage.alt = this.alt;
      modal.classList.add('active');
    });
  });
  
  // é—œé–‰æ¨¡æ…‹æ¡†
  document.querySelector('.modal-close').addEventListener('click', function() {
    document.getElementById('imageModal').classList.remove('active');
  });
  
  // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
  document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.remove('active');
    }
  });
  
  // ESCéµé—œé–‰æ¨¡æ…‹æ¡†
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('imageModal').classList.remove('active');
      document.getElementById('paymentModal').classList.remove('active');
      document.getElementById('bankModal').classList.remove('active');
      document.getElementById('cancelModal').classList.remove('active');
      document.getElementById('passwordModal').classList.remove('active');
      document.getElementById('transferModal').classList.remove('active');
      document.getElementById('takeoverModal').classList.remove('active');
      document.getElementById('helpModal').classList.remove('active');
      document.getElementById('rulesModal').classList.remove('active');
      document.getElementById('downloadModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰ç¹³è²»å½ˆçª—
  document.getElementById('paymentModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closePaymentModal();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰éŠ€è¡Œè½‰å¸³å½ˆçª—
  document.getElementById('bankModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeBankModal();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰å–æ¶ˆé ç´„å½ˆçª—
  document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeCancelModal();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰å¯†ç¢¼è¼¸å…¥å½ˆçª—
  document.getElementById('passwordModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closePasswordModal();
    }
  });
  
  // å¯†ç¢¼è¼¸å…¥æ¡†Enteréµæ”¯æ´
  document.getElementById('passwordInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      verifyPassword();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰æ’ç­é‡‹å‡ºå½ˆçª—
  document.getElementById('transferModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeTransferModal();
    }
  });
  
  // é‡‹å‡ºå½ˆçª—å¯†ç¢¼è¼¸å…¥æ¡†Enteréµæ”¯æ´
  document.getElementById('transferPassword').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      submitTransfer();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰ä½¿ç”¨æ•™å­¸å½ˆçª—
  document.getElementById('helpModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeHelpModal();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰ç¾¤çµ„ç‰ˆè¦å½ˆçª—
  document.getElementById('rulesModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeRulesModal();
    }
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰ä¸‹è¼‰ç´ æå½ˆçª—
  document.getElementById('downloadModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDownloadModal();
    }
  });
});
</script>

<!-- Toast å®¹å™¨ -->
<div class="toast-container" id="toastContainer"></div>

<!-- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p id="loadingMessage">è™•ç†ä¸­...</p>
  </div>
</div>

<!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div id="syncStatus" class="sync-status">
  <i class="fas fa-sync-alt"></i>
  <span>åŒæ­¥ä¸­...</span>
</div>

<!-- ç¾¤çµ„ç‰ˆè¦å½ˆçª— -->
<div id="rulesModal" class="password-modal">
  <div class="password-modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
    <div class="password-header" style="background: linear-gradient(135deg, #ffc107, #ff9800); padding: 20px;">
      <h3 style="font-size: 1.3rem;"><i class="fas fa-book"></i> å››ç¶­å•†åœˆç¾é£Ÿé¤è»Šç¾¤çµ„ç‰ˆè¦</h3>
      <span class="modal-close" onclick="closeRulesModal()">&times;</span>
    </div>
    <div class="password-body" style="padding: 20px;">
      
      <div class="rule-section" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <h4 style="color: #ff9800; margin-bottom: 10px;"><i class="fas fa-star"></i> æ­¡è¿æ–°å¤¥ä¼´åŠ å…¥</h4>
        <p style="line-height: 1.8; color: #666;">é€²ç¾¤å‰å¾Œï¼Œè«‹å°‡LINEåç¨±æ”¹ç‚ºã€å“ç‰Œåç¨±ã€‘ï¼›å¦‚æœ‰å…©äººä»¥ä¸Šï¼Œå¦ä¸€ä½è«‹ç”¨ã€å“ç‰Œåç¨±-å°å¹«æ‰‹ã€‘æˆ–ã€å“ç‰Œåç¨±-2ã€‘ã€‚</p>
        <p style="line-height: 1.8; color: #666;">åç¨±æ›´æ”¹å¾Œï¼Œè«‹å°‡ã€å“ç‰Œç°¡ä»‹ã€é¤è»Šå“é …ã€èœå–®åƒ¹æ ¼ã€‘è²¼è‡³è¨˜äº‹æœ¬ï¼Œæ–¹ä¾¿å¤§å®¶èªè­˜å½¼æ­¤ã€‚</p>
      </div>

      <div class="rule-section" style="margin-bottom: 15px;">
        <h4 style="color: #FF4B2B; margin-bottom: 8px;"><i class="fas fa-clipboard-check"></i> 1. ç‡Ÿæ¥­å…¬å‘Šèˆ‡é è¨‚è¦ç¯„</h4>
        <ul style="line-height: 1.8; color: #666; padding-left: 20px;">
          <li>ç‡Ÿæ¥­æ—¥å‰2å¤©ï¼Œè«‹æ–¼è¨‚è³¼ç¾¤è¨˜äº‹æœ¬å¼µè²¼é è¨‚å…¬å‘Šã€‚</li>
          <li>æ¨æ’­åƒ…é™ç‡Ÿæ¥­å‰ä¸€æ—¥19:00å¾Œã€‚</li>
          <li>ç¾å ´ä½œæ¥­è«‹ä»¥é è¨‚å–®ç‚ºå„ªå…ˆã€‚</li>
        </ul>
      </div>

      <div class="rule-section" style="margin-bottom: 15px;">
        <h4 style="color: #FF4B2B; margin-bottom: 8px;"><i class="fas fa-dollar-sign"></i> 2. å ´åœ°è²»ç¹³äº¤è¦å®š</h4>
        <ul style="line-height: 1.8; color: #666; padding-left: 20px;">
          <li>ç·šä¸Šæ’ç­å¾Œï¼Œè«‹æ–¼<strong>24å°æ™‚å…§å®Œæˆå ´åœ°è²»ç¹³äº¤</strong>ï¼Œä¸¦æˆªåœ–å‘ŠçŸ¥å°å¹«æ‰‹ã€‚</li>
          <li>æ”¯æ´<strong>è¡—å£æ”¯ä»˜ã€LINE Payã€éŠ€è¡Œè½‰å¸³</strong>ä¸‰ç¨®ä»˜æ¬¾æ–¹å¼ã€‚</li>
          <li>è¶…é24å°æ™‚æœªç¹³ï¼Œè©²å ´æ¬¡è‡ªå‹•ä¸‹æ¶ï¼Œéœ€é‡æ–°å ±ç­ã€‚</li>
          <li>ä»˜æ¬¾å®Œæˆå¾Œç‹€æ…‹å°‡è®Šæ›´ç‚ºã€Œå·²ä»˜æ¬¾ã€ï¼Œæ’ç­ç¢ºå®šã€‚</li>
        </ul>
      </div>

      <div class="rule-section" style="margin-bottom: 15px;">
        <h4 style="color: #FF4B2B; margin-bottom: 8px;"><i class="fas fa-broom"></i> 3. ç’°å¢ƒèˆ‡æ¸…æ½”</h4>
        <ul style="line-height: 1.8; color: #666; padding-left: 20px;">
          <li>è¨­æ”¤åŠç‡Ÿæ¥­æ™‚è«‹ä¿æŒç’°å¢ƒæ•´æ½”ã€‚</li>
          <li>é–‹æ”¤å‰å¾Œè«‹æ‹ç…§ä¸Šå‚³ç¾¤çµ„ã€‚</li>
        </ul>
      </div>

      <div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 8px; margin-top: 20px;">
        <p style="margin: 0; color: #155724; font-weight: bold;">
          <i class="fas fa-phone"></i> å®˜æ–¹å¸³è™Ÿå°å¹«æ‰‹ï¼š
          <a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; text-decoration: underline;">lin.ee/BStZlfM</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ä¸‹è¼‰ç´ æå½ˆçª— -->
<div id="downloadModal" class="password-modal">
  <div class="password-modal-content" style="max-width: 600px;">
    <div class="password-header" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px;">
      <h3 style="font-size: 1.3rem;"><i class="fas fa-download"></i> ä¸‹è¼‰ç´ æ</h3>
      <span class="modal-close" onclick="closeDownloadModal()">&times;</span>
    </div>
    <div class="password-body" style="padding: 20px;">
      <div style="text-align: center;">
        <img src="https://res.cloudinary.com/diiyszovx/image/upload/v1757929018/S__4653076_vzto17.jpg" 
             alt="å››ç¶­å•†åœˆé¤è»ŠQR Codeæµ·å ±" 
             style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 20px;">
        
        <h4 style="color: #667eea; margin-bottom: 10px;"><i class="fas fa-qrcode"></i> å››ç¶­å•†åœˆé¤è»ŠQR Codeæµ·å ±</h4>
        <p style="color: #666; line-height: 1.8; margin-bottom: 15px;">ä¾›é¤è»Šä¸»è‡ªè¡Œä¸‹è¼‰ä½¿ç”¨ï¼Œè¨­æ”¤æ™‚å¼µè²¼æ–¼æ˜é¡¯è™•æ¨å»£</p>
        <p style="color: #999; font-size: 0.9rem; margin-bottom: 20px;">è¦æ ¼ï¼šA4å¤§å°ï¼Œé«˜è§£æåº¦</p>
        
        <a href="https://res.cloudinary.com/diiyszovx/image/upload/v1757929018/S__4653076_vzto17.jpg" 
           download="å››ç¶­å•†åœˆé¤è»ŠQRCodeæµ·å ±.jpg"
           class="btn btn-primary" 
           style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
          <i class="fas fa-download"></i> ä¸‹è¼‰æµ·å ±
        </a>
      </div>
      
      <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="color: #495057; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> ä½¿ç”¨èªªæ˜</h4>
        <ul style="line-height: 1.8; color: #666; padding-left: 20px;">
          <li>è«‹å°‡æµ·å ±åˆ—å°æˆA4å¤§å°</li>
          <li>è¨­æ”¤æ™‚å¼µè²¼æ–¼é¤è»Šæ˜é¡¯è™•</li>
          <li>æ–¹ä¾¿å®¢äººæƒæåŠ å…¥é è¨‚ç¤¾ç¾¤</li>
          <li>å¦‚æœ‰å•é¡Œè«‹è¯çµ¡ç®¡ç†å“¡</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ç‰ˆæ¬Šè­¦èª -->
<footer style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px 15px; text-align: center; margin-top: 30px; border-top: 3px solid #FF8A00;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <p style="margin: 0 0 8px 0; font-size: 0.9rem;">
      ç³»çµ±é–‹ç™¼ï¼š<a href="https://lin.ee/BStZlfM" target="_blank" style="color: #00C300; font-weight: bold; text-decoration: none; transition: all 0.3s;">å¿«é–ƒé¤è»Šå°å¹«æ‰‹</a> Â© 2025
    </p>
    <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #ffc107;">
      <i class="fas fa-exclamation-triangle"></i> æœ¬ç³»çµ±å—è‘—ä½œæ¬Šæ³•ä¿è­·ï¼Œæœªç¶“æˆæ¬Šä¸å¾—è¤‡è£½ã€ä¿®æ”¹æˆ–ç”¨æ–¼å•†æ¥­ç”¨é€”
    </p>
    <p style="margin: 0 0 8px 0; font-size: 0.8rem;">
      <a href="https://foodcarshop.pages.dev/guide" target="_blank" style="color: #17a2b8; font-weight: bold; text-decoration: underline; transition: all 0.3s;">
        <i class="fas fa-shopping-cart"></i> å®¢è£½åŒ–é¤è»Šé è³¼ç³»çµ±(ç¤ºç¯„)
      </a>
    </p>
    <p id="systemVersionDisplay" style="margin: 8px 0 0 0; font-size: 0.75rem; color: #95a5a6; font-family: monospace;">
      <i class="fas fa-code-branch"></i> ç³»çµ±ç‰ˆæœ¬ï¼šv3.2.1 | <span id="browserMode">æª¢æ¸¬ä¸­...</span>
    </p>
  </div>
</footer>

</body>
</html>

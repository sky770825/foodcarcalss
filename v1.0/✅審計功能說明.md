# 審計功能說明文件

## 📋 功能概述

新增**「己繳場租審計」**系統管理功能，讓管理員可以透過密碼驗證，將「尚未付款」的預約更新為「己繳款」狀態。

---

## ✨ 主要功能

### 1. **審計按鈕（日曆上）**
- **位置**：日曆事件的左上角（綠色圓形按鈕）
- **圖標**：✓ 勾選圖標
- **顯示條件**：僅針對「尚未付款」的預約顯示
- **功能**：點擊後打開「己繳場租審計」彈窗

### 2. **己繳場租審計彈窗**
- 顯示預約詳情：
  - 餐車名稱
  - 場地
  - 日期
  - 時間（14:00-20:00）
- 提供兩個操作按鈕：
  - **聯繫官方小幫手**：直接跳轉到LINE官方帳號
  - **密碼確認繳費**：需要輸入密碼才能確認

### 3. **密碼驗證**
- **審計密碼**：`sky36990`
- 驗證成功後：
  - 將 Google Sheets H欄的「尚未付款」更新為「己繳款」
  - 在 I欄備註中添加「審計確認」標記
  - 自動重新載入排班數據
  - 顯示成功提示訊息

---

## 🔧 技術實現

### 前端（HTML + JavaScript）

#### 1. **HTML彈窗**
- `#auditModal`：審計主彈窗
- `#auditPasswordModal`：密碼輸入彈窗

#### 2. **JavaScript函數**
```javascript
// 顯示審計彈窗
function showAuditModal(event, dateStr)

// 關閉審計彈窗
function closeAuditModal()

// 顯示密碼輸入
function showAuditPasswordInput()

// 關閉密碼輸入
function closeAuditPasswordModal()

// 驗證審計密碼並更新狀態
async function verifyAuditPassword()
```

#### 3. **日曆事件修改**
在渲染日曆事件時，如果預約狀態為「尚未付款」，會自動添加審計按鈕：
```javascript
if (event.payment === '尚未付款' || (!event.payment && event.bookedStatus !== '逾繳可排')) {
  const auditBtn = document.createElement('button');
  auditBtn.className = 'audit-btn';
  // ... 按鈕樣式和事件處理
}
```

### 後端（Google Apps Script）

#### 新增函數：`updatePaymentStatus()`
```javascript
function updatePaymentStatus(updateData) {
  // 1. 根據店名、場地、日期查找對應的預約行
  // 2. 更新 H欄（款項結清）為「己繳款」
  // 3. 在 I欄備註添加「審計確認」
  // 4. 自動排序工作表
  // 5. 返回成功訊息
}
```

#### doPost 處理邏輯
```javascript
if (data.action === 'updatePayment') {
  console.log('→ 執行 updatePaymentStatus');
  return updatePaymentStatus(data);
}
```

---

## 🎨 視覺設計

### 審計按鈕樣式
- **大小**：14px × 14px（桌面版）/ 18px × 18px（手機版）
- **顏色**：綠色 `rgba(40, 167, 69, 0.95)`
- **位置**：事件容器左上角
- **Z-index**：15
- **Hover效果**：放大 1.15倍

### 彈窗配色
- **標題背景**：綠色漸變 `linear-gradient(135deg, #28a745, #20c997)`
- **按鈕顏色**：綠色系（與審計主題一致）

---

## 📊 資料流程

```
用戶點擊審計按鈕
    ↓
顯示「己繳場租審計」彈窗
    ↓
用戶點擊「密碼確認繳費」
    ↓
顯示密碼輸入彈窗
    ↓
用戶輸入密碼 (sky36990)
    ↓
JavaScript驗證密碼
    ↓
發送 POST 請求到 Google Apps Script
    ↓
Google Apps Script 更新 Sheets
    - H欄：尚未付款 → 己繳款
    - I欄：添加「審計確認」
    ↓
返回成功訊息
    ↓
前端重新載入數據
    ↓
顯示成功提示
```

---

## 🔒 安全性

1. **密碼保護**：只有知道密碼 `sky36990` 的管理員才能執行審計
2. **不可撤銷**：一旦更新為「己繳款」，前端無法直接改回
3. **記錄追蹤**：在備註欄添加「審計確認」標記
4. **權限控制**：Google Apps Script 有獨立的存取控制

---

## 📱 響應式設計

### 桌面版
- 審計按鈕：14px × 14px
- 彈窗寬度：420px（密碼彈窗）
- 字體大小：正常

### 手機版（≤768px）
- 審計按鈕：18px × 18px
- 彈窗寬度：92%
- 字體大小：自適應 (clamp)

---

## 🧪 測試清單

- [ ] 審計按鈕只顯示在「尚未付款」的預約上
- [ ] 點擊審計按鈕打開正確的彈窗
- [ ] 密碼驗證功能正常（正確/錯誤密碼）
- [ ] Google Sheets 更新成功
- [ ] 更新後日曆自動重新載入
- [ ] 手機版顯示正常
- [ ] 不干擾其他按鈕（取消、接手等）

---

## 📝 使用注意事項

1. **僅限管理員使用**：此功能為系統管理專用
2. **確認後再操作**：更新為「己繳款」後無法從前端還原
3. **密碼保密**：請勿洩漏審計密碼給非管理員
4. **雙重確認**：建議在使用前確認預約資訊無誤

---

## 🔄 更新日誌

### v3.2.1 (2025-10-14)
- ✅ 新增「己繳場租審計」功能
- ✅ 新增審計按鈕（綠色圓形，顯示在日曆事件左上角）
- ✅ 新增審計彈窗和密碼驗證
- ✅ 新增 Google Apps Script `updatePaymentStatus()` 函數
- ✅ 支援移動設備響應式設計

---

## 👨‍💻 開發者資訊

- **功能開發日期**：2025-10-14
- **密碼**：sky36990
- **API端點**：Google Apps Script Web App
- **動作類型**：`action: 'updatePayment'`

---

## 📞 技術支援

如有任何問題或需要協助，請聯繫：
- **官方小幫手**：https://lin.ee/BStZlfM


# 🔧 審計功能診斷步驟

## 🎯 問題現象

用戶報告：
1. ❌ 沒有覆蓋原本的記錄
2. ❌ "尚未付款" 沒有改成 "己繳款"
3. ❌ 還多複製了一行出來

## 🔍 診斷步驟

### 步驟 1：檢查 Console 日誌

打開瀏覽器 Console（F12），執行審計操作，查看：

```
應該顯示：
1. "發送審計更新請求:" {...}
2. "審計更新回應:" {...}

查看：
- updateData 是否包含 rowNumber?
- result.success 是 true 還是 false?
- result.message 是什麼?
```

### 步驟 2：檢查發送的數據

在 Console 中輸入：

```javascript
// 查看最後一次審計請求的數據
// 應該在日誌中看到：
發送審計更新請求: {
  action: "updatePayment",
  vendor: "店名",
  location: "四維路59號",
  date: "2025-10-14",
  rowNumber: 8,  // ← 這個很重要！
  payment: "己繳款"
}
```

### 步驟 3：檢查 Google Apps Script

在 Google Apps Script 的執行記錄中查看：

```
1. 是否收到 updatePayment action?
2. 是否找到對應的行號?
3. 是否成功更新?
```

## 🐛 可能的問題

### 問題 1：rowNumber 是 undefined

**症狀：**
- Console 顯示 `rowNumber: undefined`
- Google Sheets 新增了一行而不是更新

**原因：**
- 事件對象沒有 rowNumber 屬性
- Google Sheets 搜尋不到匹配的記錄

**解決：**
```javascript
// 檢查 event 對象
console.log('當前事件對象:', window.currentAuditEvent);
console.log('rowNumber:', window.currentAuditEvent.rowNumber);

// 如果是 undefined，需要檢查 mergeSheetsDataToCalendar
```

### 問題 2：日期格式不匹配

**症狀：**
- Google Apps Script 找不到匹配的記錄
- 新增了一行

**原因：**
- 前端發送：`"2025-10-14"`
- Google Sheets 儲存：`"10月14日(星期二)"`
- 格式不匹配

**解決：**
- Google Apps Script 需要轉換日期格式
- 已在 updatePaymentStatus 函數中處理（第 1705 行）

### 問題 3：submitToGoogleSheets 處理錯誤

**症狀：**
- 請求被當作新增預約
- 沒有執行更新邏輯

**原因：**
- submitToGoogleSheets 沒有正確識別 action
- 走了新增預約的流程

**檢查：**
```javascript
// 在 submitToGoogleSheets 函數中
console.log('action:', formData.action); // 應該是 "updatePayment"
```

## ✅ 快速測試

### 測試 1：檢查事件對象

在預約上點右鍵 → 檢查元素，在 Console 輸入：

```javascript
// 點擊一個預約後，查看
console.log('allEvents:', allEvents);

// 找一個事件
const testEvent = allEvents[0];
console.log('測試事件:', testEvent);
console.log('- title:', testEvent.title);
console.log('- location:', testEvent.location);
console.log('- rowNumber:', testEvent.rowNumber); // ← 重要！
console.log('- payment:', testEvent.payment);
```

### 測試 2：手動觸發更新

```javascript
// 手動構造更新請求
const testUpdate = {
  action: 'updatePayment',
  vendor: '測試餐車',  // 改成實際的店名
  location: '四維路59號',
  date: '2025-10-14',
  rowNumber: 8,  // 改成實際的行號
  payment: '己繳款'
};

// 發送請求
submitToGoogleSheets(testUpdate).then(result => {
  console.log('測試結果:', result);
});
```

### 測試 3：檢查 Google Sheets

直接在 Google Sheets 中：

1. 找到要更新的那一行
2. 記下行號（例如第 8 行）
3. 檢查 B欄（店名）、D欄（場地）、E欄（日期）
4. 檢查 H欄（款項結清）是否更新

## 📋 完整診斷報告模板

請提供以下信息：

```
【審計操作記錄】
1. 點擊的預約店名：
2. 場地：
3. 日期：
4. 原付款狀態：

【Console 日誌】
發送審計更新請求: 
{
  action: "updatePayment",
  vendor: "?",
  location: "?",
  date: "?",
  rowNumber: ?,  // ← 是數字還是 undefined?
  payment: "己繳款"
}

審計更新回應: 
{
  success: ?,  // true 或 false?
  message: "?"
}

【Google Sheets 結果】
- 原記錄是否被更新？
- 是否新增了一行？
- 新增的行內容是什麼？

【event 對象】
console.log(window.currentAuditEvent):
{
  title: "?",
  location: "?",
  start: "?",
  rowNumber: ?,  // ← 關鍵！
  payment: "?"
}
```

## 🎯 預期正常行為

```
1. 點擊「尚未付款」預約
2. 選擇「己繳場租審計」
3. 輸入密碼 sky36990
4. Console 顯示：
   發送審計更新請求: {
     action: "updatePayment",
     vendor: "店名",
     location: "四維路59號",
     date: "2025-10-14",
     rowNumber: 8,  // ✅ 有數字
     payment: "己繳款"
   }
5. Console 顯示：
   審計更新回應: {
     success: true,  // ✅
     message: "成功更新付款狀態"
   }
6. 2秒後自動同步
7. 原記錄的 H欄 更新為「己繳款」
8. 不應該新增任何行！
```

## 🔧 臨時修復方案

如果診斷後發現是 rowNumber 問題，可以手動指定：

```javascript
// 在 Console 中
// 1. 找出要更新的記錄的行號（在 Google Sheets 中查看）
const actualRowNumber = 8; // 例如第8行

// 2. 手動更新
const updateData = {
  action: 'updatePayment',
  vendor: '店名',
  location: '四維路59號',
  date: '2025-10-14',
  rowNumber: actualRowNumber,
  payment: '己繳款'
};

submitToGoogleSheets(updateData).then(result => {
  console.log('結果:', result);
  if (result.success) {
    // 刷新數據
    fetchBookingsFromGoogleSheets();
    setTimeout(() => {
      mergeSheetsDataToCalendar();
      saveToLocalStorage();
    }, 2000);
  }
});
```

---

*診斷指南版本：v1.0*  
*日期：2025-10-14*  
*用途：診斷審計功能不更新而是新增記錄的問題*


# 🔧 新增預約無法寫入 Google Sheets - 診斷與修復

## 問題現象
✅ Web App URL 已設定：`https://script.google.com/macros/s/AKfycbzSw1_5Ve7WIwzziUAwKKmu3tde8DzBOxRi7ghxzmGbn10M1EtGKJARIPwVVY35-zZp/exec`

❌ 但新增預約時資料沒有寫入 Google Sheets

---

## 🔍 診斷步驟

### 步驟 1️⃣：檢查瀏覽器控制台

1. 按 **F12** 開啟開發者工具
2. 切換到 **Console（控制台）** 標籤
3. 嘗試新增一筆預約
4. 查看是否有錯誤訊息

**常見錯誤訊息：**
```
❌ CORS policy blocked
❌ 403 Forbidden
❌ 404 Not Found
❌ Failed to fetch
```

---

### 步驟 2️⃣：檢查 Google Apps Script 部署

#### 2.1 確認部署設定

1. 開啟 Google Apps Script 編輯器
2. 點擊 **部署** → **管理部署作業**
3. 確認設定：

```
✅ 類型：網頁應用程式
✅ 執行身分：我
✅ 具有應用程式存取權的使用者：所有人
✅ 狀態：使用中
```

#### 2.2 檢查試算表 ID

在 `google_apps_script.js` 第 199 行：

```javascript
const SPREADSHEET_ID = '1oS9zTU6DL_cCRnOI6A4ffAeXXn7fXkr6URxxMVprlG4';
```

確認這個 ID 與您的 Google Sheets 網址中的 ID 一致：
```
https://docs.google.com/spreadsheets/d/【這個ID】/edit
```

#### 2.3 測試 Apps Script

在 Apps Script 編輯器中：

1. 選擇函數：`testConnection`
2. 點擊 **執行** ▶️
3. 查看執行記錄

如果沒有 `testConnection` 函數，新增一個：

```javascript
function testConnection() {
  console.log('========== 測試連接 ==========');
  
  const SPREADSHEET_ID = '1oS9zTU6DL_cCRnOI6A4ffAeXXn7fXkr6URxxMVprlG4';
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = spreadsheet.getSheetByName('Form_Responses1');
  
  console.log('試算表名稱:', spreadsheet.getName());
  console.log('工作表名稱:', sheet.getName());
  console.log('最後一行:', sheet.getLastRow());
  
  // 測試寫入
  const testData = [
    formatTimestamp(),
    '測試餐車',
    '測試類型',
    '測試場地',
    formatDateForSheet(new Date().toISOString().split('T')[0]),
    '己排班',
    1000,
    '尚未付款',
    '系統測試'
  ];
  
  const lastRow = sheet.getLastRow();
  sheet.getRange(lastRow + 1, 1, 1, 9).setValues([testData]);
  
  console.log('✅ 測試寫入成功！');
  console.log('==============================');
  
  return {
    success: true,
    message: '連接測試成功',
    lastRow: sheet.getLastRow()
  };
}
```

---

### 步驟 3️⃣：檢查前端請求

#### 3.1 問題：`mode: 'no-cors'`

目前前端使用了 `no-cors` 模式，這會導致：
- ✅ 請求可以發送
- ❌ 無法讀取回應
- ❌ 無法確認是否成功

**位置：** `index.html` 第 4705 行

```javascript
const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(dataToSend),
  mode: 'no-cors' // ← 這個會導致問題
});
```

---

## 🔧 修復方案

### 方案 A：重新部署 Google Apps Script（推薦）

#### 步驟：

1. **開啟 Apps Script 編輯器**
   - Google Sheets → 擴充功能 → Apps Script

2. **創建新的部署**
   - 點擊 **部署** → **新增部署作業**
   - 選擇類型：**網頁應用程式**

3. **關鍵設定**（非常重要）：
   ```
   說明：v3.1.1（或任何新版本號）
   執行身分：我
   具有應用程式存取權的使用者：所有人  ← 重要！
   ```

4. **部署並複製新 URL**
   - 點擊「部署」
   - 複製新的 Web App URL

5. **更新前端 URL**
   - 編輯 `index.html` 第 4153 行
   - 替換為新的 URL
   - 儲存檔案

6. **清除瀏覽器快取**
   - Ctrl + Shift + Delete
   - 清除快取和 Cookie
   - 重新整理頁面（Ctrl + F5）

---

### 方案 B：修改前端請求模式

#### 修改 `index.html` 第 4699-4706 行：

**原本的程式碼：**
```javascript
const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(dataToSend),
  mode: 'no-cors'
});
```

**修改為：**
```javascript
const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'text/plain'  // ← 改用 text/plain
  },
  body: JSON.stringify(dataToSend)
  // ← 移除 mode: 'no-cors'
});

// 檢查回應
if (response.ok) {
  const result = await response.json();
  console.log('✅ Google Sheets 回應:', result);
  
  if (result.success) {
    return { success: true, message: result.message || '已提交到Google Sheets' };
  } else {
    throw new Error(result.message || '提交失敗');
  }
} else {
  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
}
```

---

### 方案 C：使用 Google Form 模式（備用方案）

如果 POST 請求一直有問題，可以改用 GET 請求：

#### 修改後端（google_apps_script.js）：

在 `doGet(e)` 函數中添加：

```javascript
function doGet(e) {
  // 檢查是否為新增預約請求
  if (e.parameter.action === 'add') {
    return addBookingFromGet(e.parameter);
  }
  
  // 檢查是否有獲取數據請求
  if (e.parameter.action === 'getBookings') {
    return getAllBookings();
  }
  
  // 檢查是否有獲取已預約日期請求
  if (e.parameter.action === 'getBookedDates') {
    return getBookedDates();
  }
  
  // 預設回應
  return ContentService
    .createTextOutput(JSON.stringify({
      status: 'success',
      message: '餐車排班報名系統運行正常',
      timestamp: formatTimestamp()
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

function addBookingFromGet(params) {
  const data = {
    vendor: params.vendor,
    location: params.location,
    date: params.date,
    timeSlot: params.timeSlot || '14:00-20:00',
    foodType: params.foodType,
    fee: params.fee || '600',
    timestamp: formatTimestamp()
  };
  
  return addBookingToSheet(data);
}
```

#### 修改前端（index.html）：

```javascript
async function submitToGoogleSheets(formData) {
  try {
    // 構建 URL 參數
    const params = new URLSearchParams({
      action: 'add',
      vendor: formData.vendor,
      location: formData.location,
      date: formData.date,
      timeSlot: formData.timeSlot || '14:00-20:00',
      foodType: formData.foodType,
      fee: formData.fee || '600'
    });
    
    const url = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?${params.toString()}`;
    
    const response = await fetch(url, {
      method: 'GET'
    });
    
    if (response.ok) {
      const result = await response.json();
      return result;
    } else {
      throw new Error('提交失敗');
    }
    
  } catch (error) {
    console.error('提交失敗:', error);
    throw error;
  }
}
```

---

## 🧪 測試方案

### 測試 1：直接訪問 Web App URL

在瀏覽器中訪問：
```
https://script.google.com/macros/s/AKfycbzSw1_5Ve7WIwzziUAwKKmu3tde8DzBOxRi7ghxzmGbn10M1EtGKJARIPwVVY35-zZp/exec
```

**預期結果：**
```json
{
  "status": "success",
  "message": "餐車排班報名系統運行正常",
  "timestamp": "2025-10-11 12:34:56"
}
```

如果顯示 404 或其他錯誤，表示部署有問題。

---

### 測試 2：使用 Postman 或 cURL 測試

#### cURL 命令：

```bash
curl -X POST \
  'https://script.google.com/macros/s/AKfycbzSw1_5Ve7WIwzziUAwKKmu3tde8DzBOxRi7ghxzmGbn10M1EtGKJARIPwVVY35-zZp/exec' \
  -H 'Content-Type: application/json' \
  -d '{
    "vendor": "測試餐車",
    "location": "漢堡大亨",
    "date": "2025-10-15",
    "timeSlot": "14:00-20:00",
    "foodType": "小吃車",
    "fee": "1000"
  }'
```

#### Postman 設定：

```
Method: POST
URL: https://script.google.com/.../exec
Headers:
  Content-Type: application/json
Body (raw JSON):
{
  "vendor": "測試餐車",
  "location": "漢堡大亨",
  "date": "2025-10-15",
  "timeSlot": "14:00-20:00",
  "foodType": "小吃車",
  "fee": "1000"
}
```

---

## 📋 最快解決方案

### ⚡ 立即執行（5分鐘解決）：

1. **重新部署 Apps Script**
   ```
   Apps Script 編輯器 → 部署 → 新增部署作業
   → 類型：網頁應用程式
   → 執行身分：我
   → 存取權：所有人
   → 部署
   ```

2. **複製新 URL**

3. **更新 index.html**
   ```javascript
   // 第 4153 行
   webAppUrl: '新的URL',
   ```

4. **清除快取**
   ```
   Ctrl + Shift + Delete → 清除所有
   ```

5. **測試**
   ```
   重新整理頁面 → 新增預約 → 檢查 Google Sheets
   ```

---

## 🔍 診斷結果檢查清單

完成以下檢查後，在下方打勾：

- [ ] ✅ Web App URL 正確
- [ ] ✅ 試算表 ID 正確
- [ ] ✅ 工作表名稱為 `Form_Responses1`
- [ ] ✅ 部署權限設定為「所有人」
- [ ] ✅ Apps Script `testConnection()` 執行成功
- [ ] ✅ 瀏覽器控制台無錯誤
- [ ] ✅ 直接訪問 URL 有回應
- [ ] ✅ 清除瀏覽器快取
- [ ] ✅ 測試預約成功寫入

---

## 💡 常見錯誤與解決

### 錯誤 1：「Authorization required」

**原因：** Apps Script 權限不足

**解決：**
1. Apps Script → 執行 `initializeSheets`
2. 授權應用程式
3. 重新部署

---

### 錯誤 2：「Script function not found」

**原因：** 函數名稱錯誤或未儲存

**解決：**
1. 確認 `doPost` 函數存在
2. 點擊 **儲存** 💾
3. 重新部署

---

### 錯誤 3：「Cannot read property of null」

**原因：** 找不到工作表

**解決：**
1. 確認工作表名稱為 `Form_Responses1`
2. 執行 `initializeSheets()` 建立工作表
3. 檢查試算表 ID

---

### 錯誤 4：「CORS policy blocked」

**原因：** 跨域請求被阻擋

**解決：**
- 使用方案 A（重新部署）
- 或使用方案 B（修改請求）

---

## 🎯 確認修復成功

完成修復後，執行以下測試：

1. ✅ 新增一筆測試預約
2. ✅ 檢查 Google Sheets 是否有新資料
3. ✅ 檢查控制台是否有成功訊息
4. ✅ 測試接手預約功能
5. ✅ 測試轉讓排班功能

---

<div align="center">

**🎉 如果還是無法解決，請提供以下資訊：**

1. 瀏覽器控制台的完整錯誤訊息
2. Apps Script 執行記錄的截圖
3. 直接訪問 Web App URL 的回應

</div>


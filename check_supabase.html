<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase é€£æ¥è¨ºæ–·å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #1f2937;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    
    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }
    
    .check-item {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      border-left: 4px solid #e5e7eb;
      background: #f9fafb;
    }
    
    .check-item.success {
      border-left-color: #10b981;
      background: #d1fae5;
    }
    
    .check-item.error {
      border-left-color: #ef4444;
      background: #fee2e2;
    }
    
    .check-item.warning {
      border-left-color: #f59e0b;
      background: #fef3c7;
    }
    
    .check-item.loading {
      border-left-color: #3b82f6;
      background: #dbeafe;
    }
    
    .check-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #1f2937;
    }
    
    .check-message {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .check-details {
      margin-top: 8px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 20px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Supabase è¨ºæ–·å·¥å…·</h1>
    <p class="subtitle">æª¢æŸ¥ Supabase é€£æ¥å’Œè³‡æ–™è¡¨è¨­å®š</p>
    
    <div id="checks">
      <div class="check-item loading" id="check1">
        <div class="check-title">1. æª¢æŸ¥ Supabase é€£æ¥</div>
        <div class="check-message">æ¸¬è©¦ä¸­...</div>
      </div>
      
      <div class="check-item loading" id="check2">
        <div class="check-title">2. æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨</div>
        <div class="check-message">æ¸¬è©¦ä¸­...</div>
      </div>
      
      <div class="check-item loading" id="check3">
        <div class="check-title">3. æª¢æŸ¥ RLS æ”¿ç­–</div>
        <div class="check-message">æ¸¬è©¦ä¸­...</div>
      </div>
      
      <div class="check-item loading" id="check4">
        <div class="check-title">4. æ¸¬è©¦æ’å…¥æ¬Šé™</div>
        <div class="check-message">æ¸¬è©¦ä¸­...</div>
      </div>
      
      <div class="check-item loading" id="check5">
        <div class="check-title">5. æª¢æŸ¥ç¾æœ‰è³‡æ–™</div>
        <div class="check-message">æ¸¬è©¦ä¸­...</div>
      </div>
    </div>
    
    <button id="recheckBtn">é‡æ–°è¨ºæ–·</button>
  </div>

  <script>
    const SUPABASE_URL = 'https://sqgrnowrcvspxhuudrqc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxZ3Jub3dyY3ZzcHhodXVkcnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTExNjYsImV4cCI6MjA4Mzc4NzE2Nn0.VMg-7oQTmPapHLGeLzEZ3l_5zcyCZRjJdw_X2J-8kRw';
    
    let supabaseClient;
    
    function updateCheck(id, status, title, message, details = '') {
      const check = document.getElementById(id);
      check.className = `check-item ${status}`;
      check.querySelector('.check-title').textContent = title;
      check.querySelector('.check-message').textContent = message;
      
      if (details) {
        let detailsDiv = check.querySelector('.check-details');
        if (!detailsDiv) {
          detailsDiv = document.createElement('div');
          detailsDiv.className = 'check-details';
          check.appendChild(detailsDiv);
        }
        detailsDiv.textContent = details;
      }
    }
    
    async function runDiagnostics() {
      // åˆå§‹åŒ– Supabase
      if (!supabaseClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      }
      const supabase = supabaseClient;
      
      // 1. æª¢æŸ¥é€£æ¥
      updateCheck('check1', 'loading', '1. æª¢æŸ¥ Supabase é€£æ¥', 'æ¸¬è©¦ä¸­...');
      try {
        const { data, error } = await supabase.from('foodcarcalss').select('count').limit(0);
        if (error && error.code !== 'PGRST116') { // PGRST116 æ˜¯è¡¨ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼Œæˆ‘å€‘æœƒåœ¨ä¸‹ä¸€æ­¥æª¢æŸ¥
          throw error;
        }
        updateCheck('check1', 'success', '1. æª¢æŸ¥ Supabase é€£æ¥', 'âœ… é€£æ¥æˆåŠŸ', `URL: ${SUPABASE_URL}`);
      } catch (error) {
        updateCheck('check1', 'error', '1. æª¢æŸ¥ Supabase é€£æ¥', 'âŒ é€£æ¥å¤±æ•—', error.message);
        return;
      }
      
      // 2. æª¢æŸ¥è³‡æ–™è¡¨
      updateCheck('check2', 'loading', '2. æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨', 'æ¸¬è©¦ä¸­...');
      try {
        const { data, error } = await supabase.from('foodcarcalss').select('id').limit(1);
        if (error) {
          if (error.code === '42P01' || error.message.includes('does not exist')) {
            updateCheck('check2', 'error', '2. æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨', 'âŒ è³‡æ–™è¡¨ä¸å­˜åœ¨', 'è«‹åŸ·è¡Œ supabase_setup.sql å»ºç«‹è³‡æ–™è¡¨');
            return;
          }
          throw error;
        }
        updateCheck('check2', 'success', '2. æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨', 'âœ… è³‡æ–™è¡¨å­˜åœ¨', 'è³‡æ–™è¡¨åç¨±: foodcarcalss');
      } catch (error) {
        updateCheck('check2', 'error', '2. æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨', 'âŒ æª¢æŸ¥å¤±æ•—', error.message);
        return;
      }
      
      // 3. æª¢æŸ¥ RLS æ”¿ç­–ï¼ˆé€šéå˜—è©¦è®€å–ï¼‰
      updateCheck('check3', 'loading', '3. æª¢æŸ¥ RLS æ”¿ç­–', 'æ¸¬è©¦ä¸­...');
      try {
        const { data, error } = await supabase.from('foodcarcalss').select('*').limit(1);
        if (error) {
          if (error.code === '42501' || error.message.includes('permission denied')) {
            updateCheck('check3', 'error', '3. æª¢æŸ¥ RLS æ”¿ç­–', 'âŒ RLS æ”¿ç­–ä¸å…è¨±è®€å–', 'è«‹æª¢æŸ¥ RLS æ”¿ç­–è¨­å®šï¼Œç¢ºä¿å…è¨±å…¬é–‹è®€å–');
            return;
          }
          throw error;
        }
        updateCheck('check3', 'success', '3. æª¢æŸ¥ RLS æ”¿ç­–', 'âœ… RLS æ”¿ç­–æ­£å¸¸', 'å¯ä»¥è®€å–è³‡æ–™');
      } catch (error) {
        updateCheck('check3', 'warning', '3. æª¢æŸ¥ RLS æ”¿ç­–', 'âš ï¸ è®€å–æ¸¬è©¦å¤±æ•—', error.message);
      }
      
      // 4. æ¸¬è©¦æ’å…¥æ¬Šé™
      updateCheck('check4', 'loading', '4. æ¸¬è©¦æ’å…¥æ¬Šé™', 'æ¸¬è©¦ä¸­...');
      try {
        const testData = {
          vendor: 'æ¸¬è©¦é¤è»Š',
          location: 'æ¸¬è©¦å ´åœ°',
          booking_date: 'æ¸¬è©¦æ—¥æœŸ',
          payment: 'æœªç¹³æ¬¾'
        };
        
        const { data, error } = await supabase
          .from('foodcarcalss')
          .insert(testData)
          .select();
        
        if (error) {
          if (error.code === '42501' || error.message.includes('permission denied')) {
            updateCheck('check4', 'error', '4. æ¸¬è©¦æ’å…¥æ¬Šé™', 'âŒ RLS æ”¿ç­–ä¸å…è¨±æ’å…¥', 
              `éŒ¯èª¤: ${error.message}\n\nè«‹åŸ·è¡Œä»¥ä¸‹ SQL ä¾†ä¿®å¾©ï¼š\n\nCREATE POLICY "Allow public insert" ON foodcarcalss\n  FOR INSERT\n  WITH CHECK (true);`);
            return;
          }
          throw error;
        }
        
        // åˆªé™¤æ¸¬è©¦è³‡æ–™
        if (data && data[0]) {
          await supabase.from('foodcarcalss').delete().eq('id', data[0].id);
        }
        
        updateCheck('check4', 'success', '4. æ¸¬è©¦æ’å…¥æ¬Šé™', 'âœ… æ’å…¥æ¬Šé™æ­£å¸¸', 'å¯ä»¥æ’å…¥è³‡æ–™');
      } catch (error) {
        updateCheck('check4', 'error', '4. æ¸¬è©¦æ’å…¥æ¬Šé™', 'âŒ æ’å…¥æ¸¬è©¦å¤±æ•—', 
          `éŒ¯èª¤: ${error.message}\néŒ¯èª¤ä»£ç¢¼: ${error.code || 'N/A'}\n\nå¯èƒ½åŸå› ï¼š\n1. RLS æ”¿ç­–æœªæ­£ç¢ºè¨­å®š\n2. è³‡æ–™è¡¨æ¬„ä½ä¸åŒ¹é…\n3. å¿…å¡«æ¬„ä½ç¼ºå¤±`);
      }
      
      // 5. æª¢æŸ¥ç¾æœ‰è³‡æ–™
      updateCheck('check5', 'loading', '5. æª¢æŸ¥ç¾æœ‰è³‡æ–™', 'æ¸¬è©¦ä¸­...');
      try {
        const { data, error, count } = await supabase
          .from('foodcarcalss')
          .select('*', { count: 'exact' })
          .limit(10);
        
        if (error) throw error;
        
        const totalCount = count || (data ? data.length : 0);
        updateCheck('check5', 'success', '5. æª¢æŸ¥ç¾æœ‰è³‡æ–™', 
          `âœ… è³‡æ–™è¡¨ä¸­æœ‰ ${totalCount} ç­†è³‡æ–™`, 
          data && data.length > 0 ? `å‰ ${Math.min(data.length, 5)} ç­†è³‡æ–™ï¼š\n${JSON.stringify(data.slice(0, 5), null, 2)}` : 'ç›®å‰æ²’æœ‰è³‡æ–™');
      } catch (error) {
        updateCheck('check5', 'warning', '5. æª¢æŸ¥ç¾æœ‰è³‡æ–™', 'âš ï¸ æŸ¥è©¢å¤±æ•—', error.message);
      }
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
    window.addEventListener('DOMContentLoaded', () => {
      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      document.getElementById('recheckBtn').addEventListener('click', runDiagnostics);
      
      // å»¶é²åŸ·è¡Œè¨ºæ–·ï¼Œç¢ºä¿ Supabase åº«å·²è¼‰å…¥
      setTimeout(() => {
        if (typeof window.supabase !== 'undefined') {
          runDiagnostics();
        } else {
          updateCheck('check1', 'error', '1. æª¢æŸ¥ Supabase é€£æ¥', 'âŒ Supabase åº«æœªè¼‰å…¥', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢');
        }
      }, 500);
    });
  </script>
</body>
</html>

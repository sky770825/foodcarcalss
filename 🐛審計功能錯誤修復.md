# ğŸ› å¯©è¨ˆåŠŸèƒ½éŒ¯èª¤ä¿®å¾©

## âŒ éŒ¯èª¤è¨Šæ¯

```
æ›´æ–°å¤±æ•—
ç„¡æ³•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦
```

## ğŸ” å•é¡Œæ ¹æº

### åŸå§‹ä»£ç¢¼ï¼ˆéŒ¯èª¤ï¼‰

```javascript
// ç¬¬ 556 è¡Œ
const response = await fetch(API_URL, {  // âŒ API_URL æœªå®šç¾©ï¼
  method: 'POST',
  mode: 'no-cors',  // âŒ no-cors ç„¡æ³•è®€å–å›æ‡‰
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(updateData)
});
```

### å•é¡Œåˆ†æ

1. **è®Šæ•¸æœªå®šç¾©**
   - ä½¿ç”¨äº† `API_URL` è®Šæ•¸
   - ä½†é€™å€‹è®Šæ•¸æ²’æœ‰åœ¨ä»»ä½•åœ°æ–¹å®šç¾©
   - å°è‡´ `fetch` è«‹æ±‚å¤±æ•—

2. **ä½¿ç”¨ no-cors æ¨¡å¼**
   - `mode: 'no-cors'` ç„¡æ³•è®€å–å›æ‡‰
   - ç„¡æ³•åˆ¤æ–·è«‹æ±‚æ˜¯å¦æˆåŠŸ
   - éŒ¯èª¤è™•ç†ä¸æ­£ç¢º

3. **ç¼ºå°‘æ­£ç¢ºçš„ Google Sheets æ•´åˆ**
   - æ²’æœ‰ä½¿ç”¨ç¾æœ‰çš„ `submitToGoogleSheets` å‡½æ•¸
   - æ²’æœ‰ä½¿ç”¨ `GOOGLE_SHEETS_CONFIG.webAppUrl`

## âœ… è§£æ±ºæ–¹æ¡ˆ

### ä¿®å¾©å¾Œçš„ä»£ç¢¼

```javascript
try {
  // ç™¼é€è«‹æ±‚æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºã€Œå·±ç¹³æ¬¾ã€
  const updateData = {
    action: 'updatePayment',
    vendor: event.title,
    location: event.location,
    date: dateStr,
    rowNumber: event.rowNumber,
    payment: 'å·±ç¹³æ¬¾'
  };
  
  console.log('ç™¼é€å¯©è¨ˆæ›´æ–°è«‹æ±‚:', updateData);
  
  // âœ… ä½¿ç”¨ Google Sheets submitToGoogleSheets å‡½æ•¸
  const result = await submitToGoogleSheets(updateData);
  
  console.log('å¯©è¨ˆæ›´æ–°å›æ‡‰:', result);
  
  hideLoading();
  
  if (result.success) {
    showToast('success', 'æ›´æ–°æˆåŠŸ', `å·²å°‡ ${event.title} çš„ä»˜æ¬¾ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·±ç¹³æ¬¾ã€`);
    
    // âœ… å¤šæ¬¡åŒæ­¥ç¢ºä¿æ›´æ–°
    setTimeout(async () => {
      try {
        console.log('å¯©è¨ˆå¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ2ç§’å¾Œï¼‰...');
        await fetchBookingsFromGoogleSheets();
        await fetchBookedDatesFromSheets();
        mergeSheetsDataToCalendar();
        saveToLocalStorage();
        console.log('å¯©è¨ˆå¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ');
      } catch (error) {
        console.error('å¯©è¨ˆå¾ŒåŒæ­¥å¤±æ•—:', error);
      }
    }, 2000);
    
    setTimeout(async () => {
      try {
        console.log('å¯©è¨ˆå¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ4ç§’å¾Œï¼‰...');
        await fetchBookingsFromGoogleSheets();
        mergeSheetsDataToCalendar();
        saveToLocalStorage();
        console.log('å¯©è¨ˆå¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ');
      } catch (error) {
        console.error('å¯©è¨ˆå¾ŒåŒæ­¥å¤±æ•—:', error);
      }
    }, 4000);
  } else {
    showToast('error', 'æ›´æ–°å¤±æ•—', result.message || 'ç„¡æ³•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
  
} catch (error) {
  console.error('æ›´æ–°ä»˜æ¬¾ç‹€æ…‹å¤±æ•—:', error);
  hideLoading();
  showToast('error', 'æ›´æ–°å¤±æ•—', 'ç„¡æ³•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦');
}
```

## ğŸ¯ æ”¹é€²é»

### 1. ä½¿ç”¨æ­£ç¢ºçš„ API å‡½æ•¸
```javascript
// âŒ éŒ¯èª¤
const response = await fetch(API_URL, {...});

// âœ… æ­£ç¢º
const result = await submitToGoogleSheets(updateData);
```

### 2. æ­£ç¢ºè™•ç†å›æ‡‰
```javascript
// âŒ éŒ¯èª¤ï¼šå‡è¨­æˆåŠŸ
// ç”±æ–¼ä½¿ç”¨ no-corsï¼Œæˆ‘å€‘å‡è¨­è«‹æ±‚æˆåŠŸ
hideLoading();
showToast('success', 'æ›´æ–°æˆåŠŸ', ...);

// âœ… æ­£ç¢ºï¼šæª¢æŸ¥çµæœ
if (result.success) {
  showToast('success', 'æ›´æ–°æˆåŠŸ', ...);
} else {
  showToast('error', 'æ›´æ–°å¤±æ•—', result.message || ...);
}
```

### 3. æ·»åŠ å¤šæ¬¡åŒæ­¥æ©Ÿåˆ¶
```javascript
// âœ… ç¢ºä¿æ•¸æ“šæ›´æ–°åˆ°æ—¥æ›†
setTimeout(async () => {
  await fetchBookingsFromGoogleSheets();
  await fetchBookedDatesFromSheets();
  mergeSheetsDataToCalendar();
  saveToLocalStorage();
}, 2000);

// âœ… ç¬¬äºŒæ¬¡ç¢ºèªåŒæ­¥
setTimeout(async () => {
  await fetchBookingsFromGoogleSheets();
  mergeSheetsDataToCalendar();
  saveToLocalStorage();
}, 4000);
```

## ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦å¯©è¨ˆåŠŸèƒ½

1. **æ‰“é–‹ç³»çµ±**
   - æ‰¾ä¸€å€‹ã€Œå°šæœªä»˜æ¬¾ã€çš„é ç´„

2. **é»æ“Šé ç´„**
   - é¸æ“‡ã€Œå·±ç¹³å ´ç§Ÿå¯©è¨ˆã€

3. **è¼¸å…¥å¯©è¨ˆå¯†ç¢¼**
   - å¯†ç¢¼ï¼š`sky36990`
   - é»æ“Šã€Œç¢ºèªå¯©è¨ˆã€

4. **è§€å¯Ÿçµæœ**
   - æ‡‰è©²é¡¯ç¤ºï¼šã€Œâœ… æ›´æ–°æˆåŠŸã€
   - 2ç§’å¾Œè‡ªå‹•åŒæ­¥
   - ä»˜æ¬¾ç‹€æ…‹è®Šç‚ºã€Œâœ“ å·²ä»˜æ¬¾ã€

5. **æª¢æŸ¥ Console**
   ```
   ç™¼é€å¯©è¨ˆæ›´æ–°è«‹æ±‚: {...}
   å¯©è¨ˆæ›´æ–°å›æ‡‰: {success: true, ...}
   å¯©è¨ˆå¾Œç¬¬1æ¬¡åŒæ­¥ï¼ˆ2ç§’å¾Œï¼‰...
   å¯©è¨ˆå¾Œç¬¬1æ¬¡åŒæ­¥å®Œæˆ
   å¯©è¨ˆå¾Œç¬¬2æ¬¡åŒæ­¥ï¼ˆ4ç§’å¾Œï¼‰...
   å¯©è¨ˆå¾Œç¬¬2æ¬¡åŒæ­¥å®Œæˆ
   ```

## âš ï¸ æ³¨æ„äº‹é …

### Google Apps Script éœ€è¦æ”¯æ´

ç¢ºä¿æ‚¨çš„ `google_apps_script.js` æœ‰è™•ç† `updatePayment` actionï¼š

```javascript
if (action === 'updatePayment') {
  const vendor = data.vendor;
  const location = data.location;
  const date = data.date;
  const payment = data.payment;
  
  // æ‰¾åˆ°å°æ‡‰çš„è¡Œä¸¦æ›´æ–°ä»˜æ¬¾ç‹€æ…‹
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === vendor && 
        values[i][1] === location && 
        values[i][2] === date) {
      sheet.getRange(i + 1, 6).setValue(payment); // ç¬¬6åˆ—æ˜¯ä»˜æ¬¾ç‹€æ…‹
      return ContentService.createTextOutput(
        JSON.stringify({success: true})
      ).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(
    JSON.stringify({success: false, message: 'æ‰¾ä¸åˆ°å°æ‡‰çš„é ç´„è¨˜éŒ„'})
  ).setMimeType(ContentService.MimeType.JSON);
}
```

## âœ… ä¿®å¾©å®Œæˆ

- âœ… ä¿®å¾© `API_URL` æœªå®šç¾©éŒ¯èª¤
- âœ… ä½¿ç”¨æ­£ç¢ºçš„ `submitToGoogleSheets` å‡½æ•¸
- âœ… æ·»åŠ å›æ‡‰æª¢æŸ¥æ©Ÿåˆ¶
- âœ… æ·»åŠ å¤šæ¬¡åŒæ­¥ç¢ºä¿æ›´æ–°
- âœ… æ›´æ–°å¿«å–æ•¸æ“š

ç¾åœ¨å¯©è¨ˆåŠŸèƒ½æ‡‰è©²å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼

---

*ä¿®å¾©æ—¥æœŸï¼š2025-10-14*  
*ç‰ˆæœ¬ï¼šv3.2.3*  
*å•é¡Œï¼šå¯©è¨ˆåŠŸèƒ½ç„¡æ³•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹* âœ… å·²ä¿®å¾©


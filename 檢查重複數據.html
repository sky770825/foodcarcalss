<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æª¢æŸ¥ Supabase é‡è¤‡æ•¸æ“š</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-card.warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .stat-card.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .duplicate-list {
      margin-top: 30px;
    }
    .duplicate-item {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .duplicate-item h3 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    .duplicate-item .ids {
      font-family: monospace;
      color: #666;
      font-size: 12px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Supabase é‡è¤‡æ•¸æ“šæª¢æŸ¥å·¥å…·</h1>
    
    <div id="errorContainer"></div>
    
    <div id="loading" class="loading">
      <p>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
    </div>
    
    <div id="results" style="display: none;">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
        </div>
        <div class="stat-card warning" id="duplicateCard">
          <div class="stat-value" id="duplicateCount">0</div>
          <div class="stat-label">é‡è¤‡è¨˜éŒ„æ•¸</div>
        </div>
        <div class="stat-card success">
          <div class="stat-value" id="uniqueCount">0</div>
          <div class="stat-label">å”¯ä¸€è¨˜éŒ„æ•¸</div>
        </div>
      </div>
      
      <div class="duplicate-list" id="duplicateList"></div>
      
      <button id="deleteDuplicatesBtn" onclick="deleteDuplicates()" disabled>
        åˆªé™¤é‡è¤‡è¨˜éŒ„ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
      </button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://sqgrnowrcvspxhuudrqc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxZ3Jub3dyY3ZzcHhodXVkcnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTExNjYsImV4cCI6MjA4Mzc4NzE2Nn0.VMg-7oQTmPapHLGeLzEZ3l_5zcyCZRjJdw_X2J-8kRw';
    
    let supabaseClient;
    let duplicates = [];
    
    // åˆå§‹åŒ–
    if (typeof window.supabase !== 'undefined') {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkDuplicates();
    } else {
      showError('Supabase åº«æœªè¼‰å…¥');
    }
    
    async function checkDuplicates() {
      try {
        // ç²å–æ‰€æœ‰è¨˜éŒ„
        const { data: allBookings, error } = await supabaseClient
          .from('foodcarcalss')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        document.getElementById('totalCount').textContent = allBookings.length;
        
        // æ‰¾å‡ºé‡è¤‡è¨˜éŒ„ï¼ˆåŸºæ–¼ location + booking_date + vendorï¼‰
        const seen = new Map();
        const duplicateGroups = new Map();
        
        allBookings.forEach(booking => {
          const key = `${booking.location}|${booking.booking_date}|${booking.vendor}`;
          
          if (seen.has(key)) {
            if (!duplicateGroups.has(key)) {
              duplicateGroups.set(key, [seen.get(key)]);
            }
            duplicateGroups.get(key).push(booking);
          } else {
            seen.set(key, booking);
          }
        });
        
        // è½‰æ›ç‚ºé™£åˆ—æ ¼å¼
        duplicates = Array.from(duplicateGroups.entries()).map(([key, bookings]) => ({
          key,
          bookings: [seen.get(key), ...bookings], // åŒ…å«ç¬¬ä¸€å€‹å’Œæ‰€æœ‰é‡è¤‡çš„
          total: bookings.length + 1
        }));
        
        const duplicateCount = duplicates.reduce((sum, group) => sum + (group.total - 1), 0);
        const uniqueCount = allBookings.length - duplicateCount;
        
        document.getElementById('duplicateCount').textContent = duplicateCount;
        document.getElementById('uniqueCount').textContent = uniqueCount;
        
        // é¡¯ç¤ºé‡è¤‡è¨˜éŒ„
        if (duplicates.length > 0) {
          const duplicateList = document.getElementById('duplicateList');
          duplicateList.innerHTML = '<h2>é‡è¤‡è¨˜éŒ„è©³æƒ…</h2>';
          
          duplicates.forEach((group, index) => {
            const [location, date, vendor] = group.key.split('|');
            const div = document.createElement('div');
            div.className = 'duplicate-item';
            div.innerHTML = `
              <h3>é‡è¤‡çµ„ #${index + 1}: ${vendor} - ${location} - ${date}</h3>
              <p><strong>é‡è¤‡æ¬¡æ•¸:</strong> ${group.total} ç­†</p>
              <div class="ids">
                <strong>è¨˜éŒ„ ID:</strong> ${group.bookings.map(b => b.id).join(', ')}
              </div>
              <div style="margin-top: 10px; font-size: 12px;">
                ${group.bookings.map(b => `
                  <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 4px;">
                    ID: ${b.id} | å»ºç«‹æ™‚é–“: ${new Date(b.created_at).toLocaleString('zh-TW')} | 
                    æ›´æ–°æ™‚é–“: ${new Date(b.updated_at).toLocaleString('zh-TW')}
                  </div>
                `).join('')}
              </div>
            `;
            duplicateList.appendChild(div);
          });
          
          document.getElementById('deleteDuplicatesBtn').disabled = false;
        } else {
          document.getElementById('duplicateList').innerHTML = '<p style="color: green;">âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡è¨˜éŒ„ï¼</p>';
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        
      } catch (error) {
        showError('æª¢æŸ¥å¤±æ•—: ' + error.message);
        console.error(error);
      }
    }
    
    async function deleteDuplicates() {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${duplicates.reduce((sum, g) => sum + (g.total - 1), 0)} ç­†é‡è¤‡è¨˜éŒ„å—ï¼Ÿ\n\nå°‡ä¿ç•™æ¯çµ„ä¸­æœ€æ–°çš„ä¸€ç­†è¨˜éŒ„ã€‚`)) {
        return;
      }
      
      const deleteBtn = document.getElementById('deleteDuplicatesBtn');
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'æ­£åœ¨åˆªé™¤...';
      
      try {
        let deletedCount = 0;
        
        for (const group of duplicates) {
          // æŒ‰ created_at æ’åºï¼Œä¿ç•™æœ€æ–°çš„ï¼ˆæœ€å¾Œä¸€å€‹ï¼‰
          const sorted = group.bookings.sort((a, b) => 
            new Date(a.created_at) - new Date(b.created_at)
          );
          
          // åˆªé™¤é™¤äº†æœ€å¾Œä¸€å€‹ä¹‹å¤–çš„æ‰€æœ‰è¨˜éŒ„
          const toDelete = sorted.slice(0, -1);
          
          for (const booking of toDelete) {
            const { error } = await supabaseClient
              .from('foodcarcalss')
              .delete()
              .eq('id', booking.id);
            
            if (error) throw error;
            deletedCount++;
          }
        }
        
        alert(`âœ… æˆåŠŸåˆªé™¤ ${deletedCount} ç­†é‡è¤‡è¨˜éŒ„ï¼`);
        location.reload();
        
      } catch (error) {
        showError('åˆªé™¤å¤±æ•—: ' + error.message);
        console.error(error);
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'åˆªé™¤é‡è¤‡è¨˜éŒ„ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰';
      }
    }
    
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.getElementById('errorContainer').appendChild(errorDiv);
      document.getElementById('loading').style.display = 'none';
    }
  </script>
</body>
</html>

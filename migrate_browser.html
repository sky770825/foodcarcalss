<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheets åˆ° Supabase é·ç§»å·¥å…· - è‡ªå‹•é·ç§»ä¸­...</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #1f2937;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    
    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    
    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block !important;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block !important;
    }
    
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
      display: block !important;
      animation: pulse 2s infinite;
    }
    
    .progress {
      margin-top: 20px;
      display: block !important; /* å¼·åˆ¶é¡¯ç¤º */
      opacity: 1;
    }
    
    .progress.active {
      display: block !important;
      opacity: 1;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      margin-top: 8px;
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.8;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ è³‡æ–™é·ç§»å·¥å…·</h1>
    <p class="subtitle">å°‡ Google Sheets è³‡æ–™é·ç§»åˆ° Supabase</p>
    
    <form id="migrationForm">
      <div class="form-group">
        <label>Supabase URL</label>
        <input type="text" id="supabaseUrl" value="https://sqgrnowrcvspxhuudrqc.supabase.co" required>
      </div>
      
      <div class="form-group">
        <label>Supabase Anon Key</label>
        <input type="text" id="supabaseKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxZ3Jub3dyY3ZzcHhodXVkcnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTExNjYsImV4cCI6MjA4Mzc4NzE2Nn0.VMg-7oQTmPapHLGeLzEZ3l_5zcyCZRjJdw_X2J-8kRw" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Supabase Anon Key" required>
      </div>
      
      <div class="form-group">
        <label>Google Sheets API URL</label>
        <input type="text" id="sheetsUrl" value="https://script.google.com/macros/s/AKfycbxl0lUEzPoa2bjAm_X0KPXi_ZDIUB5BHbIjF912-lofb2mj7caelPU7fhQODi6D4T_4/exec" required>
      </div>
      
      <button type="submit" id="migrateBtn" style="display: none;">
        <span id="btnText">é–‹å§‹é·ç§»</span>
      </button>
      <div id="autoStartInfo" style="text-align: center; color: #6b7280; font-size: 0.9rem; margin-top: 20px;">
        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è‡ªå‹•é–‹å§‹é·ç§»...
      </div>
    </form>
    
    <div class="progress active" id="progress" style="display: block !important; opacity: 1;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
      </div>
      <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹é·ç§»...</div>
    </div>
    
    <div class="status info" id="status" style="display: block !important;">
      <strong>â³ æ­£åœ¨åˆå§‹åŒ–ï¼Œæº–å‚™é–‹å§‹é·ç§»...</strong>
    </div>
  </div>

  <script>
    const form = document.getElementById('migrationForm');
    const migrateBtn = document.getElementById('migrateBtn');
    const btnText = document.getElementById('btnText');
    const status = document.getElementById('status');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    let supabaseClientInstance;
    
    // è‡ªå‹•é–‹å§‹é·ç§»
    window.addEventListener('DOMContentLoaded', async () => {
      // ç«‹å³é¡¯ç¤ºé€²åº¦æ¢å’Œç‹€æ…‹
      progress.className = 'progress active';
      progressFill.style.width = '0%';
      progressText.textContent = 'æº–å‚™é–‹å§‹é·ç§»...';
      status.className = 'status info';
      status.innerHTML = '<strong>â³ æ­£åœ¨åˆå§‹åŒ–ï¼Œæº–å‚™é–‹å§‹é·ç§»...</strong>';
      status.style.display = 'block';
      
      // ç­‰å¾… 1 ç§’è®“é é¢å®Œå…¨è¼‰å…¥
      setTimeout(async () => {
        try {
          const supabaseUrl = document.getElementById('supabaseUrl').value;
          const supabaseKey = document.getElementById('supabaseKey').value;
          const sheetsUrl = document.getElementById('sheetsUrl').value;
          
          // æ›´æ–°ç‹€æ…‹
          progressFill.style.width = '2%';
          progressText.textContent = 'æ­£åœ¨åˆå§‹åŒ– Supabase...';
          status.innerHTML = '<strong>ğŸ”§ æ­£åœ¨åˆå§‹åŒ– Supabase é€£æ¥...</strong>';
          
          // å¼·åˆ¶æ›´æ–°é¡¯ç¤º
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // åˆå§‹åŒ– Supabase
          if (typeof window.supabase === 'undefined') {
            progressFill.style.width = '0%';
            progressText.textContent = 'éŒ¯èª¤ï¼šSupabase åº«æœªè¼‰å…¥';
            status.className = 'status error';
            status.innerHTML = '<strong>âŒ Supabase åº«æœªè¼‰å…¥</strong><br>è«‹é‡æ–°æ•´ç†é é¢';
            return;
          }
          
          supabaseClientInstance = window.supabase.createClient(supabaseUrl, supabaseKey);
          console.log('Supabase å®¢æˆ¶ç«¯å·²åˆå§‹åŒ–');
          
          progressFill.style.width = '5%';
          progressText.textContent = 'Supabase é€£æ¥æˆåŠŸï¼Œé–‹å§‹é·ç§»...';
          status.innerHTML = '<strong>âœ… Supabase é€£æ¥æˆåŠŸ</strong><br>æ­£åœ¨é–‹å§‹é·ç§»è³‡æ–™...';
          
          // å¼·åˆ¶æ›´æ–°é¡¯ç¤º
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // é–‹å§‹é·ç§»
          await migrateData(sheetsUrl);
        } catch (error) {
          console.error('è‡ªå‹•é·ç§»å¤±æ•—:', error);
          progressFill.style.width = '0%';
          progressText.textContent = 'é·ç§»å¤±æ•—';
          status.className = 'status error';
          status.innerHTML = `<strong>âŒ è‡ªå‹•é·ç§»å¤±æ•—</strong><br>${error.message}`;
        }
      }, 1000);
    });
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const supabaseUrl = document.getElementById('supabaseUrl').value;
      const supabaseKey = document.getElementById('supabaseKey').value;
      const sheetsUrl = document.getElementById('sheetsUrl').value;
      
      // åˆå§‹åŒ– Supabase
      if (typeof window.supabase === 'undefined') {
        status.className = 'status error';
        status.innerHTML = '<strong>âŒ Supabase åº«æœªè¼‰å…¥</strong><br>è«‹é‡æ–°æ•´ç†é é¢';
        return;
      }
      supabaseClientInstance = window.supabase.createClient(supabaseUrl, supabaseKey);
      console.log('Supabase å®¢æˆ¶ç«¯å·²åˆå§‹åŒ–');
      
      // é–‹å§‹é·ç§»
      await migrateData(sheetsUrl);
    });
    
    async function migrateData(sheetsUrl) {
      try {
        // æ›´æ–° UI - ç¢ºä¿é€²åº¦æ¢å’Œç‹€æ…‹å¯è¦‹
        document.getElementById('autoStartInfo').style.display = 'none';
        migrateBtn.disabled = true;
        btnText.textContent = 'é·ç§»ä¸­...';
        
        // å¼·åˆ¶é¡¯ç¤ºé€²åº¦æ¢å’Œç‹€æ…‹
        progress.className = 'progress active';
        progress.style.display = 'block';
        progress.style.opacity = '1';
        status.className = 'status info';
        status.style.display = 'block';
        
        // ç«‹å³é¡¯ç¤ºåˆå§‹ç‹€æ…‹
        progressFill.style.width = '5%';
        progressText.textContent = 'æ­¥é©Ÿ 1/3: å¾ Google Sheets ç²å–è³‡æ–™...';
        status.innerHTML = '<strong>ğŸ“¥ æ­¥é©Ÿ 1/3: æ­£åœ¨å¾ Google Sheets ç²å–è³‡æ–™...</strong>';
        
        // å¼·åˆ¶æ›´æ–°é¡¯ç¤ºï¼ˆä½¿ç”¨ requestAnimationFrame ç¢ºä¿æ¸²æŸ“ï¼‰
        requestAnimationFrame(() => {
          progressFill.style.width = '5%';
        });
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 1. å¾ Google Sheets ç²å–è³‡æ–™
        console.log('é–‹å§‹å¾ Google Sheets ç²å–è³‡æ–™...');
        const response = await fetch(`${sheetsUrl}?action=getBookings`);
        const data = await response.json();
        
        console.log('Google Sheets å›æ‡‰:', data);
        
        if (!data.success || !data.bookings) {
          throw new Error('ç„¡æ³•å¾ Google Sheets ç²å–è³‡æ–™: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
        
        const bookings = data.bookings;
        console.log(`æˆåŠŸç²å– ${bookings.length} ç­†é ç´„è³‡æ–™`);
        console.log('å‰3ç­†è³‡æ–™ç¯„ä¾‹:', bookings.slice(0, 3));
        
        progressFill.style.width = '15%';
        progressText.textContent = `âœ… æˆåŠŸç²å– ${bookings.length} ç­†è³‡æ–™`;
        status.className = 'status info';
        status.innerHTML = `<strong>ğŸ“¥ å·²ç²å– ${bookings.length} ç­†è³‡æ–™</strong><br>æ­£åœ¨æ¸¬è©¦ Supabase é€£æ¥...`;
        
        // å¼·åˆ¶æ›´æ–°é¡¯ç¤º
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // æ¸¬è©¦ Supabase é€£æ¥
        console.log('æ¸¬è©¦ Supabase é€£æ¥...');
        progressText.textContent = 'æ­¥é©Ÿ 2/3: æ¸¬è©¦ Supabase é€£æ¥...';
        progressFill.style.width = '20%';
        
        const { data: testData, error: testError } = await supabaseClientInstance
          .from('foodcarcalss')
          .select('count')
          .limit(1);
        
        if (testError) {
          console.error('Supabase é€£æ¥æ¸¬è©¦å¤±æ•—:', testError);
          throw new Error('ç„¡æ³•é€£æ¥åˆ° Supabase: ' + testError.message);
        }
        console.log('Supabase é€£æ¥æˆåŠŸ');
        
        progressFill.style.width = '25%';
        progressText.textContent = 'âœ… Supabase é€£æ¥æˆåŠŸï¼Œé–‹å§‹é·ç§»è³‡æ–™...';
        status.className = 'status info';
        status.innerHTML = `<strong>ğŸ”„ é–‹å§‹é·ç§»è³‡æ–™åˆ° Supabase...</strong><br>ç¸½å…± ${bookings.length} ç­†è³‡æ–™`;
        
        // å¼·åˆ¶æ›´æ–°é¡¯ç¤º
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // 2. è½‰æ›ä¸¦æ’å…¥è³‡æ–™
        let successCount = 0;
        let errorCount = 0;
        const batchSize = 50;
        const errors = [];
        
        for (let i = 0; i < bookings.length; i += batchSize) {
          const batch = bookings.slice(i, i + batchSize);
          const transformedBatch = batch.map(booking => {
            // ç¢ºä¿æ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½æœ‰å€¼
            const transformed = {
              timestamp: booking.timestamp || new Date().toISOString(),
              vendor: booking.vendor || '',
              food_type: booking.foodType || '',
              location: booking.location || '',
              booking_date: booking.date || '',
              status: booking.status || booking.bookedStatus || 'å·±æ’',
              fee: booking.fee || '600å…ƒ/å¤©',
              payment: booking.payment || 'æœªç¹³æ¬¾',
              note: booking.note || ''
            };
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!transformed.vendor || !transformed.location || !transformed.booking_date) {
              console.warn('è³‡æ–™é©—è­‰å¤±æ•—ï¼Œè·³é:', transformed);
              return null;
            }
            
            return transformed;
          }).filter(item => item !== null); // éæ¿¾æ‰ç„¡æ•ˆè³‡æ–™
          
          if (transformedBatch.length === 0) {
            console.warn(`æ‰¹æ¬¡ ${Math.floor(i / batchSize) + 1} æ²’æœ‰æœ‰æ•ˆè³‡æ–™ï¼Œè·³é`);
            errorCount += batch.length;
            continue;
          }
          
          console.log(`æº–å‚™æ’å…¥æ‰¹æ¬¡ ${Math.floor(i / batchSize) + 1}ï¼Œå…± ${transformedBatch.length} ç­†`);
          
          const { data, error } = await supabaseClientInstance
            .from('foodcarcalss')
            .insert(transformedBatch)
            .select();
          
          if (error) {
            console.error(`æ‰¹æ¬¡ ${Math.floor(i / batchSize) + 1} æ’å…¥å¤±æ•—:`, error);
            console.error('éŒ¯èª¤è©³æƒ…:', JSON.stringify(error, null, 2));
            console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
            console.error('éŒ¯èª¤è¨Šæ¯:', error.message);
            console.error('éŒ¯èª¤è©³æƒ…:', error.details);
            console.error('éŒ¯èª¤æç¤º:', error.hint);
            
            errors.push({
              batch: Math.floor(i / batchSize) + 1,
              error: error.message || JSON.stringify(error),
              count: transformedBatch.length
            });
            
            errorCount += transformedBatch.length;
            
            // é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼ˆä½†ä¸ä¸­æ–·æ•´å€‹æµç¨‹ï¼‰
            if (errors.length === 1) {
              status.className = 'status error';
              status.innerHTML = `
                <strong>âš ï¸ æ’å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤</strong><br>
                éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}<br>
                éŒ¯èª¤ä»£ç¢¼: ${error.code || 'N/A'}<br>
                <small>è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼Œé·ç§»å°‡ç¹¼çºŒé€²è¡Œ...</small>
              `;
            }
          } else {
            console.log(`æ‰¹æ¬¡ ${Math.floor(i / batchSize) + 1} æ’å…¥æˆåŠŸï¼Œæ’å…¥ ${data ? data.length : transformedBatch.length} ç­†`);
            successCount += transformedBatch.length;
          }
          
          // æ›´æ–°é€²åº¦ï¼ˆå¾ 25% é–‹å§‹ï¼Œåˆ° 95% çµæŸï¼‰
          const progressPercent = Math.min(25 + ((i + batchSize) / bookings.length) * 70, 95);
          progressFill.style.width = `${progressPercent}%`;
          const processed = Math.min(i + batchSize, bookings.length);
          progressText.textContent = `æ­¥é©Ÿ 3/3: å·²é·ç§» ${processed} / ${bookings.length} ç­† (${Math.round(progressPercent)}%)`;
          
          // æ›´æ–°ç‹€æ…‹è¨Šæ¯
          status.className = 'status info';
          status.innerHTML = `
            <strong>ğŸ”„ é·ç§»é€²è¡Œä¸­...</strong><br>
            å·²è™•ç†: ${processed} / ${bookings.length} ç­†<br>
            æˆåŠŸ: ${successCount} ç­† | å¤±æ•—: ${errorCount} ç­†
          `;
          
          // å¼·åˆ¶æ›´æ–°é¡¯ç¤ºï¼ˆæ¯æ‰¹æ›´æ–°ä¸€æ¬¡ï¼‰
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        // 3. é¡¯ç¤ºçµæœ
        progress.className = 'progress';
        migrateBtn.disabled = false;
        btnText.textContent = 'é–‹å§‹é·ç§»';
        
        // é©—è­‰è³‡æ–™æ˜¯å¦çœŸçš„å¯«å…¥
        progressFill.style.width = '95%';
        progressText.textContent = 'æ­£åœ¨é©—è­‰è³‡æ–™å¯«å…¥...';
        status.className = 'status info';
        status.innerHTML = '<strong>ğŸ” æ­£åœ¨é©—è­‰è³‡æ–™å¯«å…¥...</strong>';
        
        console.log('é©—è­‰è³‡æ–™å¯«å…¥...');
        const { data: verifyData, error: verifyError, count } = await supabaseClientInstance
          .from('foodcarcalss')
          .select('id', { count: 'exact' })
          .limit(100);
        
        if (verifyError) {
          console.error('é©—è­‰æŸ¥è©¢å¤±æ•—:', verifyError);
        } else {
          const totalCount = count || (verifyData ? verifyData.length : 0);
          console.log(`Supabase ä¸­ç›®å‰æœ‰ ${totalCount} ç­†è³‡æ–™`);
        }
        
        progressFill.style.width = '100%';
        progressText.textContent = 'é·ç§»å®Œæˆï¼';
        
        if (errorCount === 0 && successCount > 0) {
          status.className = 'status success';
          status.innerHTML = `
            <strong>âœ… é·ç§»æˆåŠŸï¼</strong><br>
            æˆåŠŸé·ç§» ${successCount} ç­†è³‡æ–™åˆ° Supabase<br>
            <small>è«‹åœ¨ Supabase Dashboard ä¸­ç¢ºèªè³‡æ–™</small>
          `;
        } else if (successCount > 0) {
          status.className = 'status error';
          status.innerHTML = `
            <strong>âš ï¸ éƒ¨åˆ†é·ç§»å¤±æ•—</strong><br>
            æˆåŠŸ: ${successCount} ç­†<br>
            å¤±æ•—: ${errorCount} ç­†<br>
            <small>éŒ¯èª¤è©³æƒ…è«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å° (F12)</small>
          `;
        } else {
          status.className = 'status error';
          status.innerHTML = `
            <strong>âŒ é·ç§»å®Œå…¨å¤±æ•—</strong><br>
            æ‰€æœ‰ ${errorCount} ç­†è³‡æ–™éƒ½ç„¡æ³•æ’å…¥<br>
            <small>è«‹æª¢æŸ¥ï¼š<br>
            1. Supabase RLS æ”¿ç­–æ˜¯å¦æ­£ç¢ºè¨­å®š<br>
            2. è³‡æ–™è¡¨åç¨±æ˜¯å¦ç‚º 'foodcarcalss'<br>
            3. ç€è¦½å™¨æ§åˆ¶å° (F12) çš„éŒ¯èª¤è¨Šæ¯</small>
          `;
        }
        
        // åœ¨æ§åˆ¶å°é¡¯ç¤ºæ‰€æœ‰éŒ¯èª¤
        if (errors.length > 0) {
          console.error('æ‰€æœ‰éŒ¯èª¤åˆ—è¡¨:', errors);
        }
        
      } catch (error) {
        console.error('é·ç§»å¤±æ•—:', error);
        progress.className = 'progress';
        migrateBtn.disabled = false;
        btnText.textContent = 'é–‹å§‹é·ç§»';
        status.className = 'status error';
        status.innerHTML = `<strong>âŒ é·ç§»å¤±æ•—</strong><br>${error.message}`;
      }
    }
  </script>
</body>
</html>
